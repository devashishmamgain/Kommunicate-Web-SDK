!function(e){"undefined"==typeof KMCommonUtils?e.KMCommonUtils={ajax:function(e){var t,a=function(){for(var e=1;e<arguments.length;e++)for(var t in arguments[e])arguments[e].hasOwnProperty(t)&&(arguments[0][t]=arguments[e][t]);return arguments[0]}({},{},e),s=new XMLHttpRequest,o=!0;(void 0!==a.async||e.async)&&(o=a.async),"GET"===(e=a.type.toUpperCase())&&void 0!==a.data&&(a.url=a.url+"?"+a.data),s.open(e,a.url,o),"POST"!==e&&"GET"!==e||(o=void 0===a.contentType?"application/x-www-form-urlencoded; charset=UTF-8":a.contentType,s.setRequestHeader("Content-Type",o)),void 0===a.data?s.send():s.send(a.data),s.onreadystatechange=function(){if(s.readyState===XMLHttpRequest.DONE)if(200===s.status){var e=s.getResponseHeader("Content-Type");void 0!==e&&"null"!==e&&null!==e||(e=""),t=-1!=e.toLowerCase().indexOf("text/html")?s.responseXML:-1!=e.toLowerCase().indexOf("application/json")?JSON.parse(s.responseText):s.responseText,a.success(t)}else a.error(t)}}}:console.log("KMCommonUtils already defined.")}(window),function(e){"undefined"==typeof Helpdocs?e.Helpdocs={getArticles:function(e){var t="https://api.helpdocs.io/v1/article?key="+e.data.helpdocsAccessKey;e.data.query&&(t="https://api.helpdocs.io/v1/search?key="+e.data.helpdocsAccessKey+"&query="+e.data.query);var a={};KMCommonUtils.ajax({url:t,async:void 0===e.async||e.async,type:"get",success:function(t){a.status="success",a.data=t,e.success&&e.success(a)},error:function(t,s,o){a.status="error",e.error&&e.error(a)}})},getArticle:function(e){var t={};KMCommonUtils.ajax({url:"https://api.helpdocs.io/v1/article/"+e.data.articleId+"?key="+e.data.helpdocsAccessKey,async:void 0===e.async||e.async,type:"get",success:function(a){t.status="success",t.data=a,e.success&&e.success(t)},error:function(a,s,o){t.status="error",e.error&&e.error(t)}})}}:console.log("Helpdocs already defined.")}(window),function(e){var t,a;"undefined"==typeof KommunicateKB?e.KommunicateKB=(a="https://api.kommunicate.io",(t={}).init=function(e){a=e},t.getArticles=function(e){try{var a=[];t.getFaqs({data:e.data,success:function(t){for(var s=0;s<t.data.length;s++){var o=t.data[s];a.push({articleId:o.id,title:o.name,description:o.content,status:o.status,body:o.content,source:"KOMMUNICATE"})}e.data.helpdocsAccessKey?Helpdocs.getArticles({data:e.data,success:function(t){t=t.data;for(var s=0;s<t.articles.length;s++){var o=t.articles[s];!0===o.is_published&&a.push({articleId:o.article_id,title:o.title,description:o.description,body:o.description,url:o.url,source:"HELPDOCS"})}e.success&&((t={status:"success"}).data=a,e.success(t))},error:function(t){a.length&&e.success?((t={status:"success"}).data=a,e.success(t)):e.error&&e.error(t)}}):e.success&&((t={status:"success"}).data=a,e.success(t))},error:function(t){"function"==typeof e.error&&e.err(t)}})}catch(t){e.error(t)}},t.getArticle=function(e){"HELPDOCS"==e.data.source?Helpdocs.getArticle({data:e.data,success:function(t){if(t={articleId:(t=t.data.article).article_id,title:t.title,description:t.description,body:t.body,url:t.url,source:"HELPDOCS"},e.success){var a={status:"success"};a.data=t,e.success(a)}},error:function(t){e.error(t)}}):t.getFaq({data:e.data,success:function(t){if(t={articleId:(t=t.data.data[0]).id,title:t.name,description:t.content,body:t.content,status:t.status,source:"KOMMUNICATE"},e.success){var a={status:"success"};a.data=t,e.success(a)}},error:function(t){e.error(t)}})},t.getFaqs=function(e){var t=a+"/kb/search?appId=:appId".replace(":appId",e.data.appId);e.data.query&&(t=t+"&query="+e.data.query);var s={};KMCommonUtils.ajax({url:t,async:void 0===e.async||e.async,type:"get",success:function(t){s.status="success",s.data=t.data,e.success&&e.success(s)},error:function(t,a,o){s.status="error",e.error&&e.error(s)}})},t.getFaq=function(e){var t={},s=a+"/kb/search?appId=:appId".replace(":appId",e.data.appId);e.data&&e.data.articleId&&(s+="&articleId="+e.data.articleId),KMCommonUtils.ajax({url:s,async:void 0===e.async||e.async,type:"get",success:function(a){t.status="success",t.data=a,e.success&&e.success(t)},error:function(a,s,o){t.status="error",e.error&&e.error(t)}})},t):console.log("KommunicateKB already defined.")}(window),Kommunicate.client={getGroupDetailByType:function(e,t){var a="type="+e.type+"&startIndex="+e.startIndex+"&limit="+e.limit;$applozic.ajax({url:MCK_BASE_URL+"/rest/ws/group/bytype",type:"get",data:a,contentType:"application/json",success:function(e){t(null,e)},error:function(e){t(e)}})},createConversation:function(e,t){$applozic.fn.applozic("createGroup",{groupName:e.groupName,type:e.type,admin:e.agentId,users:e.users,clientGroupId:e.clientGroupId,metadata:{CREATE_GROUP_MESSAGE:"",REMOVE_MEMBER_MESSAGE:"",ADD_MEMBER_MESSAGE:"",JOIN_MEMBER_MESSAGE:"",GROUP_NAME_CHANGE_MESSAGE:"",GROUP_ICON_CHANGE_MESSAGE:"",GROUP_LEFT_MESSAGE:"",CONVERSATION_STATUS:0,DELETED_GROUP_MESSAGE:"",GROUP_USER_ROLE_UPDATED_MESSAGE:"",GROUP_META_DATA_UPDATED_MESSAGE:"",CONVERSATION_ASSIGNEE:e.assignee||e.agentId,KM_CONVERSATION_TITLE:e.groupName,HIDE:"true"},callback:function(e){console.log("response",e),"success"===e.status&&e.data.clientGroupId&&("function"==typeof t&&t(e.data.value),KommunicateUI.hideFaq())}})},getThirdPartySettings:function(e,t){$applozic.ajax({url:Kommunicate.getBaseUrl()+"/integration/settings/"+e.appId+"?type="+e.type,type:"get",contentType:"application/json",success:function(e){t(null,e)},error:function(e){t(e)}})}},$applozic.extend(!0,Kommunicate,{getBaseUrl:function(){return KM_PLUGIN_SETTINGS.kommunicateApiUrl},setDefaultAgent:function(e){throw new Error("not implemented")},getConversationOfParticipent:function(e,t){if("function"!=typeof t)throw new Error("invalid callback! expected: Kommunicate.startNewConversation(options, callback) ");$applozic.ajax({url:Kommunicate.getBaseUrl()+"/conversations/participent/"+e.userId,type:"get",success:function(e){t(null,e)},error:function(e){t(e)}})},startConversation:function(e,t){(e="object"==typeof e?e:{}).agentId||(e.agentId=KommunicateUtils.getDataFromKmSession("appOptions").agentId);var a=[{userId:e.agentId,groupRole:1},{userId:"bot",groupRole:2}];if(e.botIds)for(var s=0;s<e.botIds.length;s++)a.push({userId:e.botIds[s],groupRole:2});var o=e.conversationTitle||e.groupName||kommunicate._globals.conversationTitle||kommunicate._globals.groupName||kommunicate._globals.agentId,i=e.assignee||e.agentId,n={groupName:o,type:10,agentId:e.agentId,assignee:i,users:a,clientGroupId:e.clientGroupId};Kommunicate.client.createConversation(n,t)},openConversationList:function(){window.$applozic.fn.applozic("loadTab",""),KommunicateUI.showChat(),KommunicateUI.hideFaq()},openConversation:function(e){window.$applozic.fn.applozic("loadGroupTab",e),KommunicateUI.hideFaq()},openDirectConversation:function(e){window.$applozic.fn.applozic("loadTab",e),KommunicateUI.showChat(),KommunicateUI.hideFaq()},loadConversation:function(e,t){var a=(e.agentIds||[]).sort(function(e,t){return e.toLowerCase()<t.toLowerCase()?-1:e.toLowerCase()>t.toLowerCase()?1:0});console.log("agent list ",a);var s=e.botIds||[];if(a.length<1){var o={code:"INVALID_PARAMETERS",message:"required parameter agentIds is missing."};return"function"==typeof t?t(o):console.log("required parameter agentIds is missing.")}var i=kommunicate._globals.userId||KommunicateUtils.getCookie("kommunicate-id"),n=a.join("_"),r=s.join("_"),c=encodeURIComponent(r?[n,i,r].join("_"):[n,i].join("_"));if(c.length>256){o={code:"MEMBER_LIMIT_EXCEEDS",message:"try adding fewer members"};return"function"==typeof t?t(o):console.log("member limit exceeds. try adding fewer members")}mckGroupService.getGroupFeed({clientGroupId:c,apzCallback:function(e){if("error"==e.status&&"AL-G-01"==e.code){var o=a.map(function(e){return{userId:e,groupRole:1}});o.push({userId:"bot",groupRole:2}),o.push(s.map(function(e){return{userId:e,groupRole:2}}));var i={groupName:kommunicate._globals.conversationTitle||kommunicate._globals.groupName||kommunicate._globals.agentId,type:10,agentId:o[0].userId,users:o,clientGroupId:decodeURIComponent(c)};Kommunicate.client.createConversation(i,function(e){if(t)return t(null,e)})}else if("success"==e.status){var n=e.data.id;return $applozic.fn.applozic("loadGroupTab",n),t(null,e)}}})},createGroupName:function(e){return e.sort().join().replace(/,/g,"_").substring(0,250)},openLastConversation:function(e){var t=e,a=[],s=[];if(s.push(e.agentId),s.push(kommunicate._globals.userId),a.push({userId:e.agentId,groupRole:1}),a.push({userId:"bot",groupRole:2}),e.botIds){console.log(e.botIds);for(var o=0;o<e.botIds.length;o++)a.push({userId:e.botIds[o],groupRole:2}),s.push(e.botIds[o])}var i=Kommunicate.createGroupName(s),n={};n.groupName=i,n.callback=function(e){e.data.groups.length>0?(console.log("already have a group"),Kommunicate.openConversation(e.data.groups[0].id)):(console.log("new user"),Kommunicate.startConversation(t,function(e){}))},window.$applozic.fn.applozic("getGroupListByFilter",n)},createNewConversation:function(e,t){if("function"!=typeof t)throw new Error("invalid callback! expected: Kommunicate.startNewConversation(options, callback) ");let a={groupId:e.groupId,participantUserId:e.participantUserId,createdBy:e.participantUserId,defaultAgentId:e.defaultAgentId,applicationId:e.applicationId};$applozic.ajax({url:Kommunicate.getBaseUrl()+"/conversations",type:"post",data:JSON.stringify(a),contentType:"application/json",success:function(e){console.log("conversation started successfully"),t(null,e)},error:function(e){console.log("err while starting Conversation"),t(e)}})},logout:function(e,t){void 0!==window.$kmApplozic&&void 0!==window.$kmApplozic.fn&&void 0!==window.$kmApplozic.fn.applozic&&window.$kmApplozic.fn.applozic("getLoggedInUser")&&window.$kmApplozic.fn.applozic("logout"),void 0!==window.$applozic&&void 0!==window.$applozic.fn&&void 0!==window.$applozic.fn.applozic&&window.$applozic.fn.applozic("getLoggedInUser")&&window.$applozic.fn.applozic("logout"),sessionStorage.clear(),localStorage.clear()},launchConversation:function(){window.$applozic.fn.applozic("mckLaunchSideboxChat")},triggerEvent:function(e,t){$applozic.ajax({url:Kommunicate.getBaseUrl()+"/applications/events?type="+e,type:"post",data:JSON.stringify({conversationId:t.groupId,applicationId:t.applicationId}),contentType:"application/json",success:function(e){console.log("conversation triggering event")},error:function(e){console.log("err while starting Conversation")}})},updateUser:function(e){var t={data:e};window.$applozic.fn.applozic("updateUser",t)},getAwayMessage:function(e,t){$applozic.ajax({url:Kommunicate.getBaseUrl()+"/applications/"+e.applicationId+"/awaymessage?conversationId="+e.conversationId,type:"get",contentType:"application/json",success:function(e){"function"==typeof t&&t(null,e)},error:function(e){console.log("err while fetching away message"),"function"==typeof t&&t(e)}})},updateUserIdentity:function(e){window.$applozic.fn.applozic("updateUserIdentity",{newUserId:e,callback:function(t){KommunicateUtils.setCookie("kommunicate-id",e),"success"==t&&window.$applozic.fn.applozic("reInitialize",{userId:e})}})},isRichTextMessage:function(e){return e&&300==e.contentType},getContainerTypeForRichMessage:function(e){var t=e.metadata;if(t.templateId)switch(t.templateId){case"2":case"4":return"km-slick-container";case"6":return"km-border-less-container";default:return"km-fixed-container"}else if(e.contentType==MESSAGE_CONTENT_TYPE.TEXT_HTML&&e.source==MESSAGE_SOURCE.MAIL_INTERCEPTOR)return"km-fixed-container"},processPaymentRequest:function(e){},sendMessage:function(e){var t=$applozic("#mck-message-cell .mck-message-inner"),a=$applozic("#mck-msg-to");!0===t.data("isgroup")?e.groupId=a.val():e.to=a.val();var s=Kommunicate.getSettings("KM_CHAT_CONTEXT"),o=e.metadata||{};s&&(o={KM_CHAT_CONTEXT:s}),e.metadata=o,$applozic.fn.applozic("sendGroupMessage",e)},getRichTextMessageTemplate:function(e){var t=e.metadata;if(!t.templateId)return e.contentType==MESSAGE_CONTENT_TYPE.TEXT_HTML&&e.source==MESSAGE_SOURCE.MAIL_INTERCEPTOR?Kommunicate.markup.getHtmlMessageMarkups(e):"";switch(t.templateId){case"1":return Kommunicate.markup.getHotelRoomPaxInfoTemplate();case"2":return Kommunicate.markup.getHotelCardContainerTemplate(JSON.parse(t.hotelList||"[]"),t.sessionId);case"3":return Kommunicate.markup.buttonContainerTemplate(t);case"5":return Kommunicate.markup.getPassangerDetail(t);case"4":return Kommunicate.markup.getRoomDetailsContainerTemplate(JSON.parse(t.hotelRoomDetail||"[]"),t.sessionId);case"6":return Kommunicate.markup.quickRepliesContainerTemplate(t);case"7":return Kommunicate.markup.getListContainerMarkup(t);case"8":return Kommunicate.markup.getDialogboxContainer(t);case"9":return Kommunicate.markup.getImageContainer(t);default:return""}},updateSettings:function(e){var t=KommunicateUtils.getDataFromKmSession("settings");for(var a in t=t?JSON.parse(t):{},e)t[a]=e[a];KommunicateUtils.storeDataIntoKmSession("settings",JSON.stringify(t))},getSettings:function(e){var t=KommunicateUtils.getDataFromKmSession("settings");return t=t?JSON.parse(t):null,e&&t?t[e]:t||""}}),Kommunicate.markup={getSingleRoomPaxInfo:function(e){return'<div class = "km-single-pax-info">\n    <div class="km-room-title-text">ROOM '+(e=e||"1")+'</div>\n    <div class="km-room-selector">\n        <div>Guest :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>\n        <div id= "">\n            <input class ="km-decrement-guest-count" type="button" value="-" data-type="guest">\n            <input type="number" min="1" max="5" value="1" class="km-room-number-field" maxlength="1" disabled>\n            <input class ="km-increment-guest-count" type="button" value="+" data-type="guest">\n        </div>\n    </div>\n    <div class="km-person-selector n-vis">\n        <div class="km-children-text-lable">Children :<span>(1-12 yrs)</span></div>\n        <div>\n            <input class ="km-decrement-guest-count" type="button" value="-" data-type="children">\n            <input type="number" min="0" max="2" value="0" class="km-person-number-field" maxlength="1" disabled >\n            <input class ="km-increment-guest-count" type="button" value="+" data-type="children">\n        </div> \n    </div>\n</div>'},getHotelCardTemplate:function(e,t){var a={star1:"km-star-empty",star2:"km-star-empty",star3:"km-star-empty",star4:"km-star-empty",star5:"km-star-empty"};if(e.StarRating)for(var s=0;s<e.StarRating;s++)a["star"+(s+1)]="km-star-filled";var o=("INR"==e.Price.CurrencyCode?"&#x20B9;":e.Price.CurrencyCode)+" "+Math.ceil(1*e.Price.OfferedPrice);return'\n    <div class="km-single-card-message">\n        <div class="km-card-message-header">\n            <div class="km-card-message-image-continer"><img class ="km-card-message-img" src ='+e.HotelPicture+' />\n                    <div class="km-card-message-image-price-container">'+o+'</div>\n            </div>\n        </div>\n        <div class="km-card-message-body">\n            <h1 class="km-card-message-body-title">'+e.HotelName+'</h1>\n            <div class="km-card-message-body-ratings">\n                <span>\n                    <svg xmlns="http://www.w3.org/2000/svg"  height="24" viewBox="0 0 24 24" width="24" class="'+a.star1+'">\n                        <path d="M0 0h24v24H0z" fill="none"/>\n                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>\n                    </svg>\n                </span>\n                <span>\n                    <svg xmlns="http://www.w3.org/2000/svg"  height="24" viewBox="0 0 24 24" width="24" class="'+a.star2+'">\n                        <path d="M0 0h24v24H0z" fill="none"/>\n                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>\n                    </svg>\n                </span>\n                <span>\n                    <svg xmlns="http://www.w3.org/2000/svg"  height="24" viewBox="0 0 24 24" width="24" class="'+a.star3+'">\n                        <path d="M0 0h24v24H0z" fill="none"/>\n                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>\n                    </svg>\n                </span>\n                <span>\n                    <svg xmlns="http://www.w3.org/2000/svg"  height="24" viewBox="0 0 24 24" width="24" class="'+a.star4+'">\n                        <path d="M0 0h24v24H0z" fill="none"/>\n                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>\n                    </svg>\n                </span>\n                <span>\n                    <svg xmlns="http://www.w3.org/2000/svg"  height="24" viewBox="0 0 24 24" width="24" class="'+a.star5+'">\n                        <path d="M0 0h24v24H0z" fill="none"/>\n                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>\n                    </svg>\n                </span>\n            </div>\n            <div class="km-card-message-body-address">\n                <span class="km-card-message-body-address-icon">\n                    <svg xmlns="http://www.w3.org/2000/svg"  height="24" viewBox="0 0 24 24" width="24">\n                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>\n                        <path d="M0 0h24v24H0z" fill="none"/>\n                    </svg>\n                </span>'+e.HotelAddress+'\n            </div>\n        </div>\n        <div class="km-card-message-footer">\n            <button class="km-card-message-footer-button" data-resultindex= '+e.ResultIndex+" data-sessionid= "+t+" data-name= "+e.HotelName.replace(" ","_")+" > Get Room Details</button>\n        </div>\n    </div>"},getRoomDetailTemplate:function(e,t){let a="undefined"==e.NoOfGuest?1:e.NoOfGuest,s=e.DayRates.Amount?e.DayRates.Amount:e.Price.RoomPrice;return'<div class="km-single-card-message">\n                <div class="message received km-blocked-room">\n                    <div class="km-blocked-room-details">\n                    <div class="km-card-message-image-continer"><img class ="km-card-message-img" src='+e.HotelPicture+" alt="+e.HotelName+'></div>\n                        <div class="km-blocked-room-text-container">\n                            <div class="km-blocked-room-room-type">\n                                <span>Room Type: </span> <span> '+e.RoomTypeName+'</span>\n                            </div>\n                            <div class="km-blocked-room-guests">\n                                <span>Guests:</span><span>'+a+' </span>\n                            </div>\n                            <div class="km-blocked-room-price">\n                                <p>Price:<br><span>(Per Room Per Night)</span></p>\n\n                                <span>'+("INR"==e.Price.CurrencyCode?"&#x20B9;":e.Price.CurrencyCode)+" "+Math.ceil(s)+'</span>\n\n                            </div>\n                            <div class="km-blocked-room-sub-total">\n                                <p>Total:<br><span>(1 Room for '+e.NoOfNights+" Nights)</span></p>\n                                <span> "+("INR"==e.Price.CurrencyCode?"&#x20B9;":e.Price.CurrencyCode)+" "+Math.ceil(e.Price.RoomPrice)+' </span>\n                            </div>\n                        </div>\n                        <div class="km-blocked-room-button-container">\n                            <button class="km-block-room-button" data-sessionId= '+t+" data-roomIndex="+e.RoomIndex+" data-NoOfRooms="+e.NoOfRooms+" data-NoOfNights="+e.NoOfNights+" data-HotelName= "+e.HotelName.replace(" ","_")+" data-HotelResultIndex= "+e.HotelResultIndex+" >Book</button>\n                        </div>\n                    </div>\n                </div>\n            </div>"},getButtonTemplate:function(e,t){return"link"==e.type?'<button data-eventhandlerid="'+e.handlerId+'" class="km-cta-button km-add-more-rooms km-undecorated-link '+t+'"><a href ="'+e.url+'" target="_blank">'+e.name+"</a></button>":'<button data-eventhandlerid="'+e.handlerId+'" class="km-cta-button km-add-more-rooms '+t+'">'+e.name+"</button>"},getQuickRepliesTemplate:function(e,t){return'<button title="'+e.message+'" class="km-cta-button km-add-more-rooms km-quick-replies '+t+'">'+e.title+"</button>"},getPassangerDetail:function(e){return e.sessionId||console.log("sessionId not present in message.."),'  <div class="km-guest-details-container km-rich-text-default-container">\n                <div class="km-guest-detail-form">\n                    <div class= "km-select-title">    \n                        <select name="title" class="km-title-select">\n                            <option value="0" disabled selected>Title *</option>\n                            <option value="Mr.">Mr.</option>\n                            <option value="Ms.">Ms.</option>\n                            <option value="Mrs.">Mrs.</option>\n                        </select>\n                    </div>\n                    <input type="number" name="age"  class="km-input km-age-input n-vis" placeholder="Age *" min="0" max="150">\n                    <input type="text" name="first-name"  class="km-input first-name-input km-pxinfo-btn-left" placeholder="First Name *"  required>\n                    <input type="text" name="middle-name"  class="km-input middle-name-input n-vis" placeholder="Middle Name (optional) ">\n                    <input type="text" name="last-name"  class="km-input last-name-input km-pxinfo-btn-left" placeholder="Last Name *"  required>\n                    <input type="email" name="email"  class="km-input e-mail-input km-pxinfo-btn-left" placeholder="Email Id *" required>\n                    <input type="text" name="contact-no"  class="km-input number-input km-pxinfo-btn-left" placeholder="Contact Number *" required >\n                    <div class= "km-mandatory-field-error n-vis"><span> All fields are mandatory.</span></div>\n                </div>\n                <div class="km-guest-button-container">\n                    <button class="km-add-more-rooms km-submit-person-detail" data-sessionid= '+e.sessionId+">Submit</button>\n                </div>\n            </div>\n            "},getListMarkup:function(){return'<div class="km-message km-received km-chat-faq-list" style="">\n     <div class="km-faq-list--container"  >\n             <div class="km-faq-list--header">\n                     {{{headerImgSrc}}}\n                     <div class="km-faq-list--header_text-container">\n                                     {{{headerText}}}\n                         </div>\n         </div>\n         <div class="km-faq-list--body">\n             <div class="km-faq-list--body_list-container">\n                 <ul class="km-faq-list--body_list {{elementClass}}">\n                     {{#elements}}\n                     <li class ={{hadlerClass}} data-type="{{dataType}}" data-reply = "{{dataReply}}" data-articleid= "{{dataArticleId}}" data-source="{{source}}"> <a href={{href}} target="_blank" class="km-undecorated-link" >\n                             <div class="km-faq-list--body_img">\n                                     {{{imgSrc}}}\n                             </div>\n                         <div class="km-faq-list--body_que-ans">\n                                 <p class="km-faq-list--body_que">\n                                     {{title}}\n                                 </p>\n                                 <p class="km-faq-list--body_ans">\n                                     {{description}}\n                                 </p>\n                             </div>\n                         </a>\n                     </li>\n                     {{/elements}}\n                 \n                 </ul>\n             </div>\n         </div>\n         <div class="km-faq-list--footer">\n                 <div class="km-faq-list--footer_button-container">\n                         {{#buttons}}\n                         <button class="km-cta-button km-add-more-rooms {{hadlerClass}}" data-type ="{{dataType}}" data-reply="{{dataReply}}"><a class ="km-undecorated-link" href ="{{href}}" target="_blank">{{name}}</a></button>\n                         {{/buttons}}\n                     \n             </div>\n         </div>\n     </div>'},getDialogboxTemplate:function(){return'<div class="km-message km-received km-faq-answer">\n     <div class="km-faq-answer--container">\n         <div class="km-faq-answer--body">\n             <div class="km-faq-answer--body_container">\n                 <p class="km-faq-answer--body_que">{{title}}</p>\n                 <p class="km-faq-answer--body_ans"> {{{description}}} </p>\n             </div>\n         </div>\n         <div class="km-faq-answer--footer">\n             <div class="km-faq-answer--footer_button-text-container">\n                 <p>{{buttonLabel}}</p>\n                 {{#buttons}}\n                 <button class="km-faq-dialog-button km-quick-replies km-cta-button km-add-more-rooms" data-reply="{{name}}">{{name}}</button>\n                {{/buttons}}\n             </div>\n         </div>\n     </div>\n </div>'},getImageTemplate:function(){return'<div>\n    {{#payload}}\n    <div class="km-image-template">\n       <img class="km-template-img" src="{{url}}"></img>\n       <div class="km-template-image-caption-wrapper">\n           <p class="km-template-img-caption">{{caption}}</p>\n       </div>\n   </div>\n   {{/payload}}\n   </div>'}},Kommunicate.markup.buttonContainerTemplate=function(e){for(var t='<div class="km-cta-multi-button-container">',a=JSON.parse(e.payload),s=a?JSON.parse(e.formData||"{}"):"",o=1==a.length?"km-cta-button-1":2==a.length?"km-cta-button-2":"km-cta-button-many",i=0;i<a.length;i++)t+=Kommunicate.markup.getButtonTemplate(a[i],o);if(s){for(var n in t+="<form method ='post'  target='_blank' class= km-btn-hidden-form action ="+e.formAction+">",s)s.hasOwnProperty(n)&&(t+='<input type="hidden" name ="'+n+'" value="'+s[n]+'" />');t+="</form>"}return t+="</div>"},Kommunicate.markup.quickRepliesContainerTemplate=function(e){for(var t='<div class="km-cta-multi-button-container">',a=JSON.parse(e.payload),s=1==a.length?"km-cta-button-1":2==a.length?"km-cta-button-2":"km-cta-button-many",o=0;o<a.length;o++)t+=Kommunicate.markup.getQuickRepliesTemplate(a[o],s);return t+="</div>"},Kommunicate.markup.getHotelRoomPaxInfoTemplate=function(e){return'<div class = "km-rich-text-default-container">\n            <div class="km-room-person-selector-container">'+Kommunicate.markup.getSingleRoomPaxInfo(e)+'</div>\n            <hr>\n            <div class="km-add-room-button-container">\n                <button  class="km-add-more-rooms km-btn-add-more-rooms" data-roomcount=1>ADD ROOM</button>\n                <button class=" km-add-more-rooms km-done-button">DONE</button>\n            </div>\n        </div>'},Kommunicate.markup.getHotelCardContainerTemplate=function(e,t){for(var a="",s=0;s<e.length;s++)a+=Kommunicate.markup.getHotelCardTemplate(e[s],t);return'<div class="km-card-message-container  km-div-slider">'+a+"</div>"},Kommunicate.markup.getRoomDetailsContainerTemplate=function(e,t){let a=e.HotelRoomsDetails;for(var s="",o=0;o<a.length;o++)s+=Kommunicate.markup.getRoomDetailTemplate(a[o],t);return'<div class="km-card-room-detail-container  km-div-slider">'+s+"</div>"},Kommunicate.markup.getListContainerMarkup=function(e){if(e&&e.payload){var t=JSON.parse(e.payload);return t.headerImgSrc&&(t.headerImgSrc='<div class="km-faq-list--header_text-img"><img src= "'+t.headerImgSrc+'"  alt = "image" /></div>'),t.headerText&&(t.headerText='<p class="km-faq-list--header_text">'+t.headerText+"</p>"),t.elements&&t.elements.length?(t.elementClass="vis",t.elements=t.elements.map(function(e){return e.imgSrc&&(e.imgSrc='<img src ="'+e.imgSrc+'" />'),e.action&&"link"==e.action.type?e.href=e.action.url:(e.href="javascript:void(0)",e.hadlerClass="km-list-item-handler"),e.action&&(e.dataType=e.action.type||"",e.dataReply=e.action.text||e.title||""),e.dataArticleId=e.articleId||"",e.dataSource=e.source||"",e})):t.elementClass="n-vis",t.buttons&&t.buttons.length&&(t.buttons=t.buttons.map(function(e){return e.action&&"quick_reply"!=e.action.type&&"submit"!=e.action.type?e.href=e.action.url:(e.href="javascript:void(0)",e.hadlerClass="km-list-button-item-handler"),e.dataType=e.action?e.action.type:"",e.dataReply=e.action?e.action.text:e.name||"",e})),Mustache.to_html(Kommunicate.markup.getListMarkup(),t)}return""},Kommunicate.markup.getDialogboxContainer=function(e){if(e&&e.payload){var t=JSON.parse(e.payload);return Mustache.to_html(Kommunicate.markup.getDialogboxTemplate(),t)}return""},Kommunicate.markup.getImageContainer=function(e){if(e&&e.payload){let t="string"==typeof e.payload?JSON.parse(e.payload):{};return e.payload=t,Mustache.to_html(Kommunicate.markup.getImageTemplate(),e)}return""},Kommunicate.markup.getHtmlMessageMarkups=function(e){return e&&e.source==MESSAGE_SOURCE.MAIL_INTERCEPTOR?"<pre class='km-mail-fixed-view'>"+e.message.replace(/\n/g," ")+"</pre>":""};var MCK_GROUP_MAP=[],MCK_CLIENT_GROUP_MAP=[],MCK_EVENT_HISTORY=[],count=0,isFirstLaunch=!0;const MESSAGE_SOURCE={DEVICE:0,WEB:1,ANDROID:2,IOS:3,PLATFORM:4,DESKTOP_BROWSER:5,MOBILE_BROWSER:6,MAIL_INTERCEPTOR:7},MESSAGE_CONTENT_TYPE={DEFAULT:0,ATTACHMENT:1,LOCATION:2,TEXT_HTML:3,PRICE:4,IMAGELINK:5,HYPERLINK:6,CONTACT:7,AUDIO:8,VIDEO:9,NOTIFY_MESSAGE:10,HIDDEN_MESSAGE:11,RECEIVER_ONLY:12,BLOCK_NOTIFY_MESSAGE:13,AUDIO_VIDEO_CALL:102,MISSED_CALL:103};function RingToneService(){this.loadRingTone=function(e,t){return new Howl({src:[e],loop:t.loop})}}!function(t,a,s){"use strict";a.applozic||(a.applozic=a.applozic?a.applozic:{},t.extend(!0,a.applozic,{applozic:{PRODUCT_ID:"applozic-chat"}}));var o={baseUrl:KM_PLUGIN_SETTINGS.applozicBaseUrl||"https://chat.kommunicate.io",fileBaseUrl:"https://applozic.appspot.com",customFileUrl:"https://googleupload.applozic.com",notificationIconLink:"",notificationSoundLink:"",mapStaticAPIkey:"AIzaSyCWRScTDtbt8tlXDr6hiceCsU83aS2UuZw",launcher:"applozic-launcher",emojilibrary:!1,userId:null,appId:null,userName:null,contactNumber:null,email:null,supportId:null,mode:"standard",visitor:!1,olStatus:!1,unreadCountOnchatLauncher:!0,groupUserCount:!1,desktopNotification:!0,locShare:!1,maxAttachmentSize:25,notification:!0,launchOnUnreadMessage:!1,loadOwnContacts:!1,maxGroupSize:100,authenticationTypeId:0,groupName:"Conversations",agentId:"",agentName:"",labels:{"conversations.title":"Conversations","start.new":"Start New Conversation","search.contacts":"Contacts","search.groups":"Groups","empty.groups":"No groups yet!","empty.contacts":"No contacts yet!","empty.messages":"No messages yet!","no.more.messages":"No more messages!","empty.conversations":"No conversations yet!","no.more.conversations":"No more conversations!","search.placeholder":"Search...","location.placeholder":"Enter a location","create.group.title":"Create Group","members.title":"Members","add.members.title":"Add Member","remove.member":"Remove Member","change.role":"Change Role","group.info.update":"Update","group.info.updating":"Updating...","add.group.icon":"Add Group Icon","group.deleted":"Group has been deleted","change.group.icon":"Change Group Icon","group.title":"Group Title","group.type":"Group Type","group.create.submit":"Creating Group...",blocked:"You have blocked this user","group.chat.disabled":"You are no longer part of this group!","block.user.alert":"Are you sure you want to block this user?","unblock.user.alert":"Are you sure you want to unblock this user?","exit.group.alert":"Are you sure you want to exit this group?","remove.member.alert":"Are you sure you want to remove this member?","clear.messages.alert":"Are you sure you want to delete all the conversation?",typing:"typing...","is.typing":"is typing...",online:"Online","clear.messages":"Clear Messages",delete:"Delete",reply:"Reply",forward:"Forward",copy:"Copy","block.user":"Block User","unblock.user":"Unblock User","group.info.title":"Group Info","exit.group":"Exit Group","location.share.title":"Location Sharing","my.location":"My Location",send:"Send","send.message":"Send Message",smiley:"Smiley",close:"Close",edit:"Edit",save:"Save","file.attachment":"Files & Photos","file.attach.title":"Attach File","last.seen":"Last seen","last.seen.on":"Last seen on",hour:" hour",min:" min",yesterday:"yesterday",hours:" hours",mins:" mins","user.delete":"This user has been deleted",ago:"ago",admin:"Admin",user:"User",moderator:"Moderator",member:"Member",public:"Public",private:"Private",open:"Open",you:"You","group.metadata":{CREATE_GROUP_MESSAGE:":adminName created group :groupName",REMOVE_MEMBER_MESSAGE:":adminName removed :userName",ADD_MEMBER_MESSAGE:":adminName added :userName",JOIN_MEMBER_MESSAGE:":userName joined",GROUP_NAME_CHANGE_MESSAGE:"Group name changed to :groupName",GROUP_ICON_CHANGE_MESSAGE:"Group icon changed",GROUP_LEFT_MESSAGE:":userName left",DELETED_GROUP_MESSAGE:":adminName deleted group",GROUP_USER_ROLE_UPDATED_MESSAGE:":userName is :role now",GROUP_META_DATA_UPDATED_MESSAGE:"",ALERT:"",HIDE:""}},openGroupSettings:{deleteChatAccess:0,allowInfoAccessGroupMembers:!0,disableChatForNonGroupMember:!1,defaultChatDisabledMessage:"Chat Disabled!"}},i={messageType:5,type:0};t.fn.applozic=function(n,r,c){var l=t("#mck-sidebox");"object"===t.type(n)&&(KommunicateUtils.storeDataIntoKmSession("appOptions",n),(n=t.extend(!0,{},o,n)).conversationTitle=n.conversationTitle||n.groupName,n.accessToken=n.password||n.accessToken);var d=void 0;if(void 0!==l.data("applozic_instance"))if(d=l.data("applozic_instance"),"string"===t.type(n))switch(n){case"reInitialize":return d.reInit(r);case"loadConvTab":d.loadConvTab(r);break;case"loadTab":d.loadTab(r,c);break;case"uploadFile":d.uploadFile(r);break;case"loadTabView":d.loadTabView(r);break;case"loadChat":d.loadChat(r);break;case"loadContextualTab":return d.loadTabWithTopic(r);case"audioAttach":d.audioAttach(r);break;case"addWelcomeMessage":d.addWelcomeMessage(r);break;case"loadContacts":d.loadContacts(r);break;case"sendMessage":return d.sendMessage(r);case"sendGroupMessage":return d.sendGroupMessage(r);case"createGroup":return d.createGroup(r);case"loadBroadcastTab":case"initBroadcastTab":return r.groupName=r.groupName?r.groupName:"Broadcast",r.type=5,d.initGroupTab(r);case"initGroupTab":return d.initGroupTab(r);case"loadGroupTab":return d.loadGroupTab(r);case"loadGroupTabByClientGroupId":return d.loadGroupTabByClientGroupId(r);case"setOffline":case"setOnline":return d.setOffline(),"success";case"logout":return d.logout(),"success";case"reset":d.reset(r);break;case"getUserDetail":return d.getUserStatus(r),"success";case"getGroupList":return d.getGroupList(r),"success";case"leaveGroup":return d.leaveGroup(r);case"addGroupMember":return d.addGroupMember(r);case"removeGroupMember":return d.removeGroupMember(r);case"updateGroupInfo":return d.updateGroupInfo(r);case"getMessages":d.getMessages(r);break;case"messageList":return d.getMessageList(r);case"getMessageListByTopicId":return d.getMessageListByTopicId(r);case"getTotalUnreadCount":return d.getTotalUnreadCount();case"subscribeToEvents":return d.subscribeToEvents(r);case"getConversation":return d.getConversation(r);case"loadConversationWithAgent":return d.loadConversationWithAgent(r);case"updateUserIdentity":return d.updateUserIdentity(r);case"updateUser":return d.updateUser(r);case"getGroupListByFilter":return d.getGroupListByFilter(r);case"updateMessageMetadata":return d.updateMessageMetadata(r);case"mckLaunchSideboxChat":return d.mckLaunchSideboxChat();case"openChat":return d.openChat(r)}else"object"===t.type(n)&&d.reInit(n);else if("object"===t.type(n))if(n.userId&&n.appId&&""!==t.trim(n.userId)&&""!==t.trim(n.appId))if(void 0!==l.data("applozic_instance"))(d=l.data("applozic_instance")).reInit(n);else{if(void 0!==n.ojq?($=n.ojq,jQuery=n.ojq):($=t,jQuery=t),"function"==typeof n.obsm)$.fn.modal=n.obsm,jQuery.fn.modal=n.obsm;else if("function"==typeof t.fn.modal){var m=t.fn.modal.noConflict();$.fn.modal=m,jQuery.fn.modal=m}else if("function"==typeof $.fn.modal){m=$.fn.modal.noConflict();$.fn.modal=m,jQuery.fn.modal=m}"function"==typeof n.omckm?t.fn.mckModal=n.omckm:"function"==typeof t.fn.mckModal?t.fn.mckModal=t.fn.mckModal.noConflict():"function"==typeof $.fn.mckModal&&(t.fn.mckModal=$.fn.mckModal.noConflict()),"function"==typeof $.fn.linkify?(t.fn.linkify=$.fn.linkify,jQuery.fn.linkify=$.fn.linkify):"function"==typeof t.fn.linkify&&($.fn.linkify=t.fn.linkify,jQuery.fn.linkify=t.fn.linkify),"function"==typeof $.fn.emojiarea?t.fn.emojiarea=$.fn.emojiarea:"function"==typeof t.fn.emojiarea&&($.fn.emojiarea=t.fn.emojiarea,jQuery.fn.emojiarea=t.fn.emojiarea),"function"==typeof $.fn.locationpicker?t.fn.locationpicker=$.fn.locationpicker:"function"==typeof t.fn.locationpicker&&($.fn.locationpicker=t.fn.locationpicker,jQuery.fn.locationpicker=t.fn.locationpicker);var p=new function(n){var r,c,l=this;MCK_GROUP_MAP=[];var d,m,p=[],u=!0,v=[],g=0;MCK_CLIENT_GROUP_MAP=[];var f=!1,k=[],C=[],h=90,b=[],y=[],I=[],M=[],T=!0,E=0,x=n.emojilibrary,S=n.mode;MCK_LABELS=n.labels,MCK_BASE_URL=n.baseUrl;var L,A=n.customFileUrl,_=n.customUploadUrl,w=n.appId,G=[],U=[0,1,2,3],K=[1,2,5,6,10],N=[],O=!1,D=n.launcher,R=n.visitor,z=n.userName,B=n.locShare,P=n.video,F=n.fileBaseUrl,q=n.onInit,H=n.onTopicDetails,j=[0,1,2],V=n.onClose,Y=n.displayText,J=n.password||n.accessToken,W=n.readConversation,Z=n.maxGroupSize,Q=n.onTabClicked,X=n.contactNumber,ee=n.maxAttachmentSize,te=n.appModuleName,ae=n.getTopicDetail,se=n.contactDisplayName,oe=n.validateMessage,ie=n.finalPriceResponse,ne=n.contactDisplayImage,re=n.priceWidget,ce=n.openGroupSettings,le=n.offlineMessageDetail,de=(n.initAutoSuggestions,n.authenticationTypeId),me=n.getConversationDetail,pe=n.notificationIconLink,ue=n.mapStaticAPIkey,ve=n.unreadCountOnchatLauncher,ge=n.chatLauncherHtml,fe=n.fileupload,ke=n.notificationSoundLink?n.notificationSoundLink:Kommunicate.getBaseUrl()+"/plugin/audio/notification_tone.mp3",Ce=R?"guest":t.trim(n.userId),he=B?n.googleApiKey:"NO_ACCESS",be=void 0===n.source?1:n.source,ye="boolean"==typeof n.topicBox&&n.topicBox,Ie="boolean"==typeof n.olStatus&&n.olStatus,Me="boolean"!=typeof n.messageBubbleAvator||n.messageBubbleAvator,Te="boolean"==typeof n.showOfflineMessage&&n.showOfflineMessage,Ee="boolean"==typeof n.hideGroupSubtitle&&n.hideGroupSubtitle,xe=void 0===n.defaultMessageMetaData?{}:n.defaultMessageMetaData,Se="boolean"==typeof n.groupUserCount&&n.groupUserCount,Le="boolean"==typeof n.checkUserBusyWithStatus&&n.checkUserBusyWithStatus,Ae="boolean"==typeof n.resetUserStatus&&n.resetUserStatus,_e="boolean"==typeof n.topicHeader&&n.topicHeader,we=(n.supportId&&n.supportId,"boolean"==typeof n.loadOwnContacts&&n.loadOwnContacts),Ge="boolean"!=typeof n.desktopNotification||n.desktopNotification,Ue="boolean"!=typeof n.notification||n.notification,Ke=("boolean"==typeof n.swNotification&&n.swNotification,"boolean"!=typeof n.autoTypeSearchEnabled||n.autoTypeSearchEnabled),Ne="boolean"==typeof n.launchOnNewMessage&&n.launchOnNewMessage,Oe="boolean"==typeof n.launchOnUnreadMessage&&n.launchOnUnreadMessage,De="number"==typeof n.userTypeId&&n.userTypeId,Re=["DEFAULT","NEW","OPEN"],ze=["BLOCKED_TO","BLOCKED_BY","UNBLOCKED_TO","UNBLOCKED_BY"],Be=new Object,Pe=new Array,$e=new Array,Fe=new Object,qe=new Array,He=new Array,je=new Array,Ve=new Array,Ye=new function(){var e,o,i=this,n=!1,l=t("#mck-file-menu"),p=t("#mck-message-cell .mck-message-inner"),v=(t("#mck-tab-individual"),h);i.getLauncherHtml=function(e){var t=e?"km-launcher-logo-gradient-2":"km-launcher-logo-gradient-1",a='<div id="launcher-svg-container"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 500 500" width="56" height="56" style="enable-background:new 0 0 500 500;" xml:space="preserve">\n              <style type="text/css">\n                  .km-launcher-logo-0{fill:url(#'+t+");}\n                  .km-launcher-logo-1{fill:#FFFFFF;}\n              </style>\n              <g>\n                  <linearGradient id="+t+' gradientUnits="userSpaceOnUse" x1="3.367313e-08" y1="250" x2="500" y2="250">\n                      <stop offset="0" style="stop-color:#3A3C80"/>\n                      <stop offset="0.1658" style="stop-color:#4B4C93"/>\n                      <stop offset="0.3516" style="stop-color:#5858A2"/>\n                      <stop offset="0.5063" style="stop-color:#5C5CA7"/>\n                      <stop offset="0.6795" style="stop-color:#53549D"/>\n                      <stop offset="0.9706" style="stop-color:#3D3E83"/>\n                      <stop offset="1" style="stop-color:#3A3C80"/>\n                  </linearGradient>\n                  <circle class="km-launcher-logo-0" cx="250" cy="250" r="250"/>\n                  <g>\n                      <path class="km-launcher-logo-1" d="M377.5,379.6V237.1c0-51.4-41.7-93.1-93.1-93.1h-84.7c-51.4,0-93.1,41.7-93.1,93.1    c0,51.4,41.7,93.1,93.1,93.1h91.7c0,0,7.4,0.4,11.9,2.1c4.3,1.6,9.1,5.3,9.1,5.3l56.7,46.7c0,0,5.2,4.4,7,3.5    C377.9,386.9,377.5,379.6,377.5,379.6z M202.2,256.2c0,6.2-5.4,11.2-12.1,11.2c-6.7,0-12.1-5-12.1-11.2v-40    c0-6.2,5.4-11.2,12.1-11.2c6.7,0,12.1,5,12.1,11.2V256.2z M254.1,275c0,6.2-5.4,11.2-12.1,11.2c-6.7,0-12.1-5-12.1-11.2v-77.8    c0-6.2,5.4-11.2,12.1-11.2c6.7,0,12.1,5,12.1,11.2V275z M306,256.2c0,6.2-5.4,11.2-12.1,11.2c-6.7,0-12.1-5-12.1-11.2v-40    c0-6.2,5.4-11.2,12.1-11.2c6.7,0,12.1,5,12.1,11.2V256.2z"/>\n                  </g>\n              </g>\n              </svg></div>';return e?'<a href="#" target="_self">'+(ge||a)+"</a>":'<div id="mck-sidebox-launcher" class="mck-sidebox-launcher launchershadow"><a href="#" target="_self" class="applozic-launcher">'+(ge||a)+'<div id="launcher-agent-img-container"></div></a><div id="applozic-badge-count" class="applozic-badge-count"></div><div id="mck-msg-preview-visual-indicator" class="mck-msg-preview-visual-indicator-container n-vis"><div class="mck-close-btn-container"><div class="mck-close-btn"><span class="mck-close-icon-svg"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10"><g fill="none" fill-rule="evenodd" stroke="#FFF" stroke-linecap="round"><path d="M1.0262069.0262069l7.9475862 7.9475862M8.9737931.0262069L1.0262069 7.9737931"/></g></svg></span><span class="mck-close-text">Close</span></div></div><div class="mck-msg-preview-visual-indicator-text  applozic-launcher"></div></div></div><div id="mck-msg-preview" class="mck-msg-preview applozic-launcher"><div class="mck-row"><div class="blk-lg-3 mck-preview-icon"></div><div class="blk-lg-9"><div class="mck-row mck-truncate mck-preview-content"><strong class="mck-preview-cont-name"></strong></div><div class="mck-row mck-preview-content"><div class="mck-preview-msg-content"></div><div class="mck-preview-file-content mck-msg-text notranslate blk-lg-12 mck-attachment n-vis"></div></div></div></div><div id="mck-msg-preview-btns" class="n-vis"><button id="mck-vid-call-accept">Accept</button><button id="mck-vid-call-reject">reject</div></div>'},i.initializeApp=function(e,a){n=a;var s={applicationId:e.appId,userId:Ce};null!==z&&(s.displayName=e.userName),null!==e.email&&(s.email=e.email),null!==X&&(s.contactNumber=e.contactNumber),e.imageLink&&(s.imageLink=e.imageLink),e.appModuleName&&(s.appModuleName=e.appModuleName),J&&(s.password=e.accessToken),-1===j.indexOf(de)&&(de=0),Ae&&(s.resetUserStatus=!0),"number"==typeof De&&(s.userTypeId=De),e.metadata&&(s.metadata=e.metadata),s.enableEncryption=!0,s.appVersionCode=108,s.deviceType=0,s.authenticationTypeId=de,s.chatNotificationMailSent=!0,c="",d="";var o=i.validateAppSession(s);if(o)P&&pt.InitilizeVideoClient(Ce,d);else{var r={name:"km-userName",email:"km-email",phone:"km-contact"};if(Array.isArray(kt)&&0!==kt.length){if(t("#km-userId").val(Ce),kt.length>0)for(var l=0;l<kt.length;l++)t("#"+r[kt[l]]).removeClass("n-vis").addClass("vis"),t("#"+r[kt[l]]).prop("required",!0);var m=document.getElementById("km-chat-login-modal");m.style.visibility="visible",m.style.display="none",$("#km-anonymous-chat-launcher").append(Ye.getLauncherHtml(!0));var p=document.getElementById("km-anonymous-chat-launcher");p.classList.remove("n-vis"),p.classList.add("vis"),document.getElementById("km-modal-close").addEventListener("click",function(e){e.preventDefault(),m.style.display="none",p.classList.remove("n-vis"),p.classList.add("vis")}),p.addEventListener("click",function(e){e.preventDefault(),m.style.display="block",p.classList.remove("vis"),p.classList.add("n-vis")}),document.getElementById("km-tab-title").innerHTML=e.conversationTitle,t("#km-form-chat-login .km-form-group input").hasClass("n-vis")&&t("#km-form-chat-login .km-form-group .km-form-control.n-vis").prop("required",null)}else i.initialize(s)}},i.initialize=function(e){window.Applozic.ALApiService.login({data:{alUser:e,baseUrl:MCK_BASE_URL},success:function(a){P&&pt.InitilizeVideoClient(a.userId,a.deviceKey),"kommunicate"==window.applozic.PRODUCT_ID&&t("#km-chat-login-modal").css("display","none"),ALStorage.clearMckMessageArray(),ALStorage.clearMckContactNameArray(),"INVALID_PASSWORD"!==a?"INVALID_APPID"!==a?"error"!==a&&"USER_NOT_FOUND"!==a?"APPMODULE_NOT_FOUND"!==a?"object"==typeof a&&null!==a&&a.token?(a.appId=e.applicationId,J&&(a.accessToken=e.password),i.onInitApp(a)):"function"==typeof q&&q({status:"error",errorMessage:"UNABLE TO PROCESS REQUEST"}):"function"==typeof q&&q({status:"error",errorMessage:"APPMODULE NOT FOUND"}):"function"==typeof q&&q({status:"error",errorMessage:"USER NOT FOUND"}):"function"==typeof q&&q({status:"error",errorMessage:"INVALID APPLICATION ID"}):"function"==typeof q&&q({status:"error",errorMessage:"INVALID PASSWORD"})},error:function(){ALStorage.clearMckMessageArray(),"function"==typeof q&&q({status:"error",errorMessage:"UNABLE TO PROCESS REQUEST"})}})},i.onInitApp=function(e){if(i.appendLauncher(),i.setLabels(),t(".applozic-launcher").each(function(){t(this).hasClass("mck-msg-preview")||t(this).show()}),r=e.token,Je.setEncryptionKey(e.encryptionKey),Ce=e.userId,e.countryCode,d=e.deviceKey,m=e.websocketUrl,h=e.websocketIdleTimeLimit,e.timeZoneOffset,F=e.fileBaseUrl,O=e.deactivated,c=btoa(e.userId+":"+e.deviceKey),window.Applozic.ALApiService.setAjaxHeaders(c,w,d,J,te),E=e.totalUnreadCount,Je.badgeCountOnLaucher(ve,E),e.connectedClientCount,R||"guest"===Ce||"0"===Ce||"C0"===Ce||(n?yt.reconnect():yt.init()),at.createContactWithDetail({userId:Ce,displayName:e.displayName,photoLink:e.imageLink}),t.ajaxPrefilter(function(e){e.beforeSend||-1===e.url.indexOf(MCK_BASE_URL)||(e.beforeSend=function(e){i.setHeaders(e)})}),e.betaPackage){var s="https://www.kommunicate.io/?utm_source="+a.location.href+"&utm_medium=webplugin&utm_campaign=poweredby";t(".mck-running-on a").attr("href",s),t(".mck-running-on").removeClass("n-vis").addClass("vis")}var o=ALStorage.getMckContactNameArray();if(null!==o&&o.length>0)for(var l=0;l<o.length;l++){var p=o[l];null!==p&&(qe[p[0]]=p[1])}dt.checkUserConnectedStatus(function(e){e.length>0?ot.getUsersDetail(e,{setStatus:!0}):Ze.updateUserConnectedStatus()}),"function"==typeof q&&q("success",e),Ye.tabFocused(),mt.length>0&&E>0&&mt.html(E),Oe&&st.loadMessageList({tabId:"",isGroup:!1,isLaunch:!0}),rt.init(e),ot.loadContacts(),lt.subscribeToServiceWorker(),ALStorage.setAppHeaders(e),Qe.loadGroups({apzCallback:et.loadGroups}),void 0!==kt&&t.fn.applozic("mckLaunchSideboxChat"),Kommunicate.postPluginInitialization(null,e),KommunicateUtils.triggerCustomEvent("kmInitilized",{detail:e,bubbles:!0,cancelable:!0});var u=document.getElementById("km-chat-login-modal");u.style.visibility="hidden"},i.validateAppSession=function(e){et.init(),at.init();var t=ALStorage.getAppHeaders();return!(!t||!t.userId)&&(e.applicationId===t.appId&&e.userId===t.userId&&e.password===t.accessToken?(i.onInitApp(t),!0):(ALStorage.clearAppHeaders(),!1))},i.setHeaders=function(e){e.setRequestHeader("UserId-Enabled",!0),c&&e.setRequestHeader("Authorization","Basic "+c),e.setRequestHeader("Application-Key",w),d&&e.setRequestHeader("Device-Key",d),J&&e.setRequestHeader("Access-Token",J),te&&e.setRequestHeader("App-Module-Name",te)},i.setLabels=function(){t("#mck-conversation-title").html(MCK_LABELS["conversations.title"]).attr("title",MCK_LABELS["conversations.title"]),t("#mck-msg-new, #mck-sidebox-search .mck-box-title").html(MCK_LABELS["start.new"]).attr("title",MCK_LABELS["start.new"]),t("#mck-contact-search-tab strong").html(MCK_LABELS["search.contacts"]).attr("title",MCK_LABELS["search.contacts"]),t("#mck-group-search-tab strong").html(MCK_LABELS["search.groups"]).attr("title",MCK_LABELS["search.groups"]),t("#mck-contact-search-input, #mck-group-search-input, #mck-group-member-search").attr("placeholder",MCK_LABELS["search.placeholder"]),t("#mck-loc-address").attr("placeholder",MCK_LABELS["location.placeholder"]),t("#mck-no-search-contacts").html(MCK_LABELS["empty.contacts"]),t("#mck-no-search-groups").html(MCK_LABELS["empty.groups"]),t("#mck-new-group, #mck-group-create-tab .mck-box-title, #mck-btn-group-create").html(MCK_LABELS["create.group.title"]).attr("title",MCK_LABELS["create.group.title"]),t("#mck-gc-overlay-label").html(MCK_LABELS["add.group.icon"]),t("#mck-msg-error").html(MCK_LABELS["group.deleted"]),t("#mck-gc-title-label").html(MCK_LABELS["group.title"]),t("#mck-gc-type-label").html(MCK_LABELS["group.type"]),t("#mck-group-info-btn, #mck-group-info-tab .mck-box-title").html(MCK_LABELS["group.info.title"]).attr("title",MCK_LABELS["group.info.title"]),t("#mck-gi-overlay-label").html(MCK_LABELS["change.group.icon"]),t("#mck-group-member-title").html(MCK_LABELS["members.title"]).attr("title",MCK_LABELS["members.title"]),t("#mck-group-add-member .blk-lg-9, #mck-gm-search-box .mck-box-title").html(MCK_LABELS["add.members.title"]).attr("title",MCK_LABELS["add.members.title"]),t("#mck-btn-group-update").html(MCK_LABELS["group.info.update"]).attr("title",MCK_LABELS["group.info.update"]),t("#mck-btn-leave-group, #mck-btn-group-exit").html(MCK_LABELS["exit.group"]).attr("title",MCK_LABELS["exit.group"]),t("#mck-typing-label").html(MCK_LABELS.typing),t("#mck-btn-clear-messages").html(MCK_LABELS["clear.messages"]).attr("title",MCK_LABELS["clear.messages"]),t("#mck-block-button").html(MCK_LABELS["block.user"]).attr("title",MCK_LABELS["block.user"]),t("#mck-loc-box .mck-box-title, #mck-share-loc-label").html(MCK_LABELS["location.share.title"]).attr("title",MCK_LABELS["location.share.title"]),t("#mck-btn-loc").attr("title",MCK_LABELS["location.share.title"]),t("#mck-file-up-label").html(MCK_LABELS["file.attachment"]),t("#mck-file-up").attr("title",MCK_LABELS["file.attachment"]),t(".mck-file-attach-label").attr("title",MCK_LABELS["file.attach.title"]),t("#mck-my-loc").html(MCK_LABELS["my.location"]).attr("title",MCK_LABELS["my.location"]),t("#mck-btn-close-loc-box").html(MCK_LABELS.close).attr("title",MCK_LABELS.close),t("#mck-loc-submit").html(MCK_LABELS.send).attr("title",MCK_LABELS.send),t("#mck-msg-sbmt").attr("title",MCK_LABELS["send.message"]),t("#mck-btn-smiley").attr("title",MCK_LABELS.smiley),t("#mck-group-name-save").attr("title",MCK_LABELS.save),t("#mck-btn-group-icon-save").attr("title",MCK_LABELS.save),t("#mck-group-name-edit").attr("title",MCK_LABELS.edit)},t(s).on("click",".fancybox",function(e){var a=t(this),s=a.data("type");if(-1!==s.indexOf("video")){var o,i=a.find(".mck-video-box").html();a.fancybox({content:i,title:a.data("name"),padding:0,openEffect:"none",closeEffect:"none",helpers:{overlay:{locked:!1,css:{background:"rgba(0, 0, 0, 0.8)"}}},beforeShow:function(){(o=t(".fancybox-inner").find("video").get(0)).load(),o.play()}})}else{var n=a.data("url");t(this).fancybox({openEffect:"none",closeEffect:"none",padding:0,href:n,type:"image"})}}),t(a).on("resize",function(){if("block"===l.css("display")&&We.fileMenuReposition(),0===p.find(".mck-contact-list").length){var e=p.get(0).scrollHeight;p.height()<e&&p.animate({scrollTop:p.prop("scrollHeight")},0)}}),i.appendLauncher=function(){t("#mck-sidebox-launcher").remove(),t("body").append(i.getLauncherHtml()),it.init()},i.tabFocused=function(){var e="hidden";function t(t){var s={focus:!0,focusin:!0,pageshow:!0,blur:!1,focusout:!1,pagehide:!1};t=t||a.event,(T=t.type in s?s[t.type]:!this[e])?(v<1&&u&&yt.checkConnected(!0),i.stopIdleTimeCounter()):(1===g&&yt.sendTypingStatus(0),i.manageIdleTime())}e in s?s.addEventListener("visibilitychange",t):("mozHidden"===e)in s?s.addEventListener("mozvisibilitychange",t):("webkitHidden"===e)in s?s.addEventListener("webkitvisibilitychange",t):("msHidden"===e)in s?s.addEventListener("msvisibilitychange",t):"onfocusin"in s?s.onfocusin=s.onfocusout=t:a.onpageshow=a.onpagehide=a.onfocus=a.onblur=t,void 0!==s[e]&&t({type:s[e]?"blur":"focus"})},i.manageIdleTime=function(){v=h,e&&clearInterval(e),e=setInterval(function(){--v<0&&(v=0,yt.stopConnectedCheck(),clearInterval(e),e="")},6e4)},i.stopIdleTimeCounter=function(){v=h,e&&clearInterval(e),e=""},i.manageOfflineMessageTime=function(e){if("object"!=typeof le||isNaN(le.timeout))a.console.log("Offline message timeout required.");else{if(1===le.type){if(!le.userIds||0===le.userIds.length)return void a.console.log("Offline message userIds required.");if(-1===le.userIds.indexOf(e))return}o&&clearInterval(o),o=setTimeout(function(){clearInterval(o),o="",at.showOfflineMessage()},5e3*parseInt(le.timeout))}},i.stopOfflineMessageCounter=function(){o&&clearInterval(o),o=""}},Je=new MckUtils,We=new function(){var e=this,s="",o="",i=!1,n=t("#mck-my-loc"),r=t("#mck-loc-box"),c=t("#mck-loc-lat"),l=t("#mck-loc-lon"),d=t("#mck-btn-loc"),m=t("#mck-sidebox-ft"),p=t("#mck-file-menu"),u=t("#mck-btn-attach"),v=t("#mck-map-content"),g=t("#mck-loc-address");e.init=function(){B&&a.google&&"object"==typeof a.google.maps&&(s=new a.google.maps.Geocoder,u.on("click",function(){e.fileMenuToggle()}),d.on("click",function(){i?r.mckModal():(mckMapUtils.getCurrentLocation(e.onGetCurrLocation,e.onErrorCurrLocation),i=!0)})),n.on("click",function(){mckMapUtils.getCurrentLocation(e.onGetMyCurrLocation,e.onErrorMyCurrLocation)})},e.fileMenuReposition=function(){var e=m.offset();e.bottom=a.innerHeight-e.top,p.css({bottom:e.bottom>51?e.bottom:51,right:0})},e.fileMenuToggle=function(){u.hasClass("on")?(u.removeClass("on"),p.hide()):(e.fileMenuReposition(),u.addClass("on"),p.show())},e.onGetCurrLocation=function(t){MCK_CURR_LATITIUDE=t.coords.latitude,MCK_CURR_LONGITUDE=t.coords.longitude,e.openMapBox()},e.onErrorCurrLocation=function(){MCK_CURR_LATITIUDE=46.15242437752303,MCK_CURR_LONGITUDE=2.7470703125,e.openMapBox()},e.onErrorMyCurrLocation=function(e){alert("Unable to retrieve your location. ERROR("+e.code+"): "+e.message)},e.onGetMyCurrLocation=function(e){if(MCK_CURR_LATITIUDE=e.coords.latitude,MCK_CURR_LONGITUDE=e.coords.longitude,c.val(MCK_CURR_LATITIUDE),l.val(MCK_CURR_LONGITUDE),c.trigger("change"),l.trigger("change"),o)g.val(o);else if(s){var t={lat:MCK_CURR_LATITIUDE,lng:MCK_CURR_LONGITUDE};s.geocode({location:t},function(e,t){"OK"===t&&e[1]&&(o=e[1].formatted_address)})}},e.openMapBox=function(){v.locationpicker({location:{latitude:MCK_CURR_LATITIUDE,longitude:MCK_CURR_LONGITUDE},radius:0,scrollwheel:!0,inputBinding:{latitudeInput:c,longitudeInput:l,locationNameInput:g},enableAutocomplete:!0,enableReverseGeocode:!0,onchanged:function(e){MCK_CURR_LATITIUDE=e.latitude,MCK_CURR_LONGITUDE=e.longitude}}),r.on("shown.bs.mck-box",function(){v.locationpicker("autosize")}),r.mckModal()}},Ze=new function(){var e=t("#mck-msg-form"),s=t("#mck-msg-error"),o=t("#mck-tab-title"),i=t("#mck-tab-status"),n=t(".mck-typing-box"),r=t("#mck-block-button"),c=t("#mck-message-cell .mck-message-inner");this.updateUserConnectedStatus=function(){t(".mck-user-ol-status").each(function(){var e=t(this),a=e.data("mck-id");if(a){var s=b[a];void 0!==b[a]&&s.connected?(e.removeClass("n-vis").addClass("vis"),e.next().html("("+MCK_LABELS.online+")")):(e.removeClass("vis").addClass("n-vis"),e.next().html("(Offline)"))}})},this.lastSeenOfGroupOfTwo=function(e){if(a.MCK_OL_MAP[e])i.attr("title",MCK_LABELS.online).html(MCK_LABELS.online),i.removeClass("n-vis").addClass("vis");else if(I[e]){var t=mckDateUtils.getLastSeenAtStatus(I[e]);i.html(t),i.attr("title",t),o.addClass("mck-tab-title-w-status"),i.removeClass("n-vis").addClass("vis")}},this.toggleBlockUser=function(t,l){if(l)s.html(MCK_LABELS.blocked),s.removeClass("n-vis").addClass("vis").addClass("mck-no-mb"),e.removeClass("vis").addClass("n-vis"),o.removeClass("mck-tab-title-w-status"),i.removeClass("vis").addClass("n-vis"),n.removeClass("vis").addClass("n-vis"),c.data("blocked",!0),r.html(MCK_LABELS["unblock.user"]).attr("title",MCK_LABELS["unblock.user"]);else if(s.html(""),s.removeClass("vis").addClass("n-vis").removeClass("mck-no-mb"),e.removeClass("n-vis").addClass("vis"),c.data("blocked",!1),r.html(MCK_LABELS["block.user"]).attr("title",MCK_LABELS["block.user"]),!C[t]&&(a.MCK_OL_MAP[t]||I[t])){if(a.MCK_OL_MAP[t])i.attr("title",MCK_LABELS.online).html(MCK_LABELS.online);else if(I[t]){var d=mckDateUtils.getLastSeenAtStatus(I[t]);i.html(d),i.attr("title",d)}o.addClass("mck-tab-title-w-status"),i.removeClass("n-vis").addClass("vis")}}},Qe=(new function(){var e=t("#mck-msg-to"),s=(t("#mck-btn-loc"),t("#mck-loc-box")),o=t("#mck-msg-sbmt"),i=t("#mck-msg-error"),n=t("#mck-loc-submit"),r=t("#mck-msg-response"),c=t("#mck_response_text"),l=t("#mck-message-cell .mck-message-inner");n.on("click",function(){var t={type:5,contentType:2,message:a.JSON.stringify(mckMapUtils.getSelectedLocation())},n=l.data("mck-conversationid"),d=l.data("mck-topicid");if(n)t.conversationId=n;else if(d){var m={topicId:d},p=y[d];"object"==typeof p&&(m.topicDetail=a.JSON.stringify(p)),t.conversationPxy=m}!0===l.data("isgroup")?t.groupId=e.val():t.to=e.val(),o.attr("disabled",!0),i.removeClass("vis").addClass("n-vis"),i.html(""),c.html(""),r.removeClass("vis").addClass("n-vis"),st.sendMessage(t),s.mckModal("hide")})},new MckGroupService),Xe=new MckGroupUtils,et=new function(){var e=this,o={0:MCK_LABELS.user,1:MCK_LABELS.admin,2:MCK_LABELS.moderator,3:MCK_LABELS.member},i=document.getElementById("mck-group-create-type");i.options[i.options.length]=new Option(MCK_LABELS.public,"1"),i.options[i.options.length]=new Option(MCK_LABELS.private,"2"),i.options[i.options.length]=new Option(MCK_LABELS.open,"6");var n=t("#mck-msg-form"),r=t("#mck-msg-error"),c=t("#mck-tab-title"),l=t("#mck-tab-status"),d=t("#mck-no-gsm-text"),m=t("#mck-gms-loading"),p=t("#mck-contact-loading"),u=(t("#mck-tab-menu-box"),t("#mck-search-loading"),t("#mck-group-info-tab")),v=t("#mck-sidebox-search"),g=(t("#mck-group-name-box"),t("#mck-group-back-link")),f=t("#mck-group-name-edit"),C=t("#mck-group-name-save"),h=t("#mck-sidebox-content"),b=t("#mck-tab-option-panel"),T=t("#mck-btn-group-create"),E=t("#mck-group-create-tab"),x=t("#mck-contacts-content"),S=t("#mck-btn-group-update"),L=t("#mck-group-create-type"),A=t("#mck-group-icon-upload"),_=t("#mck-group-icon-change"),w=t("#mck-group-member-list"),U=t("#mck-group-update-panel"),O=t(".mck-tab-message-option"),D=t("#mck-group-create-title"),R=t(".mck-group-menu-options"),z=t("#mck-group-member-search"),B=t("#mck-btn-group-icon-save"),P=(t("#mck-group-info-icon-box"),t(".mck-group-admin-options")),$=t("#mck-group-add-member-box"),F=t("#mck-message-cell .mck-message-inner"),q=t("#mck-group-name-sec .mck-group-title"),H=(t("#mck-group-create-icon-box"),t("#mck-group-info-icon-loading")),j=t("#mck-gm-search-box"),V=(t("#mck-group-member-search-list"),t("#mck-group-create-icon-loading")),Y=t("#mck-group-info-icon-box .mck-group-icon"),J=t("#mck-group-create-icon-box .mck-group-icon"),W=t("#mck-group-create-icon-box .mck-overlay-box"),Z=t("#mck-gc-overlay-label");t(".mck-group-name-box div[contenteditable]").keypress(function(a){return!!(8===a.which||37===a.keyCode||38===a.keyCode||39===a.keyCode||40===a.keyCode||a.ctrlKey&&97===a.which)||(13!==a.keyCode||a.shiftKey||a.ctrlKey?30>this.innerHTML.length:!!t(a.target).hasClass("mck-group-create-title")&&(e.submitCreateGroup(),!1))}).on("paste",function(e){var t=this;setTimeout(function(){var e=t.innerText.length;return e>30&&(t.innerHTML=t.innerText.substring(0,30),Je.setEndOfContenteditable(t)),!1},"fast")}).on("drop",function(e){e.preventDefault(),e.stopPropagation()}),t(s).on("click",".mck-btn-change-role",function(e){e.preventDefault();var a=t(this).parents(".mck-li-group-member").find(".mck-group-change-role-box"),s=t(this).parents(".mck-li-group-member").data("role");a.find("select").val(s),a.removeClass("n-vis").addClass("vis"),U.removeClass("n-vis").addClass("vis")}),S.on("click",function(){var e=[];if(t(".mck-group-change-role-box.vis").each(function(a,s){var o=t(this),i=parseInt(o.find("select").val()),n=o.parents(".mck-li-group-member").data("role");if(i!==n){var r={userId:o.parents(".mck-li-group-member").data("mck-id"),role:i};e.push(r)}}),e.length>0){var a=F.data("mck-id"),s=F.data("isgroup");if(a&&s){S.attr("disabled",!0).html(MCK_LABELS["group.info.updating"]);var o={groupId:a,users:e,apzCallback:et.onUpdateGroupInfo};Qe.updateGroupInfo(o)}}}),t("#mck-group-info-icon-box .mck-overlay").on("click",function(e){_.trigger("click")}),t("#mck-group-create-icon-box .mck-overlay").on("click",function(e){A.trigger("click")}),t(s).on("mouseenter",".mck-group-create-icon-box.mck-hover-on",function(){t(this).find(".mck-overlay-box").removeClass("n-vis")}).on("mouseleave",".mck-group-create-icon-box.mck-hover-on",function(){var e=t(this);0===e.find(".mck-group-icon-default").length&&e.find(".mck-overlay-box").addClass("n-vis")}),t(s).on("mouseenter",".mck-group-info-icon-box.mck-hover-on",function(){t(this).find(".mck-overlay-box").removeClass("n-vis")}).on("mouseleave",".mck-group-info-icon-box.mck-hover-on",function(){t(this).find(".mck-overlay-box").addClass("n-vis")}),f.on("click",function(){q.attr("contenteditable",!0).focus(),Je.setEndOfContenteditable(q[0]),C.removeClass("n-vis").addClass("vis"),f.removeClass("vis").addClass("n-vis")}),C.on("click",function(){var e=t.trim(q.text());if(e.length>0){var a=F.data("mck-id"),s=F.data("isgroup");if(a&&s){f.removeClass("n-vis").addClass("vis"),C.removeClass("vis").addClass("n-vis"),q.attr("contenteditable",!1);var o={groupId:a,name:e,apzCallback:et.onUpdateGroupInfo};Qe.updateGroupInfo(o)}}else q.addClass("mck-req-border")}),B.on("click",function(){var e=Y.data("iconurl");if(e){var t=F.data("mck-id"),a=F.data("isgroup");if(t&&a){setTimeout(function(){B.removeClass("vis").addClass("n-vis")},1e3),Y.data("iconurl","");var s={groupId:t,imageUrl:e,apzCallback:et.onUpdateGroupInfo};Qe.updateGroupInfo(s)}}else q.addClass("mck-req-border")}),T.on("click",function(){e.submitCreateGroup()}),e.init=function(){t.template("groupMemberTemplate",'<li id="li-gm-${contHtmlExpr}" class="${contIdExpr} mck-li-group-member" data-mck-id="${contIdExpr}" data-role="${roleVal}" data-alpha="${contFirstAlphaExpr}"><div class="mck-row mck-group-member-info" title="${contNameExpr}"><div class="blk-lg-3">{{html contImgExpr}}</div><div class="blk-lg-9"><div class="mck-row"><div class="blk-lg-8 mck-cont-name mck-truncate"><strong>${contNameExpr}</strong></div><div class="blk-lg-4 mck-group-admin-text move-right vis"><span>${roleExpr}</span></div></div><div class="mck-row"><div class="blk-lg-8 mck-truncate mck-last-seen-status" title="${contLastSeenExpr}">${contLastSeenExpr}</div><div class="blk-lg-4 mck-group-admin-options move-right ${enableAdminMenuExpr}"><div class="mck-menu-box n-vis"><div class="mck-dropdown-toggle mck-group-admin-menu-toggle mck-text-center" data-toggle="mckdropdown" aria-expanded="true"><span class="mck-caret"></span></div><ul id="mck-group-admin-menu" class="mck-dropdown-menu mck-group-admin-menu mck-tab-menu-box menu-right" role="menu"><li><a href="#" target="_self"  class="mck-btn-remove-member menu-item" title="${removeMemberLabel}">${removeMemberLabel}</a></li><li><a href="#" target="_self"  class="mck-btn-change-role menu-item" title="${changeRoleLabel}">${changeRoleLabel}</a></li></ul></div></div></div><div id="mck-group-change-role-box" class="mck-row mck-group-change-role-box n-vis"><div class="blk-lg-4"><div class="mck-label">Select role </div></div><div class="blk-lg-8 move-right"><select id="mck-change-role-type" class="mck-select"><option value="0">User</option><option value="1">Admin</option><option value="2">Moderator</option><option value="3" selected>Member</option></select></div></div></div></div></li>'),t.template("groupMemberSearchTemplate",'<li id="li-${contHtmlExpr}" class="${contIdExpr} mck-li-group-member" data-mck-id="${contIdExpr}"><a class="mck-add-to-group" href="#" data-mck-id="${contIdExpr}"><div class="mck-row" title="${contNameExpr}"><div class="blk-lg-3">{{html contImgExpr}}</div><div class="blk-lg-9"><div class="mck-row"><div class="blk-lg-12 mck-cont-name mck-truncate"><strong>${contNameExpr}</strong></div></div><div class="mck-row"><div class="blk-lg-12 mck-truncate mck-last-seen-status" title="${contLastSeenExpr}">${contLastSeenExpr}</div></div></div></div></a></li>')},e.submitCreateGroup=function(){var e=t.trim(D.text()),a=L.val(),s=J.data("iconurl");if(e.length>0){var o={groupName:e};a&&(a=parseInt(a),-1!==K.indexOf(a)&&(o.type=a)),s&&(o.groupIcon=s),J.data("iconurl",""),o.isInternal=!0,T.attr("disabled",!0).html(MCK_LABELS["group.create.submit"]),st.getGroup(o)}else D.addClass("mck-req-border")},e.loadGroups=function(e){var a=e.data;Pe.length=0,t.each(a,function(e,t){if(void 0!==t.id){var t=Xe.addGroup(t);Pe.push(t)}})},e.getDeletedAtTime=function(e){if("object"==typeof MCK_GROUP_MAP[e]){var t=MCK_GROUP_MAP[e];return t.deletedAtTime}},e.validateOpenGroupUser=function(e){if(6===e.type){var t=Qe.authenticateGroupUser(e);if(!t){if(ce.disableChatForNonGroupMember){var a=ce.defaultChatDisabledMessage;a||(a="Chat disabled"),r.html(a),r.removeClass("n-vis").addClass("vis").addClass("mck-no-mb"),n.removeClass("vis").addClass("n-vis"),c.removeClass("mck-tab-title-w-status"),l.removeClass("vis").addClass("n-vis")}R.removeClass("vis").addClass("n-vis"),O.removeClass("vis").addClass("n-vis"),b.removeClass("vis").addClass("n-vis"),void 0===G[e.contactId]&&yt.subscribeToOpenGroup(e)}return e.adminName===Ce?0===ce.deleteChatAccess&&O.removeClass("vis").addClass("n-vis"):(ce.allowInfoAccessGroupMembers||R.removeClass("vis").addClass("n-vis"),2!==ce.deleteChatAccess&&O.removeClass("vis").addClass("n-vis"),ce.allowInfoAccessGroupMembers||2===ce.deleteChatAccess||b.removeClass("vis").addClass("n-vis")),!1}return!0},e.addGroupStatus=function(t){var a=e.isGroupLeft(t);if(6!==t.type&&(a||Ee))a&&et.onGroupLeft("",{groupId:t.contactId}),c.removeClass("mck-tab-title-w-status"),l.removeClass("vis").addClass("n-vis");else if(t.members.length>0){for(var s="",o=!1,i=t.members.length<=30?t.members.length:25,n=0;n<i;n++)if(Ce!==""+t.members[n]&&-1===t.removedMembersId.indexOf(t.members[n])){var r=at.fetchContact(""+t.members[n]),d=at.getTabDisplayName(r.contactId,!1);s+=" "+d+","}else o=!0;(5!==t.type&&6!==t.type||o&&5!==t.type)&&(s+=" You"),t.members.length>30&&(s+=" and "+(t.members.length-25)+" more"),s=s.replace(/,\s*$/,""),l.html(s),l.attr("title",s),l.removeClass("n-vis").addClass("vis"),c.addClass("mck-tab-title-w-status"),R.removeClass("n-vis").addClass("vis")}else c.removeClass("mck-tab-title-w-status"),l.removeClass("vis").addClass("n-vis");7===t.type&&(l.html(""),R.removeClass("vis").addClass("n-vis"))},e.disableGroupTab=function(){r.html(MCK_LABELS["group.chat.disabled"]),r.removeClass("n-vis").addClass("vis").addClass("mck-no-mb"),n.removeClass("vis").addClass("n-vis"),c.removeClass("mck-tab-title-w-status"),l.removeClass("vis").addClass("n-vis")},e.isGroupLeft=function(e){var a=!1;return e.removedMembersId&&e.removedMembersId.length>0&&t.each(e.removedMembersId,function(e,t){t===Ce&&(a=!0)}),a},e.onGroupLeft=function(t,a){if(p.removeClass("vis").addClass("n-vis"),"object"!=typeof t||"error"!==t.status){var s=a.groupId;if(u.hasClass("vis")){var o=u.data("mck-id");s===o&&g.trigger("click")}else if(h.hasClass("vis")){var i=F.data("mck-id"),n=F.data("isgroup");i===s.toString()&&n&&(R.removeClass("vis").addClass("n-vis"),e.disableGroupTab())}}else alert("Unable to process your request. "+t.errorMessage)},e.onAddedGroupMember=function(a,s){if(p.removeClass("vis").addClass("n-vis"),"object"!=typeof a||"error"!==a.status){var o=s.groupId,i=s.userId,n="";if(o?n=Xe.getGroup(o):s.clientGroupId&&(n=Xe.getGroupByClientGroupId(s.clientGroupId)),"object"==typeof n){if(n=Qe.addMemberToGroup(n,i),u.hasClass("vis")){var r=u.data("mck-id");if(o===r){var c=at.fetchContact(""+i);0===t("#li-gm-"+c.htmlId).length&&e.addGroupMember(n,c),e.sortGroupMemberHtmlList(),e.enableGroupAdminMenuToggle()}}else if(h.hasClass("vis")){var l=F.data("mck-id"),d=F.data("isgroup");l===o.toString()&&d&&e.addGroupStatus(n)}}else Qe.getGroupFeed({groupId:o,clientGroupId:s.clientGroupId,apzCallback:et.onGroupFeed})}else alert("Unable to process your request. "+a.errorMessage)},e.onRemovedGroupMember=function(a,s){if(p.removeClass("vis").addClass("n-vis"),"object"!=typeof a||"error"!==a.status){var o=s.groupId,i=s.userId,n="";if(o?n=Xe.getGroup(o):s.clientGroupId&&(n=Xe.getGroupByClientGroupId(s.clientGroupId)),"object"==typeof n){if(n=Qe.removeMemberFromGroup(n,i),u.hasClass("vis")){var r=u.data("mck-id");if(o===r){var c=at.fetchContact(""+i),l=t("#li-gm-"+c.htmlId);l.length>0&&l.remove()}}else if(h.hasClass("vis")){var d=F.data("mck-id"),m=F.data("isgroup");d===o.toString()&&m&&e.addGroupStatus(n)}}else Qe.getGroupFeed({groupId:o,clientGroupId:s.clientGroupId,apzCallback:et.onGroupFeed})}else alert("Unable to process your request. "+a.errorMessage)},e.onGroupFeed=function(a,s){if(p.removeClass("vis").addClass("n-vis"),"success"===a.status){var o=a.data,i=o.conversationPxy,c=Xe.getGroup(o.id);o.deletedAtTime&&(r.html(MCK_LABELS["group.deleted"]),r.removeClass("n-vis").addClass("vis").addClass("mck-no-mb"),n.removeClass("vis").addClass("n-vis"));var l=new Array;"object"==typeof i&&(M[i.id]=i,N[i.topicId]=[i.id],i.topicDetail&&(y[i.topicId]=t.parseJSON(i.topicDetail)),l.push(i)),l.length>0&&(Ve[s.groupId]=l),dt.loadUserProfiles(o.membersId,function(e,a){t.each(e,function(e,t){void 0===at.getContact(t)&&a.push(t)}),ot.getUsersDetail(a,{async:!1})}),s.isMessage&&"object"==typeof s.message&&at.populateMessage(s.messageType,s.message,s.notifyUser),s.isReloadTab&&e.reloadGroupTab(c)}},e.onUpdateGroupInfo=function(a,s){if(p.removeClass("vis").addClass("n-vis"),S.attr("disabled",!1).html("Update"),U.removeClass("vis").addClass("n-vis"),"object"!=typeof a||"error"!==a.status){var o=s.groupId,i=s.groupInfo,n=Xe.getGroup(o);if("object"==typeof n){if(i.imageUrl&&(n.imageUrl=i.imageUrl),i.newName&&(n.displayName=i.newName),i.metadata&&(n.metadata=i.metadata),i.users&&i.users.length>0&&t.each(i.users,function(e,t){t.userId&&(n.users[t.userId]=t)}),u.hasClass("vis"))i.imageUrl&&Y.html(Qe.getGroupImage(n.imageUrl)),q.html(n.displayName),i.users&&i.users.length>0&&(w.html(""),e.addMembersToGroupInfoList(n),n.adminName===Ce?$.removeClass("n-vis").addClass("vis"):$.removeClass("vis").addClass("n-vis"));else if(h.hasClass("vis")){var r=F.data("mck-id"),l=F.data("isgroup");r===o.toString()&&l?c.html(n.displayName):t("#li-group-"+n.htmlId).length>0&&(t("#li-group-"+n.htmlId+" .mck-cont-name strong").html(n.displayName),i.imageUrl&&t("#li-group-"+n.htmlId+" .blk-lg-3").html("<img src=' "+n.imageUrl+"'>"))}MCK_GROUP_MAP[n.contactId]=n}}else alert("Unable to process your request. "+a.errorMessage)},e.getGroupFeedFromMessage=function(e){var t=e.message;if(t){if(e.groupId=t.groupId,e.isMessage=!0,t.conversationId){var a=M[t.conversationId];"object"==typeof a&&"object"==typeof y[a.topicId]||(e.conversationId=t.conversationId)}e.apzCallback=et.onGroupFeed,Qe.getGroupFeed(e)}},e.reloadGroupTab=function(t){var a=F.data("mck-id"),s=F.data("isgroup");a===t.contactId.toString()&&s&&e.addGroupStatus(t)},e.loadGroupTab=function(e){if("error"===e.status)alert("Unable to process your request. "+e.errorMessage);else{var a=e.data;at.loadTab({tabId:a.contactId,isGroup:!0}),t("#mck-search").val("")}},e.addMembersToGroupInfoList=function(a){var s=a.members;s.sort(),w.html(""),t.each(s,function(s,o){if(o){var i=at.fetchContact(""+o);0===t("#li-gm-"+i.htmlId).length&&e.addGroupMember(a,i)}}),e.sortGroupMemberHtmlList(),e.enableGroupAdminMenuToggle()},e.enableGroupAdminMenuToggle=function(){t(".mck-group-member-info").bind("mouseenter",function(){t(this).find(".mck-menu-box").removeClass("n-vis")}).bind("mouseleave",function(){t(this).find(".mck-menu-box").removeClass("open").addClass("n-vis")})},e.addGroupMember=function(e,s){var i="n-vis",n="n-vis",r=e.users[s.contactId],c=MCK_LABELS.member,l=3;r&&void 0!==r.role&&(l=r.role,c=o[r.role]);var d=at.getTabDisplayName(s.contactId,!1);s.contactId===e.adminName&&(i="vis"),e.adminName===Ce&&(n="vis"),s.contactId===Ce&&(d=MCK_LABELS.you,n="n-vis");var m=at.getContactImageLink(s,d),p="";k[s.contactId]||(a.MCK_OL_MAP[s.contactId]?p=MCK_LABELS.online:I[s.contactId]&&(p=mckDateUtils.getLastSeenAtStatus(I[s.contactId])));var u=[{roleExpr:c,roleVal:l,removeMemberLabel:MCK_LABELS["remove.member"],changeRoleLabel:MCK_LABELS["change.role"],contHtmlExpr:s.htmlId,contIdExpr:s.contactId,contImgExpr:m,contLastSeenExpr:p,contNameExpr:d,contFirstAlphaExpr:d.charAt(0).toUpperCase(),isAdminExpr:i,enableAdminMenuExpr:n}];t.tmpl("groupMemberTemplate",u).appendTo("#mck-group-member-list")},e.addMembersToGroupSearchList=function(){var a=F.data("mck-id"),s=F.data("isgroup");if(s){var o=Xe.getGroup(a),i=je,n=[],r=ALStorage.getFriendListGroupName(),c=ALStorage.getFriendListGroupType();r&&c&&(i=ot.getFriendList(r,c)),r&&!c&&(i=ot.getFriendList(r)),(i=i.filter(function(e,t){return i.indexOf(e)===t})).sort();var l=o.members;t.each(i,function(t,a){if(a){if("object"==typeof a&&a.contactId)var a=at.fetchContact(""+a.contactId);else var a=at.fetchContact(""+a);(-1===l.indexOf(a.contactId)||-1!==l.indexOf(a.contactId)&&-1!==o.removedMembersId.indexOf(a.contactId))&&(e.addGroupSearchMember(a),n.push(a))}}),e.enableGroupAdminMenuToggle(),n.length>0?d.removeClass("vis").addClass("n-vis"):d.removeClass("n-vis").addClass("vis"),at.initAutoSuggest({contactsArray:n,$searchId:z,isContactSearch:!1})}m.removeClass("vis").addClass("n-vis")},e.addGroupSearchMember=function(e){var s=at.getTabDisplayName(e.contactId,!1),o=at.getContactImageLink(e,s),i="user-"+e.htmlId,n="";k[e.contactId]||(a.MCK_OL_MAP[e.contactId]?n=MCK_LABELS.online:I[e.contactId]&&(n=mckDateUtils.getLastSeenAtStatus(I[e.contactId])));var r=[{contHtmlExpr:i,contIdExpr:e.contactId,contImgExpr:o,contLastSeenExpr:n,contNameExpr:s}];t.tmpl("groupMemberSearchTemplate",r).appendTo("#mck-group-member-search-list")},e.loadCreateGroupTab=function(){x.removeClass("vis").addClass("n-vis"),h.removeClass("vis").addClass("n-vis"),v.removeClass("vis").addClass("n-vis"),u.removeClass("vis").addClass("n-vis"),V.removeClass("vis").addClass("n-vis"),J.data("iconurl",""),D.html(""),W.removeClass("n-vis"),Z.html(MCK_LABELS["add.group.icon"]),J.html(Qe.getGroupDefaultIcon()),E.removeClass("n-vis").addClass("vis")},e.loadGroupInfo=function(t){if(t.groupId){q.attr("contenteditable",!1),C.removeClass("vis").addClass("n-vis"),f.removeClass("n-vis").addClass("vis"),x.removeClass("vis").addClass("n-vis"),h.removeClass("vis").addClass("n-vis"),v.removeClass("vis").addClass("n-vis"),U.removeClass("vis").addClass("n-vis"),E.removeClass("vis").addClass("n-vis"),B.removeClass("vis").addClass("n-vis"),H.removeClass("vis").addClass("n-vis"),u.removeClass("n-vis").addClass("vis"),u.data("mck-id",t.groupId),Y.data("iconurl",""),t.conversationId&&u.data("mck-conversation-id",t.conversationId),w.html("");var a=Xe.getGroup(t.groupId);"object"==typeof a?(Y.html(Qe.getGroupImage(a.imageUrl)),q.html(a.displayName),e.addMembersToGroupInfoList(a),a.adminName===Ce?$.removeClass("n-vis").addClass("vis"):$.removeClass("vis").addClass("n-vis")):Qe.getGroupFeed({groupId:t.groupId,apzCallback:et.onGroupFeed})}},e.sortGroupMemberHtmlList=function(){t("#mck-group-member-list .mck-li-group-member").sort(function(e,t){return e.dataset.alpha>t.dataset.alpha}).appendTo("#mck-group-member-list")},e.addGroupMemberFromSearch=function(e){var t=u.data("mck-id");if(void 0!==t&&void 0!==e){var a=Xe.getGroup(t);"object"==typeof a&&Ce===a.adminName?(dt.loadUserProfile(e),Qe.addGroupMember({groupId:t,userId:e,apzCallback:et.onAddedGroupMember})):P.removeClass("vis").addClass("n-vis")}j.mckModal("hide")}},tt=new function(){var e=this,a=["CREATE","UPDATE"],o=t("#mck-file-box"),i=t(".mck-overlay"),n=t("#mck-msg-sbmt"),r=t("#mck-text-box"),l=t("#mck-file-input"),m=t("#mck-autosuggest-search-input"),u=t(".mck-overlay-box"),v=t(".mck-file-upload"),g=t("#mck-group-icon-upload"),f=t("#mck-group-icon-change"),k=t("#mck-group-info-icon-box"),C=t("#mck-btn-group-icon-save"),h=t("#mck-message-cell .mck-message-inner"),b=t("#mck-group-create-icon-box"),y=t("#mck-group-info-icon-loading"),I=t("#mck-group-create-icon-loading"),M=t("#mck-group-info-icon-box .mck-group-icon"),T=t("#mck-group-create-icon-box .mck-group-icon"),E=t("#mck-gc-overlay-label");e.init=function(){t.template("fileboxTemplate",'<div id="mck-filebox-${fileIdExpr}" class="mck-file-box ${fileIdExpr}"><div class="mck-file-expr"><span class="mck-file-content blk-lg-8"><span class="mck-file-lb">{{html fileNameExpr}}</span>&nbsp;<span class="mck-file-sz">${fileSizeExpr}</span></span><span class="km-progress km-progress-striped active blk-lg-3" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><span class="km-progress-bar km-progress-bar-success km-bar" stye></span></span><span class="move-right"><button type="button" class="mck-attach-icon mck-box-close mck-remove-file" data-dismiss="div" aria-hidden="true">x</button></span></div></div>'),Kommunicate.attachEvents(t),v.on("click",function(){l.trigger("click")}),g.on("change",function(){var s=t(this)[0].files[0];return e.uplaodFileToAWS(s,a[0]),!1}),f.on("change",function(){var s=t(this)[0].files[0];return e.uplaodFileToAWS(s,a[1]),!1}),l.on("change",function(){var a=t(this)[0].files[0],s={};s.file=a,s.name=a.name,"awsS3Server"===fe?e.uploadAttachment2AWS(s):"googleCloud"===fe?e.customFileUpload(s):e.uploadFile(s)}),t(s).on("click",".mck-remove-file",function(){var e=t(this).parents(".mck-file-box"),a=e.data("mckfile");e.remove(),n.attr("disabled",!1),0===o.find(".mck-file-box").length&&(o.removeClass("vis").addClass("n-vis"),r.attr("required","")),"object"==typeof a&&(rt.deleteFileMeta(a.blobKey),t.each(p,function(e,t){void 0!==t&&t.blobKey===a.blobKey&&p.splice(e,1)}))}),m.on("input",function(e){e.preventDefault(),r.text(m.val()),"KM_AUTO_SUGGEST"!=m.data("origin")&&""!=m.data("source-url")&&at.populateAutoSuggest({sourceUrl:m.data("source-url"),method:m.data("method"),headers:m.data("headers")})})},e.audioRecoder=function(t){"awsS3Server"===fe?e.uploadAttachment2AWS(t):"googleCloud"===fe?e.customFileUpload(t):e.uploadFile(t)},e.customFileUpload=function(e){var a=e.file,s=new FormData,i=[];if(void 0!==a){if(t(".mck-file-box").length>4&&i.push("Can't upload more than 5 files at a time"),a.size>1048576*ee&&i.push("file size can not be more than "+ee+" MB"),!(i.length>0)){var l=Je.randomId(),m=[{fileIdExpr:l,fileName:e.name,fileNameExpr:'<a href="#" target="_self" >'+e.name+"</a>",fileSizeExpr:rt.getFilePreviewSize(a.size)}];t.tmpl("fileboxTemplate",m).appendTo("#mck-file-box");var u=t(".mck-file-box."+l),g=t(".mck-file-box."+l+" .mck-file-lb"),f=t(".mck-file-box."+l+" .km-progress .km-bar"),k=t(".mck-file-box."+l+" .km-progress"),C=t(".mck-file-box."+l+" .mck-remove-file");if(f.css("width","0%"),k.removeClass("n-vis").addClass("vis"),C.attr("disabled",!0),v.attr("disabled",!0),o.removeClass("n-vis").addClass("vis"),e.name===t(".mck-file-box."+l+" .mck-file-lb a").html()){var b=h.data("mck-id"),y=e.name+a.size;Be[y]=b,n.attr("disabled",!0),s.append("files[]",a);var I=new XMLHttpRequest;(I.upload||I).addEventListener("progress",function(e){var t=parseInt(e.loaded/e.total*100,10);f.css("width",t+"%")}),I.addEventListener("load",function(e){var a=t.parseJSON(this.responseText);if("object"==typeof a){var s=a.fileMeta,o="object"==typeof s?'<a href="'+s.url+'" target="_blank">'+s.name+"</a>":"",i=s.name,c=s.size,l=h.data("mck-id"),d=i+c,m=Be[d];return b!==l?(at.updateDraftMessage(m,s),void delete Be[d]):(C.attr("disabled",!1),v.attr("disabled",!1),n.attr("disabled",!1),delete Be[d],g.html(o),k.removeClass("vis").addClass("n-vis"),t(".mck-file-box .progress").removeClass("vis").addClass("n-vis"),r.removeAttr("required"),p.push(s),u.data("mckfile",s),v.children("input").val(""),!1)}C.attr("disabled",!1),n.attr("disabled",!1),C.trigger("click")});var M=A+"/files/upload/";I.open("post",M,!0),I.setRequestHeader("UserId-Enabled",!0),I.setRequestHeader("Authorization","Basic "+c),I.setRequestHeader("Application-Key",w),I.setRequestHeader("Device-Key",d),J&&I.setRequestHeader("Access-Token",J),I.send(s)}return!1}alert(i.toString())}},e.uploadFile=function(e){var a=e.file,s=new Object,i=[];if(void 0!==a){if(t(".mck-file-box").length>4&&i.push("Can't upload more than 5 files at a time"),a.size>1048576*ee&&i.push("file size can not be more than "+ee+" MB"),!(i.length>0)){var c=Je.randomId(),l=[{fileIdExpr:c,fileName:e.name,fileNameExpr:'<a href="#" target="_self" >'+e.name+"</a>",fileSizeExpr:rt.getFilePreviewSize(a.size)}];t.tmpl("fileboxTemplate",l).appendTo("#mck-file-box");var d=t(".mck-file-box."+c),m=t(".mck-file-box."+c+" .mck-file-lb"),u=t(".mck-file-box."+c+" .km-progress .km-bar"),g=t(".mck-file-box."+c+" .km-progress"),f=t(".mck-file-box."+c+" .mck-remove-file");if(u.css("width","0%"),g.removeClass("n-vis").addClass("vis"),f.attr("disabled",!0),v.attr("disabled",!0),o.removeClass("n-vis").addClass("vis"),e.name===t(".mck-file-box."+c+" .mck-file-lb a").html()){var k=h.data("mck-id"),C=e.name+a.size;Be[C]=k,n.attr("disabled",!0),s.files=[],s.files.push(a);var b=new XMLHttpRequest;(b.upload||b).addEventListener("progress",function(e){var t=parseInt(e.loaded/e.total*100,10);u.css("width",t+"%")}),b.addEventListener("load",function(e){var a=t.parseJSON(this.responseText);if("object"==typeof a.fileMeta){var s=a.fileMeta,o=rt.getFilePreviewPath(s);s.url=F+"/rest/ws/aws/file/"+s.blobKey;var i=s.name,c=s.size,l=h.data("mck-id"),u=i+c,C=Be[u];return k!==l?(at.updateDraftMessage(C,s),void delete Be[u]):(f.attr("disabled",!1),v.attr("disabled",!1),n.attr("disabled",!1),delete Be[u],m.html(o),g.removeClass("vis").addClass("n-vis"),t(".mck-file-box .km-progress").removeClass("vis").addClass("n-vis"),r.removeAttr("required"),p.push(s),d.data("mckfile",s),v.children("input").val(""),!1)}f.attr("disabled",!1),n.attr("disabled",!1),f.trigger("click")}),t.ajax({type:"GET",url:F+"/rest/ws/aws/file/url",global:!1,data:"data="+(new Date).getTime(),crosDomain:!0,success:function(e){var t=new FormData;t.append("files[]",a),b.open("POST",e,!0),b.send(t)},error:function(){}})}return!1}alert(i.toString())}},e.uploadAttachment2AWS=function(e){var a=e.file,s=new FormData,i=[];if(void 0!==a){if(t(".mck-file-box").length>4&&i.push("Can't upload more than 5 files at a time"),a.size>1048576*ee&&i.push("file size can not be more than "+ee+" MB"),!(i.length>0)){var l=Je.randomId(),m=[{fileIdExpr:l,fileName:e.name,fileNameExpr:'<a href="#" target="_self" >'+e.name+"</a>",fileSizeExpr:rt.getFilePreviewSize(a.size)}];t.tmpl("fileboxTemplate",m).appendTo("#mck-file-box");var u=t(".mck-file-box."+l),g=t(".mck-file-box."+l+" .mck-file-lb"),f=t(".mck-file-box."+l+" .km-progress .km-bar"),k=t(".mck-file-box."+l+" .km-progress"),C=t(".mck-file-box."+l+" .mck-remove-file");if(f.css("width","0%"),k.removeClass("n-vis").addClass("vis"),C.attr("disabled",!0),v.attr("disabled",!0),o.removeClass("n-vis").addClass("vis"),e.name===t(".mck-file-box."+l+" .mck-file-lb a").html()){var b=h.data("mck-id"),y=e.name+a.size;Be[y]=b,n.attr("disabled",!0),s.append("file",a);var I=new XMLHttpRequest;(I.upload||I).addEventListener("progress",function(e){var t=parseInt(e.loaded/e.total*100,10);f.css("width",t+"%")}),I.addEventListener("load",function(e){var a=t.parseJSON(this.responseText);if("object"==typeof a){var s=a,o="object"==typeof s?'<a href="'+s.url+'" target="_blank">'+s.name+"</a>":"",i=s.name,c=s.size,l=h.data("mck-id"),d=i+c,m=Be[d];return b!==l?(at.updateDraftMessage(m,s),void delete Be[d]):(C.attr("disabled",!1),v.attr("disabled",!1),n.attr("disabled",!1),delete Be[d],g.html(o),k.removeClass("vis").addClass("n-vis"),t(".mck-file-box .km-progress").removeClass("vis").addClass("n-vis"),r.removeAttr("required"),p.push(s),u.data("mckfile",s),v.children("input").val(""),!1)}C.attr("disabled",!1),n.attr("disabled",!1),C.trigger("click")});var M=MCK_BASE_URL+"/rest/ws/upload/image";I.open("post",M,!0),I.setRequestHeader("UserId-Enabled",!0),I.setRequestHeader("Authorization","Basic "+c),I.setRequestHeader("Application-Key",w),I.setRequestHeader("Device-Key",d),J&&I.setRequestHeader("Access-Token",J),I.send(s)}return!1}alert(i.toString())}},e.uplaodFileToAWS=function(e,t){var s=new FormData,o=[];if(void 0!==e)if(-1===e.type.indexOf("image")&&o.push("Please upload image file."),o.length>0)alert(o.toString());else{i.attr("disabled",!0),a[0]===t?(b.find(".mck-overlay-box").removeClass("n-vis"),b.removeClass("mck-hover-on"),I.removeClass("n-vis").addClass("vis")):(k.find(".mck-overlay-box").removeClass("n-vis"),k.removeClass("mck-hover-on"),y.removeClass("n-vis").addClass("vis"));var n=new XMLHttpRequest;n.addEventListener("load",function(e){var s=this.responseText;return s&&(a[0]===t?(T.html('<img src="'+s+'"/>'),T.data("iconurl",s),E.html(MCK_LABELS["change.group.icon"]),I.removeClass("vis").addClass("n-vis"),b.addClass("mck-hover-on")):(M.html('<img src="'+s+'"/>'),M.data("iconurl",s),y.removeClass("vis").addClass("n-vis"),k.addClass("mck-hover-on"),setTimeout(function(){C.removeClass("n-vis").addClass("vis")},1500)),setTimeout(function(){u.addClass("n-vis")},1500)),i.attr("disabled",!1),a[0]===t?g.val(""):f.val(""),!1}),s.append("file",e),n.open("post",MCK_BASE_URL+"/rest/ws/upload/file",!0),n.setRequestHeader("UserId-Enabled",!0),n.setRequestHeader("Authorization","Basic "+c),n.setRequestHeader("Application-Key",w),n.setRequestHeader("Device-Key",d),J&&n.setRequestHeader("Access-Token",J),n.send(s)}},e.addFileBox=function(e){var a=Je.randomId(),s="";"object"==typeof e.fileMeta&&(a=e.fileMeta.createdAtTime,s=e.fileMeta.name);var o=[{fileNameExpr:e.filelb,fileSizeExpr:e.filesize,fileIdExpr:a,fileName:s}];t.tmpl("fileboxTemplate",o).appendTo("#mck-file-box");var i=t(".mck-file-box."+a),c=i.find(".mck-remove-file"),l=i.find(".progress");"object"==typeof e.fileMeta?(i.data("mckblob",e.fileMeta.blobKey),r.removeAttr("required"),n.attr("disabled",!1),c.attr("disabled",!1),l.removeClass("vis").addClass("n-vis"),p.push(e.fileMeta)):(n.attr("disabled",!0),c.attr("disabled",!0),l.removeClass("n-vis").addClass("vis"))}},at=new function(){var o=this,i="",n=t("#mck-search"),r=t("#mck-msg-to"),c=t(".mck-file-lb"),l=t(".mck-file-sz"),d=t("#mck-sidebox"),m=t("#mck-file-box"),u=t("#mck-msg-sbmt"),g=t("#mck-msg-form"),h=t("#mck-text-box"),T=t("#mck-msg-error"),x=(t("#mck-show-more"),t("#mck-tab-title")),L=t("#mck-tab-status"),A=t("#mck-message-cell"),w=t(".mck-typing-box"),G=(t("#mck-no-messages"),t("#mck-product-box")),U=t(".mck-product-icon"),K=t(".mck-product-title"),N=t(".mck-product-subtitle"),R=t("#mck-product-box .mck-caret"),z=t(".mck-product-rt-up .mck-product-key"),$=t("#mck-contact-search-input-box"),q=t(".mck-product-rt-up .mck-product-value"),j=t(".mck-product-rt-down .mck-product-key"),V=t(".mck-product-rt-down .mck-product-value"),J=(t("#li-mck-group-info"),t("#li-mck-leave-group"),t("#mck-group-info-tab")),Z=t("#mck-group-search-tab"),X=t("#mck-no-search-groups"),ee=t("#mck-group-create-tab"),te=t("#mck-group-search-list"),ae=(t("#mck-group-search-tabview"),t(".mck-group-menu-options")),oe=t(".mck-videocall-btn"),ie=t("#mck-group-search-input"),ce=t("#mck-group-search-input-box"),de=t("#mck-contact-search-list"),me=t("#mck-contacts-content"),pe=t("#mck-contact-search-tab"),ge=(t("#mck-contact-search-tabview"),t("#mck-contact-search-input")),fe=t("#mck-autosuggest-search-input"),ke=t("#mck-autosuggest-metadata"),he=(t("#mck-search-list"),t("#mck-no-search-contacts")),be=t("#mck-search-tab-box li a"),Ee=t("#mck-search-tabview-box"),xe=t("#mck-sidebox-search"),Le=t("#mck-contact-loading"),Ae=t("#mck-typing-label"),Ge=t("#mck-price-widget"),Ue=t("#mck-msg-response"),De=t("#mck_response_text"),Re=t("#li-mck-block-user"),ze=t("#li-mck-video-call"),Be=t("#mck-search-loading"),We=t("#mck-tab-individual"),ct=t("#mck-attachfile-box"),lt=t("#mck-location-sharing-box"),pt=t("#mck-sidebox-content"),ut=t("#mck-tab-option-panel"),vt=t("#mck-tab-conversation"),gt=t("#mck-conversation-header"),ft=(t("#mck-no-conversations"),t("#mck-conversation-list")),kt=t(".mck-tab-message-option"),Ct=t(".mck-box-ft .mck-box-form"),ht=t("#mck-btn-clear-messages"),bt=t("#mck-offline-message-box"),It=t("#mck-message-cell .mck-message-inner"),Mt=(t("#mck-msg-new"),new RegExp(/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi));o.init=function(){t.template("convTemplate",'<li id="li-${convIdExpr}" class="${convIdExpr}"><a class="${mckLauncherExpr}" href="#" data-mck-conversationid="${convIdExpr}" data-mck-id="${tabIdExpr}" data-isgroup="${isGroupExpr}" data-mck-topicid="${topicIdExpr}" data-isconvtab="true"><div class="mck-row mck-truncate" title="${convTitleExpr}">${convTitleExpr}</div></a></li>'),t.template("messageTemplate",'<div name="message" data-msgdelivered="${msgDeliveredExpr}" data-msgsent="${msgSentExpr}" data-msgtype="${msgTypeExpr}" data-msgtime="${msgCreatedAtTime}data-msgcontent="${replyIdExpr}" data-msgkey="${msgKeyExpr}" data-contact="${toExpr}" class="mck-m-b ${msgKeyExpr} ${msgFloatExpr} ${msgAvatorClassExpr}"><div class="mck-clear"><div class="${nameTextExpr} ${showNameExpr} mck-conversation-name"><span class="mck-ol-status ${contOlExpr}"><span class="mck-ol-icon" title="${onlineLabel}"></span>&nbsp;</span>${msgNameExpr}</div><div class="blk-lg-12"><div class="mck-msg-avator blk-lg-3">{{html msgImgExpr}}</div><div class ="km-conversation-container-right"><div class="mck-msg-box ${msgClassExpr}"><div class="move-right mck-msg-text"></div><div class="mck-msg-reply mck-verticalLine ${msgReplyToVisibleExpr}"><div class="mck-msgto">${msgReplyTo} </div></div><div class="mck-msg-reply mck-verticalLine ${msgReplyDivExpr}"><div class="mck-msgreply-border ${textreplyVisExpr}">${msgReply}</div><div class="mck-msgreply-border ${msgpreviewvisExpr}">{{html msgPreview}}</div></div><div class="mck-file-text notranslate mck-attachment downloadimage ${downloadIconVisibleExpr}" data-filemetakey="${fileMetaKeyExpr}"data-filename="${fileNameExpr}" data-fileurl="${fileUrlExpr}" data-filesize="${fileSizeExpr}"><div>{{html fileExpr}}</div> {{html downloadMediaUrlExpr}}</div><div class="mck-msg-text mck-msg-content"></div></div><div class="mck-msg-box-rich-text-container ${kmRichTextMarkupVisibility} ${containerType}"><div class="email-message-indicator ${emailMsgIndicatorExpr}"><span><svg xmlns="http://www.w3.org/2000/svg" width="12" height="11" viewBox="0 0 12 11"><path fill="#BCBABA" fill-rule="nonzero" d="M12 3.64244378L7.82144281 0v2.08065889h-.0112584c-1.2252898.0458706-2.30872368.23590597-3.23022417.58877205-1.03614858.39436807-1.89047392.92952513-2.56710409 1.60169828-.53552482.53356847-.95771502 1.14100649-1.27501442 1.8173497-.08349984.17792235-.16437271.35624185-.23304899.54349718-.32987128.89954044-.56029331 1.87632619-.49311816 2.87991943C.02781163 9.76011309.1572833 10.5.30795828 10.5c0 0 .18801538-1.03695368.94795775-2.22482365.23267371-.36259621.50437656-.70533502.81698495-1.02186205l.0350887.03038182v-.06533086c.19420749-.19301397.40079923-.37828356.63497407-.54588006.63272238-.45433742 1.40748832-.8141536 2.32279668-1.0796471.74962217-.21763716 1.60432278-.34412883 2.54909064-.39019801h.20809286l-.00150112 2.08085746L12 3.64244378z"/></svg></span><span>via email</span></div>{{html kmRichTextMarkup}}</div></div></div><div class="${msgFloatExpr}-muted mck-text-light mck-text-xs mck-t-xs"><span class="mck-created-at-time">${createdAtTimeExpr}</span> <span class="mck-message-status"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 17.06103 10.90199" width="24" height="24" class="${statusIconExpr} mck-message-status"><path fill="#859479" d="M16.89436.53548l-.57-.444a.434.434 0 0 0-.609.076l-6.39 8.2a.38.38 0 0 1-.577.039l-.427-.388a.381.381 0 0 0-.578.038l-.451.576a.5.5 0 0 0 .043.645l1.575 1.51a.38.38 0 0 0 .577-.039l7.483-9.6a.436.436 0 0 0-.076-.609z" class="mck-delivery-report--delivered-read"></path><path fill="#859479" d="M12.00236.53548l-.57-.444a.434.434 0 0 0-.609.076l-6.39 8.2a.38.38 0 0 1-.577.039l-2.614-2.558a.435.435 0 0 0-.614.007l-.505.516a.435.435 0 0 0 .007.614l3.887 3.8a.38.38 0 0 0 .577-.039l7.483-9.6A.435.435 0 0 0 12.00109.536l-.00073-.00052z"  class="mck-delivery-report--sent"></path><path fill="#859479" d="M9.75 7.713H8.244V5.359a.5.5 0 0 0-.5-.5H7.65a.5.5 0 0 0-.5.5v2.947a.5.5 0 0 0 .5.5h.094l.003-.001.003.002h2a.5.5 0 0 0 .5-.5v-.094a.5.5 0 0 0-.5-.5zm0-5.263h-3.5c-1.82 0-3.3 1.48-3.3 3.3v3.5c0 1.82 1.48 3.3 3.3 3.3h3.5c1.82 0 3.3-1.48 3.3-3.3v-3.5c0-1.82-1.48-3.3-3.3-3.3zm2 6.8a2 2 0 0 1-2 2h-3.5a2 2 0 0 1-2-2v-3.5a2 2 0 0 1 2-2h3.5a2 2 0 0 1 2 2v3.5z" class="mck-delivery-report--pending"></path></svg></span></div></div><div class="n-vis mck-context-menu"><ul><li><a class="mck-message-forward ${msgForwardVisibleExpr}">${msgForwardExpr}</a></li><li><a class="mck-message-delete">${msgDeleteExpr}</a></li><li><a class="mck-message-reply">${msgReplyExpr}</a></li></ul></div></div>'),t.template("contactTemplate",'<li id="li-${contHtmlExpr}" class="${contIdExpr}" data-msg-time="${msgCreatedAtTimeExpr}"><a class="${mckLauncherExpr}" href="#" data-mck-conversationid="${conversationExpr}" data-mck-id="${contIdExpr}" data-isgroup="${contTabExpr}"><div class="mck-row" title="${contNameExpr}"><div class="mck-conversation-topic mck-truncate ${contHeaderExpr}">${titleExpr}</div><div class="blk-lg-3">{{html contImgExpr}}<div class="mck-unread-count-box move-right mck-truncate ${contUnreadExpr}"><span class="mck-unread-count-text">{{html contUnreadCount}}</span></div></div><div class="blk-lg-9"><div class="mck-row"><div class="blk-lg-8 mck-cont-name mck-truncate"><div class="mck-ol-status ${contOlExpr}"><span class="mck-ol-icon" title="${onlineLabel}"></span>&nbsp;</div><strong class="mck-truncate">${contNameExpr}</strong></div><div class="mck-text-muted move-right mck-cont-msg-date mck-truncate blk-lg-4">${msgCreatedDateExpr}</div></div><div class="mck-row"><div class="mck-cont-msg-wrapper blk-lg-6 mck-truncate msgTextExpr"></div></div></div></div></a></li>'),t.template("searchContactbox",'<li id="li-${contHtmlExpr}" class="${contIdExpr}"><a class="applozic-launcher" href="#" data-mck-id="${contIdExpr}" data-isgroup="${contTabExpr}"><div class="mck-row" title="${contNameExpr}"><div class="blk-lg-3">{{html contImgExpr}}</div><div class="blk-lg-9"><div class="mck-row"><div class="blk-lg-12 mck-cont-name mck-truncate"><strong>${contNameExpr}</strong><div class="move-right mck-group-count-box mck-group-count-text ${displayGroupUserCountExpr}">${groupUserCountExpr}</div></div><div class="blk-lg-12 mck-text-muted">${contLastSeenExpr}</div></div></div></div></a></li>')},o.openConversation=function(){"none"===d.css("display")&&(t(".mckModal").mckModal("hide"),d.mckModal()),r.focus()},o.initEmojis=function(){try{t("#mck-text-box").emojiarea({button:"#mck-btn-smiley",wysiwyg:!0,menuPosition:"top"})}catch(e){i||(i=setTimeout(function(){o.initEmojis()},3e4))}},o.loadTab=function(e,s){var i=It.data("mck-id");if(i)if(h.html().length>1||m.hasClass("vis")){var n=h.html(),c={text:n,files:[]};m.hasClass("vis")&&t(".mck-file-box").each(function(){var e=t(this),a={filelb:e.find(".mck-file-lb").html(),filesize:e.find(".mck-file-sz").html()},s=e.data("mckfile");"object"==typeof s&&(a.fileMeta=s),c.files.push(a)}),Fe[i]=c}else delete Fe[i];if(f=!0,o.clearMessageField(!1),o.addDraftMessage(e.tabId),T.html(""),T.removeClass("vis").addClass("n-vis"),De.html(""),Ue.removeClass("vis").addClass("n-vis"),g[0].reset(),g.removeClass("n-vis").addClass("vis"),It.html(""),T.removeClass("mck-no-mb"),me.removeClass("n-vis").addClass("vis"),Ct.removeClass("vis").addClass("n-vis"),t("#mck-sidebox-ft").removeClass("vis").addClass("n-vis"),xe.removeClass("vis").addClass("n-vis"),J.removeClass("vis").addClass("n-vis"),ee.removeClass("vis").addClass("n-vis"),pt.removeClass("n-vis").addClass("vis"),G.removeClass("vis").addClass("n-vis"),gt.addClass("n-vis"),Le.removeClass("vis").addClass("n-vis"),It.removeClass("mck-group-inner"),L.removeClass("vis").addClass("n-vis"),x.removeClass("mck-tab-title-w-status"),x.removeClass("mck-tab-title-w-typing"),w.removeClass("vis").addClass("n-vis"),Ae.html(MCK_LABELS.typing),It.data("isgroup",e.isGroup),It.data("datetime",""),e.tabId){if(r.val(e.tabId),It.data("mck-id",e.tabId),It.data("mck-conversationid",e.conversationId),It.data("mck-topicid",e.topicId),ut.data("tabId",e.tabId),ut.removeClass("n-vis").addClass("vis"),me.removeClass("vis").addClass("n-vis"),Ct.removeClass("n-vis").addClass("vis"),t("#mck-sidebox-ft").removeClass("n-vis").addClass("vis"),ht.removeClass("n-vis").addClass("vis"),ae.removeClass("vis").addClass("n-vis"),e.isGroup?(It.addClass("mck-group-inner"),Re.removeClass("vis").addClass("n-vis"),ze.removeClass("vis").addClass("n-vis"),oe.removeClass("vis").addClass("n-vis"),KommunicateUI.activateTypingField()):(Re.removeClass("n-vis").addClass("vis"),ze.removeClass("n-vis").addClass("vis"),P&&oe.removeClass("n-vis").addClass("vis")),!e.topicId&&e.conversationId){var l=M[e.conversationId];"object"==typeof l&&(e.topicId=l.topicId)}if(e.topicId){var d=y[e.topicId];"object"==typeof d&&(_e?(It.data("mck-title",d.title),gt.html(d.title),gt.removeClass("n-vis")):ye&&(o.setProductProperties(d,e.topicId),R.addClass("n-vis"),G.addClass("mck-product-box-wc"),ft.addClass("n-vis"),G.removeClass("n-vis").addClass("vis")))}B&&a.google&&"object"==typeof a.google.maps?(ct.removeClass("vis").addClass("n-vis"),lt.removeClass("n-vis").addClass("vis")):(lt.removeClass("vis").addClass("n-vis"),ct.removeClass("n-vis").addClass("vis"));var p=o.getTabDisplayName(e.tabId,e.isGroup,e.userName);o.isGroupDeleted(e.tabId,e.isGroup)&&(T.html(MCK_LABELS["group.deleted"]),T.removeClass("n-vis").addClass("vis").addClass("mck-no-mb"),g.removeClass("vis").addClass("n-vis")),x.html(p),x.attr("title",p),vt.removeClass("vis").addClass("n-vis"),Ee.removeClass("vis").addClass("n-vis"),We.removeClass("n-vis").addClass("vis"),"support"===S&&t(".mck-tab-link").removeClass("vis").addClass("n-vis"),re&&(Ge.removeClass("n-vis").addClass("vis"),It.addClass("mck-msg-w-panel")),O&&(T.html("Deactivated"),T.removeClass("n-vis").addClass("vis").addClass("mck-no-mb"),g.removeClass("vis").addClass("n-vis"));var u=e.isGroup?e.tabId:Ce;yt.subscibeToTypingChannel(u),"function"==typeof Q&&Q({tabId:e.tabId,isGroup:e.isGroup})}else{e.tabId="",Te&&at.hideOfflineMessage(),We.removeClass("vis").addClass("n-vis"),vt.removeClass("n-vis").addClass("vis"),Ee.removeClass("n-vis").addClass("vis"),G.removeClass("vis").addClass("n-vis"),It.data("mck-id",""),It.data("mck-conversationid",""),It.data("mck-topicid",""),Ge.removeClass("vis").addClass("n-vis"),It.removeClass("mck-msg-w-panel"),ut.removeClass("vis").addClass("n-vis"),ht.removeClass("vis").addClass("n-vis"),r.val("");var v=ALStorage.getLatestMessageArray();if(yt.unsubscibeToTypingChannel(),null!==v&&v.length>0)return e.isReload=!0,at.addContactsFromMessageList({message:v},e),o.openConversation(),void(f=!1)}st.loadMessageList(e,s),o.openConversation()},o.setProductProperties=function(e,t){K.html(e.title),U.html(o.getTopicLink(e.link));var a=e.subtitle?e.subtitle:"";N.html(a);var s=e.key1?e.key1:"",i=e.value1?":"+e.value1:"";z.html(s),q.html(i);var n=e.key2?e.key2:"",r=e.value2?":"+e.value2:"";j.html(n),V.html(r),"function"==typeof H&&(e.topicId=t,H(e))},o.getTopicLink=function(e){return e?'<img src="'+e+'">':'<span class="mck-icon-no-image"></span>'},o.processMessageList=function(e,a,s){var i,n=It.children("div[name='message']:first"),r=It.data("mck-id"),c=It.data("isgroup"),l=c?Xe.getGroup(r):at.fetchContact(r);if(void 0===e.message.length){var d=[];d.push(e.message),ALStorage.updateMckMessageArray(d),o.addMessage(e.message,l,!1,!1,s),i=e.createdAtTime}else ALStorage.updateMckMessageArray(e.message),t.each(e.message,function(e,t){void 0!==t.to&&(o.addMessage(t,l,!1,!1,s),i=t.createdAtTime)});ut.data("datetime",i),!a&&n.length>0?It.scrollTop(n.offset().top-It.offset().top+It.scrollTop()):a&&It.animate({scrollTop:It.prop("scrollHeight")},"slow");var m=document.querySelectorAll(".mck-message-inner.mck-group-inner")[0];m.scrollTop=m.scrollHeight},o.closeConversation=function(e){if("function"==typeof Y){var t=Y();if("object"==typeof t)var a="BUSY_WITH_OTHER"===e?t.onBusyWithOtherUser:t.onConversationClose}a||(a="Chat disabled with user"),T.html(a),T.removeClass("n-vis").addClass("vis").addClass("mck-no-mb"),g.removeClass("vis").addClass("n-vis")},o.addTooltip=function(e){t("."+e+" .mck-pending-icon").attr("title","pending"),t("."+e+" .mck-btn-trash").attr("title","delete"),t("."+e+" .mck-sent-icon").attr("title","sent"),t("."+e+" .mck-btn-forward").attr("title","forward message"),t("."+e+" .mck-delivered-icon").attr("title","delivered"),t("."+e+" .mck-read-icon").attr("title","delivered and read"),t("."+e+" .msgtype-outbox-cr").attr("title","sent via Carrier"),t("."+e+" .msgtype-outbox-mck").attr("title","sent"),t("."+e+" .msgtype-inbox-cr").attr("title","received via Carrier"),t("."+e+" .msgtype-inbox-mck").attr("title","recieved")},o.fetchContact=function(e){var t=o.getContact(e);return void 0===t&&(t=o.createContact(e)),t},o.getContact=function(e){return"object"==typeof v[e]?v[e]:void 0},o.getContactDisplayName=function(e){if("string"==typeof qe[e])return qe[e];if(void 0===qe[e]){var t=b[e];return void 0!==t?t.displayName:void 0}},o.sendUserEmail=function(){if(document.getElementById("input-for-email").value.length>1){var e=document.getElementById("input-for-email").value;ot.updateUser({data:{email:e},success:function(e){console.log("email updated successfully !"),t("#input-for-email").after("<div style='width: 100px; margin: auto;'><span>Email Sent</span></div>"),t("#input-for-email").remove(),t("#send-email-button").remove()},error:function(e){}})}else alert("No email")},o.updateMetadata=function(e,t){var s=a.JSON.stringify({key:e,metadata:t});Je.ajax({type:"POST",url:MCK_BASE_URL+"/rest/ws/message/update/metadata",global:!1,data:s,contentType:"application/json",success:function(e){console.log("metadata cleared successfully !")}})},o.addMessage=function(e,i,n,r,c){var l="",d="",m="",p="vis",u="n-vis",v="",g="n-vis",f="n-vis";if("object"==typeof e.metadata&&void 0!==e.metadata.AL_REPLY&&(l=e.metadata.AL_REPLY,void 0!==(d=nt.getReplyMessageByKey(l))&&((i.isGroup&&d||!i.isGroup&&void 0===d.fileMeta)&&(g="vis"),v=5===d.type?"You":at.getTabDisplayName(d.to,!1),"object"!=typeof d.fileMeta&&2!==d.contentType||(m=o.getImageForReplyMessage(d),p="n-vis",u="vis",g="n-vis"))),6!==e.type&&7!==e.type&&!(e.metadata&&"HIDDEN"===e.metadata.category||102===e.contentType||e.metadata&&(e.metadata.KM_ASSIGN||e.metadata.KM_STATUS)||10===e.contentType&&e.metadata&&"true"===e.metadata.hide||t("#mck-message-cell ."+e.key).length>0)){e.source==MESSAGE_SOURCE.MAIL_INTERCEPTOR&&(f="vis",t(".email-conversation-indicator").addClass("vis").removeClass("n-vis"));var k=e.contentType==MESSAGE_CONTENT_TYPE.TEXT_HTML&&e.source==MESSAGE_SOURCE.MAIL_INTERCEPTOR||e.contentType==MESSAGE_CONTENT_TYPE.DEFAULT&&"string"!=typeof e.message?"n-vis":"vis",C="mck-msg-right",b="mck-pending-icon";0!==e.type&&4!==e.type&&6!==e.type||(C="mck-msg-left"),4!==e.contentType&&10!==e.contentType&&103!==e.contentType||(C="mck-msg-center"),b=o.getStatusIconName(e);var I=e.key,T="'"+e.deviceKey+"','"+e.to+"','"+e.to+"','"+I+"'",E="",x="",S="",L="n-vis",A="";if(dt.loadUserProfile(e.to),!e.groupId||4===e.contentType||7===i.type||0!==e.type&&4!==e.type&&6!==e.type||(E=o.getTabDisplayName(e.to,!1),L="vis",S=o.getNameTextClassByAlphabet(E)),Me){A="mck-msg-avator-bubble";var _="",w=E;"mck-msg-right"===C?(_=at.fetchContact(Ce),w=o.getTabDisplayName(_.displayName,!1)):"mck-msg-left"===C&&(_=e.groupId?at.fetchContact(e.to):i),_&&(x=o.getContactImageLink(_,w))}e.groupId&&10===e.contentType&&(E="",x="",S="");var G="n-vis",U="",K="",N=e.message;"object"==typeof e.fileMeta&&(U=e.fileMeta.name,K=e.fileMeta.size),"object"==typeof e.fileMeta&&(e.fileMeta.contentType.indexOf("audio")||e.fileMeta.contentType.indexOf("image")||e.fileMeta.contentType.indexOf("video"))&&(G="vis");var O="n-vis";Ie&&a.MCK_OL_MAP[e.to]&&10!==e.contentType&&(O="vis");var D=Kommunicate.isRichTextMessage(e.metadata)||3==e.contentType,R=D?"vis":"n-vis",z=D?Kommunicate.getRichTextMessageTemplate(e):"",B=Kommunicate.getContainerTypeForRichMessage(e),P=[{msgReply:d?d.message+"\n":"",msgReplyTo:d?v+"\n":"",msgReplyDivExpr:d?"vis":"n-vis",msgReplyToVisibleExpr:g,msgPreview:m?o.getImageForReplyMessage(d):"",msgpreviewvisExpr:u,textreplyVisExpr:p,msgKeyExpr:e.key,msgDeliveredExpr:e.delivered,msgSentExpr:e.sent,msgCreatedAtTime:e.createdAtTime,msgTypeExpr:e.type,msgDeleteExpr:MCK_LABELS.delete,msgReplyExpr:MCK_LABELS.reply,msgForwardExpr:MCK_LABELS.forward,msgForwardVisibleExpr:"kommunicate"==window.applozic.PRODUCT_ID?"n-vis":"vis",msgSourceExpr:e.source,statusIconExpr:b,contactExpr:"vis",toExpr:e.to,msgAvatorClassExpr:A,showNameExpr:L,msgNameExpr:E,msgImgExpr:x,nameTextExpr:S,msgFloatExpr:C,replyIdExpr:I,createdAtTimeExpr:mckDateUtils.getDate(e.createdAtTime),msgFeatExpr:"n-vis",replyMessageParametersExpr:T,downloadMediaUrlExpr:rt.getFileAttachment(e),msgClassExpr:k,msgExpr:N,selfDestructTimeExpr:e.timeToLive,fileMetaKeyExpr:e.fileMetaKey,downloadIconVisibleExpr:G,fileExpr:at.getFilePath(e),fileUrlExpr:rt.getFileurl(e),fileNameExpr:U,fileSizeExpr:K,contOlExpr:O,kmRichTextMarkupVisibility:R,kmRichTextMarkup:z,containerType:B,emailMsgIndicatorExpr:f}];if(n?t.tmpl("messageTemplate",P).appendTo("#mck-message-cell .mck-message-inner"):t.tmpl("messageTemplate",P).prependTo("#mck-message-cell .mck-message-inner"),(!e.metadata.obsolete||"true"!=e.metadata.obsolete)&&e.metadata.KM_AUTO_SUGGESTION){var $={};try{$=JSON.parse(e.metadata.KM_AUTO_SUGGESTION)}catch(e){console.error("suggestionList should be an array")}fe.addClass("mck-text-box").removeClass("n-vis"),h.removeClass("mck-text-box").addClass("n-vis"),fe.attr("placeholder",$.placeholder?$.placeholder:""),fe.data("prev-msgkey",e.key),$.source.constructor==Array?(fe.data("origin","KM_AUTO_SUGGEST"),$.source.length&&at.populateAutoSuggest({source:$.source})):"object"==typeof $.source&&(fe.data("source-url",$.source.url),fe.data("method",$.source.method?$.source.method:"get"),fe.data("headers",$.source.headers?$.source.headers:{}))}if(23===e.contentType){if("BUTTON"===e.metadata.msg_type){var F=[];if(e.metadata.payload){if(!(F=t.parseJSON(e.metadata.payload))[0].hidden)var q="<div style='width: 100px; margin: auto;'><button style='height: 27px;color: #FFF;background-color: #000;border-radius: 10px; width: 100px; margin: 10px;'>"+F[0].title+"</button></div>";if(F.length>1)for(var H=1;H<F.length;H++)F[H].hidden||(q+="<div style='width: 100px; margin: auto;'><button style='height: 27px;color: #FFF;background-color: #000;border-radius: 10px; width: 100px; margin: 10px;'>"+F[H].title+"</button></div>");t("div[data-msgkey='"+e.key+"'] .blk-lg-12").after(q)}else{console.log("msg.contentType === 23 && metadata.msg_type === BUTTON");var q="<div style='width: 100px; margin: auto;'><button style='height: 27px;color: #FFF;background-color: #000;border-radius: 10px; width: 100px; margin: 10px;'>Button</button></div>";t("div[data-msgkey='"+e.key+"'] .blk-lg-12").after(q)}}if("INPUT"===e.metadata.msg_type&&"false"===e.metadata.hidden){console.log("msg.contentType === 23 && metadata.msg_type === INPUT");var q="<div style='float: left; margin: 13px; width: 100%'><input id='input-for-email' type='text' style='background-color: #FFF;width: 60%;height:35px;' placeholder='Enter your email...'/>";q+="<button id='send-email-button' style='height: 27px; width: 11%;color: #FFF;background-color: #000;border-radius: 0 10px 10px 0;'>Submit</button></div>",t("div[data-msgkey='"+e.key+"'] .blk-lg-12").after(q),t("#send-email-button").click(function(){document.getElementById("input-for-email").value.length>1&&(o.sendUserEmail(),o.updateMetadata(e.key,{hidden:"true"}))})}if("LIST"===e.metadata.msg_type){var F=[];if(e.metadata.payload){F=t.parseJSON(e.metadata.payload),console.log("msg.contentType === 23 && metadata.msg_type === LIST");var q="";if(F[0].hidden||("button"===F[0].type.toLowerCase()?q="<div style='width: 100px; margin: auto;'><button style='height: 27px;color: #FFF;background-color: #000;border-radius: 10px; width: 100px; margin: 10px;'>"+F[0].title+"</button></div>":"input"===F[0].type.toLowerCase()&&(q="<div style='float: left; margin: 13px; width: 100%'><input type='text' style='background-color: #FFF;width: 60%;height:35px;' placeholder='Enter your email...'/>",q+="<button style='height: 27px; width: 11%;color: #FFF;background-color: #000;border-radius: 0 10px 10px 0;'>"+F[0].title+"</button></div>")),F.length>1)for(var H=1;H<F.length;H++)F[H].hidden||("button"===F[H].type.toLowerCase()?q+="<div style='width: 100px; margin: auto;'><button style='height: 27px;color: #FFF;background-color: #000;border-radius: 10px; width: 100px; margin: 10px;'>"+F[H].title+"</button></div>":"input"===F[H].type.toLowerCase()&&(q+="<div style='float: left; margin: 13px; width: 100%'><input type='text' style='background-color: #FFF;width: 60%;height:35px;' placeholder='Enter your email...'/>",q+="<button style='height: 27px; width: 11%;color: #FFF;background-color: #000;border-radius: 0 10px 10px 0;'>"+F[H].title+"</button></div>"));t("div[data-msgkey='"+e.key+"'] .blk-lg-12").after(q)}}}var j="";if(e.message){var V=e.message.replace(/\n/g,"<br/>");null!==a.emoji&&void 0!==a.emoji?(j=a.emoji.replace_unified(V),j=a.emoji.replace_colons(j)):j=V}if(e.conversationId){var Y=M[e.conversationId];if("object"!=typeof Y&&nt.getTopicId({conversationId:e.conversationId},function(e){at.populateMessage(e.messageType,e.message,e.notifyUser)}),n&&(It.data("mck-conversationid",e.conversationId),Y)){var J=y[Y.topicId];"object"==typeof J&&(ye?o.setProductProperties(J,Y.topicId):_e&&gt.html(J.title))}}if(4===e.contentType){var W=j;j="Final agreed price: "+j,re||(j+='<br/><button class="mck-accept" data-mck-topic-price="'+W+'" data-mck-conversationid="'+e.conversationId+'">Accept</button>')}var Z=t("."+I+" .mck-msg-content");if(-1===j.indexOf("emoji-inner")&&0===e.contentType)for(var Q=j.split("<br/>"),H=0;H<Q.length;H++){if(""===Q[H])var X=s.createElement("BR");else{var X=s.createElement("div");X.appendChild(s.createTextNode(Q[H])),Q[H]&&Q[H].match(Mt)&&(X=t(X).linkify({target:"_blank"}))}Z.append(X)}else Z.html(j),Z.linkify({target:"_blank"});D&&Kommunicate.richMsgEventHandler.initializeSlick(t("div[data-msgkey='"+e.key+"'] .km-div-slider")),e.fileMeta&&(t("."+I+" .mck-file-text a:first").trigger("click"),t("."+I+" .mck-file-text").removeClass("n-vis").addClass("vis"),""===Z.html()&&Z.removeClass("vis").addClass("n-vis")),2===e.contentType&&(Z.removeClass("vis").addClass("n-vis"),t("."+I+" .mck-file-text").removeClass("n-vis").addClass("vis")),r&&It.animate({scrollTop:It.prop("scrollHeight")},"slow");var ee=document.querySelectorAll(".mck-message-inner.mck-group-inner")[0];if(ee.scrollTop=ee.scrollHeight,kt.hasClass("n-vis"))if(e.groupId){var te=Xe.getGroup(e.groupId);6!==te.type&&kt.removeClass("n-vis").addClass("vis")}else kt.removeClass("n-vis").addClass("vis");o.addTooltip(e.key),4!==e.contentType&&10!==e.contentType&&c&&o.messageContextMenu(e.key),e.groupId&&10===e.contentType&&n&&Qe.getGroupFeed({groupId:e.groupId,isReloadTab:!0,apzCallback:et.onGroupFeed})}},o.addContactForSearchList=function(e,s){var i=e.userCount,n=e.isGroup,r=o.getTabDisplayName(e.contactId,n),c=o.getContactImageLink(e,r),l=(n?e.contactId:e.contactId,n?"gs-group-"+e.htmlId:"cs-user-"+e.htmlId),d="",m=n&&Se;t("#li-"+l+" .mck-group-count-text").html(i),n||k[e.contactId]||(a.MCK_OL_MAP[e.contactId]?d=MCK_LABELS.online:I[e.contactId]&&(d=mckDateUtils.getLastSeenAtStatus(I[e.contactId])));var p=[{contHtmlExpr:l,contIdExpr:e.contactId,contTabExpr:e.isGroup,contImgExpr:c,contLastSeenExpr:d,contNameExpr:r,groupUserCountExpr:e.userCount,displayGroupUserCountExpr:m?"vis":"n-vis"}];t.tmpl("searchContactbox",p).prependTo("#"+s)},o.getFilePath=function(e){if(2===e.contentType)try{var a=t.parseJSON(e.message);if(a.lat&&a.lon)return'<a href="http://maps.google.com/maps?z=17&t=m&q=loc:'+a.lat+","+a.lon+'" target="_blank"><img src="https://maps.googleapis.com/maps/api/staticmap?zoom=17&size=200x150&center='+a.lat+","+a.lon+"&maptype=roadmap&markers=color:red|"+a.lat+","+a.lon+"&key="+ue+'"/></a>'}catch(t){if(-1!==e.message.indexOf(","))return'<a href="http://maps.google.com/maps?z=17&t=m&q=loc:'+e.message+'" target="_blank"><img src="https://maps.googleapis.com/maps/api/staticmap?zoom=17&size=200x150&center='+e.message+"&maptype=roadmap&markers=color:red|"+e.message+"&key="+ue+'" /></a>'}return"object"==typeof e.fileMeta?-1!==e.fileMeta.contentType.indexOf("image")?-1!==e.fileMeta.contentType.indexOf("svg")?'<a href="#" target="_self"  role="link" class="file-preview-link fancybox-media fancybox" data-type="'+e.fileMeta.contentType+'" data-url="'+rt.getFileurl(e)+'" data-name="'+e.fileMeta.name+'"><img src="'+F+"/rest/ws/aws/file/"+e.fileMeta.blobKey+'" area-hidden="true"></img></a>':5===e.contentType?'<a href="#" target="_self"  role="link" class="file-preview-link fancybox-media fancybox" data-type="'+e.fileMeta.contentType+'" data-url="'+e.fileMeta.blobKey+'" data-name="'+e.fileMeta.name+'"><img src="'+e.fileMeta.blobKey+'" area-hidden="true"></img></a>':e.fileMeta.hasOwnProperty("url")?e.fileMeta.hasOwnProperty("thumbnailBlobKey")?'<a href="#" target="_self"  role="link" class="file-preview-link fancybox-media fancybox" data-type="'+e.fileMeta.contentType+'" data-url="'+o.cloudupdate(e.fileMeta.BlobKey)+'" data-name="'+e.fileMeta.name+'"><img src="'+o.cloudupdate(e.fileMeta.thumbnailBlobKey)+'" area-hidden="true" ></img></a>':'<a href="#" target="_self"  role="link" class="file-preview-link fancybox-media fancybox" data-type="'+e.fileMeta.contentType+'" data-url="'+rt.getFileurl(e)+'" data-name="'+e.fileMeta.name+'"><img src="'+e.fileMeta.thumbnailUrl+'" area-hidden="true" ></img></a>':e.fileMeta.thumbnailUrl==="thumbnail_"+e.fileMeta.name?'<a href="#" target="_self"  role="link" class="file-preview-link fancybox-media fancybox" data-type="'+e.fileMeta.contentType+'" data-url="'+rt.getFileurl(e)+'" data-name="'+e.fileMeta.name+'"><img src="'+_+"/files/thumbnail_"+e.fileMeta.name+'" area-hidden="true" ></img></a>':'<a href="#" target="_self"  role="link" class="file-preview-link fancybox-media fancybox" data-type="'+e.fileMeta.contentType+'" data-url="'+rt.getFileurl(e)+'" data-name="'+e.fileMeta.name+'"><img src="'+e.fileMeta.thumbnailUrl+'" area-hidden="true" ></img></a>':-1!==e.fileMeta.contentType.indexOf("video")?'<a href= "#" target="_self"  ><video controls class="mck-video-player"><source src="'+rt.getFileurl(e)+'" type="video/mp4"><source src="'+rt.getFileurl(e)+'" type="video/ogg"></video></a>':-1!==e.fileMeta.contentType.indexOf("audio")?'<a href="#" target="_self" ><audio controls class="mck-audio-player"><source src="'+rt.getFileurl(e)+'" type="audio/ogg"><source src="'+rt.getFileurl(e)+'" type="audio/mpeg"></audio><p class="mck-file-tag"></p></a>':'<a href="#" role="link" class="file-preview-link" target="_blank"></a>':""},o.getImageForMessagePreview=function(e){if("object"==typeof e.fileMeta)return-1!==e.fileMeta.contentType.indexOf("image")?'<span>photo</span> <img src="'+F+"/rest/ws/aws/file/"+e.fileMeta.blobKey+'" class="mck-image-reply move-right"/>':-1!==e.fileMeta.contentType.indexOf("audio")?'<span>audio</span><span class="mck-file-detail move-right"><span class="mck-file-name"><span class="mck-icon-attachment"></span>&nbsp;'+e.fileMeta.name+'</span>&nbsp;<span class="file-size">'+rt.getFilePreviewSize(e.fileMeta.size)+"</span></span>":'<span class="mck-file-detail move-right"><span class="mck-file-name"><span class="mck-icon-attachment"></span>&nbsp;'+e.fileMeta.name+'</span>&nbsp;<span class="file-size">'+rt.getFilePreviewSize(e.fileMeta.size)+"</span></span>";if(2===e.contentType){var a=t.parseJSON(e.message);return'<span>location</span><img src="https://maps.googleapis.com/maps/api/staticmap?zoom=17&size=200x150&center='+a.lat+","+a.lon+"&maptype=roadmap&markers=color:red|"+a.lat+","+a.lon+'" class="mck-image-reply move-right"/>'}},o.getImageForReplyMessage=function(e){var a=at.getTabDisplayName(e.to,!1);if("object"==typeof e.fileMeta)return-1!==e.fileMeta.contentType.indexOf("image")?'<div><div class="mck-imagereply mck-margin"><div class="mck-msgto">'+a+'</div><div><span class="mck-icon-camera mck-camera"></span><span>Photo</span></div></div><div class="mck-imagereply"><img src="'+rt.getFileurl(e)+'" class="mck-image-reply mck-msg-text mck-msg-content"/></div></div>':-1!==e.fileMeta.contentType.indexOf("audio")?'<div class="mck-attachmentmsgto">'+a+'</div><span class="mck-file-detail mck-msg-text mck-msg-content"><span class="mck-file-name"><span class="mck-icon-attachment"></span>&nbsp;'+e.fileMeta.name+'</span>&nbsp;<span class="file-size">'+rt.getFilePreviewSize(e.fileMeta.size)+"</span></span>":'<div class="mck-attachmentmsgto">'+a+'</div><span class="mck-file-detail"><span class="mck-file-name"><span class="mck-icon-attachment"></span>&nbsp;'+e.fileMeta.name+'</span>&nbsp;<span class="file-size">'+rt.getFilePreviewSize(e.fileMeta.size)+"</span></span>";if(2===e.contentType){var s=t.parseJSON(e.message);return'<div><div class="mck-imagereply mck-margin"><div class="mck-msgto">'+a+'</div><span class="mck-icon-marker mck-location-icon"></span><span>Location</span></div><div class="mck-imagereply"><img src="https://maps.googleapis.com/maps/api/staticmap?zoom=17&size=200x150&center='+s.lat+","+s.lon+"&maptype=roadmap&markers=color:red|"+s.lat+","+s.lon+'" class="mck-image-reply mck-msg-text "/></div></div>'}},o.getImageUrlForGroupType=function(e,t){return e.imageUrl?'<img src="'+e.imageUrl+'"/>':o.getContactImageByAlphabet(t)},o.getContactImageLink=function(e,t){var a="";if(e.members&&10==e.type)a=o.getImageUrlForGroupType(e,t);else if(e.isGroup&&7!==e.type)a=Qe.getGroupImage(e.imageUrl);else{if(e.isGroup&&7===e.type&&e.members.length>1&&Qe.getContactFromGroupOfTwo(e,function(t){e=at.fetchContact(t)}),"function"==typeof ne){var s=ne(e.contactId);s&&void 0!==s&&(a='<img src="'+s+'"/>')}a||(e.photoSrc?a='<img src="'+e.photoSrc+'"/>':e.photoData?a='<img src="data:image/jpeg;base64,'+e.photoData+'"/>':e.photoLink?a='<img src="'+MCK_BASE_URL+"/contact.image?photoLink="+e.photoLink+'"/>':"bot"==e.contactId?a='<img src="https://api.kommunicate.io/img/logo02.svg"/>':(t||(t=e.displayName),a=o.getContactImageByAlphabet(t)))}return a},o.getContactImageByAlphabet=function(e){if(void 0===e||""===e)return'<div class="mck-alpha-contact-image mck-alpha-user"><span class="mck-icon-user"></span></div>';var t=e.charAt(0);return t.match(/^[a-zA-Z0-9]+$/)?'<div class="mck-videocall-image alpha_'+(t=t.toUpperCase())+'"><span class="mck-contact-icon">'+t+"</span></div>":'<div class="mck-videocall-image alpha_user"><span class="mck-icon-user"></span></div>'},o.getNameTextClassByAlphabet=function(e){if(void 0===e||""===e)return"mck-text-user";var t=(e=e.toString()).charAt(0);return t.match(/^[a-zA-Z0-9]+$/)?"mck-text-"+(t=t.toLowerCase()):"mck-text-user"},o.addContactsFromMessageList=function(e,a){var s;if(e+""!="null"){if(0==It.has(t("#mck-contact-list")).length&&It.html('<ul id="mck-contact-list" class="mck-contact-list mck-nav mck-nav-tabs mck-nav-stacked"></ul>'),void 0===e.message.length?(e.message.groupId?Qe.addGroupFromMessage(e.message,!1,function(e,t,a){o.updateRecentConversationList(e,t,a)}):o.addContactsFromMessage(e.message),s=e.message.createdAtTime):t.each(e.message,function(e,t){void 0!==t.to&&(t.groupId?Qe.addGroupFromMessage(t,!0,function(e,t,a){o.updateRecentConversationList(e,t,a)}):o.addContactsFromMessage(t,!0),s=t.createdAtTime)}),It.data("datetime",s),a.isReload){var i="";if(a.lastActiveTabId){var n=a.isLastActiveTabGroup?"group-"+a.lastActiveTabId:"user-"+mckContactUtils.formatContactId(a.lastActiveTabId);i=t("#li-"+n)}i.length>0?It.animate({scrollTop:i.offset().top-It.offset().top+It.scrollTop()},"fast"):It.animate({scrollTop:0},0)}}else s=""},o.addGroupFromMessageList=function(e,a){e+""!="null"&&(a&&It.html('<ul id="mck-group-list" class="mck-contact-list mck-nav mck-nav-tabs mck-nav-stacked"></ul>'),void 0===e.message.length?Qe.addGroupFromMessage(e.message,!1,function(e,t,a){o.updateRecentConversationList(e,t,a)}):t.each(e.message,function(e,t){void 0!==t.to&&Qe.addGroupFromMessage(t,!0,function(e,t,a){o.updateRecentConversationList(e,t,a)})}))},o.createContact=function(e){var t=o.getContactDisplayName(e);void 0===t&&(t=e);var a={contactId:e,htmlId:mckContactUtils.formatContactId(e),displayName:t,name:t+" <"+e+"> [Main]",value:e,photoLink:"",photoSrc:"",photoData:"",email:"",unsaved:!0,isGroup:!1};return v[e]=a,a},o.createContactWithDetail=function(e){var t=e.displayName,a=e.userId;t||(t=o.getContactDisplayName(a)),void 0===t?t=a:qe[a]=t;var s=e.photoLink?e.photoLink:"";s||(s=e.imageLink?e.imageLink:"");var i=e.imageData?e.imageData:"",n={contactId:a,htmlId:mckContactUtils.formatContactId(a),displayName:t,name:t+" <"+a+"> [Main]",value:a,photoLink:"",photoSrc:s,photoData:i,email:"",unsaved:!0,isGroup:!1,roleType:e.roleType};return v[a]=n,n},o.updateContactDetail=function(e,t){var a=t.displayName,s=t.userId;e.displayName&&e.displayName!==e.contactId||(a||(a=o.getContactDisplayName(s)),void 0===a?a=s:qe[s]=a,e.displayName=a);var i=t.photoLink;i||(i=t.imageLink?t.imageLink:""),i&&!e.photoSrc&&(e.photoSrc=i);var n=t.imageData?t.imageData:"";return n&&!e.photoData&&(e.photoData=n),t.roleType&&(e.roleType=t.roleType),v[s]=e,e},o.addContactsFromMessage=function(e,t){var a=o.getUserIdFromMessage(e);if(a.length>0&&a[0])for(var s=0;s<a.length;s++){var i=o.fetchContact(""+a[s]);o.updateRecentConversationList(i,e,t)}},o.updateRecentConversationList=function(e,a,s){var i="mck-contact-list",n=e.isGroup?"group-"+e.htmlId:"user-"+e.htmlId;if(t("#"+i+" #li-"+n).length>0){var r=t("#"+i+" #li-"+e.htmlId+" .mck-cont-msg-wrapper");(r.is(":empty")||s)&&void 0!==a&&o.updateContact(e,a,i)}else o.addContact(e,i,a)},o.addContactsToSearchList=function(){var e=[],a=[];if(t.each($e,function(e,t){a.push(t.contactId)}),"undefined"!=typeof contactList){var s={async:!1};s.userIds=contactList,ot.getUsersDetail(s.userIds,s),a=contactList}var i=a.filter(function(e,t){return a.indexOf(e)===t});i.sort(),Be.removeClass("vis").addClass("n-vis"),i.length>0?t.each(i,function(a,s){if(s){var i=o.fetchContact(""+s);e.push(i),0===t("#li-cs-user-"+i.htmlId).length&&o.addContactForSearchList(i,"mck-contact-search-list")}}):he.removeClass("n-vis").addClass("vis"),o.initAutoSuggest({contactsArray:e,$searchId:ge,isContactSearch:!0})},o.populateAutoSuggest=function(t){fe.mcktypeahead({order:"desc",hint:!1,minLength:3,wrapper:".mck-sidebox",backdropOnFocus:!0,menu:'<ul class="mcktypeahead mck-auto-suggest-menu mck-dropup-menu"></ul>',show:function(){var t=e.extend({},this.$element.offset(),{height:this.$element[0].offsetHeight});return this.$menu.css({left:t.left}),this.$menu.show(),this.shown=!0,this},source:t&&t.source?o.processAutosuggestData(t.source):function(e,a){Je.ajax({url:t.sourceUrl+e,type:t.method,header:t.headers,success:function(e){var t=o.processAutosuggestData(e.data);a(t)}})},items:8,updater:function(e){var t=JSON.parse(e);return 0!=Object.keys(t.metadata).length&&ke.val(JSON.stringify(t.metadata)),h.text(t.displayMessage),t.displayMessage},matcher:function(e){var t=new RegExp(this.query,"i");return t.test(e.searchKey)},highlighter:function(e){var t=JSON.parse(e.toString());return t.displayMessage}})},o.processAutosuggestData=function(e){var t=new Array;return e.map(function(e){var a="string"==typeof e?{searchKey:e,message:e,metadata:{}}:e,s={searchKey:a.searchKey,toString:function(){var e={displayMessage:a.message,metadata:a.metadata?a.metadata:{}};return JSON.stringify(e)},toLowerCase:function(){return a.searchKey.toLowerCase()},indexOf:function(e){return String.prototype.indexOf.apply(a.searchKey,arguments)},replace:function(e){var t=a.searchKey;return String.prototype.replace.apply('<div style="padding: 10px; font-size: 1.5em;">'+t+"</div>",arguments)}};t.push(s)}),t},o.initAutoSuggest=function(e){for(var a,s=e.contactsArray,i=e.$searchId,n=[],r={},c=[],l=0;l<s.length;l++){var d=s[l];d.displayName=o.getTabDisplayName(d.contactId,d.isGroup),a=d.displayName?t.trim(d.displayName):t.trim(d.contactId),(!0===MCK_SELF_CHAT_DISABLE&&d.contactId!==Ce||!0!==MCK_SELF_CHAT_DISABLE)&&(r[a]=d,n.push(a),c.push(a))}var m=function(e){var t=r[e],a=t.displayName.split(" "),s=a.length,o=a[0],i="",n="";2===s?n=a[1]:s>=3&&(n=a[s-1],i=a[s-2]);var c=new RegExp(this.query,"i");return c.test(t.displayName)||c.test(t.contactId)||c.test(i)||c.test(n)||c.test(t.email)||c.test(o+" "+n)},p=function(e){var t=r[e];return t.displayName},u=function(a){var s=r[a];e.isContactSearch?(at.loadTab({tabId:s.contactId,isGroup:s.isGroup}),Ct.removeClass("n-vis").addClass("vis"),t("#mck-sidebox-ft").removeClass("n-vis").addClass("n-vis")):et.addGroupMemberFromSearch(s.contactId)};if(i.hasClass("mck-typeahead"))return i.mcktypeahead().data("mcktypeahead").source=n,i.mcktypeahead().data("mcktypeahead").matcher=m,i.mcktypeahead().data("mcktypeahead").highlighter=p,void(i.mcktypeahead().data("mcktypeahead").updater=u);i.addClass("mck-typeahead"),i.mcktypeahead({source:n,matcher:m,highlighter:p,updater:u})},o.initSearchAutoType=function(){Ke&&(ge.keypress(function(e){if(13===e.which){var t=ge.val();t&&(!0===MCK_SELF_CHAT_DISABLE&&t!==Ce||!0!==MCK_SELF_CHAT_DISABLE)&&(t=void 0!==t&&""!==t?t.toString():"")&&(at.loadTab({tabId:t,isGroup:!1,isSearch:!0}),Ct.removeClass("n-vis").addClass("vis")),ge.val("")}}),ie.keypress(function(e){if(13===e.which)return!0}),t(s).on("click",".mck-group-search-link",function(e){return e.preventDefault(),!0}),t(s).on("click",".mck-contact-search-link",function(e){e.preventDefault();var a=ge.val();""!==a&&(!0===MCK_SELF_CHAT_DISABLE&&a!==Ce||!0!==MCK_SELF_CHAT_DISABLE)&&(at.loadTab({tabId:a,isGroup:!1,isSearch:!0}),Ct.removeClass("n-vis").addClass("vis"),t("#mck-sidebox-ft").removeClass("n-vis").addClass("vis")),ge.val("")}))},o.removeContact=function(e){var a=e.isGroup?"group-"+e.htmlId:"user-"+e.htmlId;t("#li-"+a).remove()},o.updateContact=function(e,a,s){var i=e.isGroup?"group-"+e.htmlId:"user-"+e.htmlId,n=t("#li-"+i),r=n.data("msg-time");if((!a.metadata||!a.metadata.action)&&a&&a.createdAtTime>r){var c=a.groupId?"group_"+e.contactId:"user_"+e.contactId,l=o.getUnreadCount(c),d=o.getMessageTextForContactPreview(a,e,200);t("#li-"+i+" .mck-cont-msg-date").html(void 0===a.createdAtTime?"":mckDateUtils.getTimeOrDate(a?a.createdAtTime:"",!0));var m=t("#li-"+i+" .mck-cont-msg-wrapper");if(m.html(""),"object"==typeof d?m.append(d):m.html(d),a.conversationId){var p=a.conversationId,u=M[p];if("object"==typeof u){var v=u.topicId;if(v&&_e){var g=y[v];"object"==typeof g&&t("#li-"+i+" .mck-conversation-topic").html(g.title)}}t("#li-"+i+" a").data("mck-conversationid",p)}l>0&&(t("#li-"+i+" .mck-unread-count-text").html(l),t("#li-"+i+" .mck-unread-count-box").removeClass("n-vis").addClass("vis"));var f=t("#"+s+" li:nth-child(1)").data("msg-time");n.data("msg-time",a.createdAtTime),(void 0===f||(a?a.createdAtTime:"")>=f)&&0!==t("#mck-contact-list li").index(n)&&t("#"+s+" li:nth-child(1)").before(n)}},o.clearContactMessageData=function(e,a){var s=mckContactUtils.formatContactId(e),o=a?"group-"+s:"user-"+s;t("#li-"+o+" .mck-cont-msg-date").html(""),t("#li-"+o+" .mck-cont-msg-wrapper").html("")},o.addContact=function(e,s,i){var n=o.getMessageTextForContactPreview(i,e,100),r=e.userCount,c="",l=!1;if(void 0!==i){if(i.conversationId){c=i.conversationId;var d=M[c]}i.groupId&&(l=!0)}var m=o.getTabDisplayName(e.contactId,l),p=o.getContactImageLink(e,m),u=!1,v=l?"group_"+e.contactId:"user_"+e.contactId,g=o.getUnreadCount(v),f=g>0&&"mck-search-list"!==s?"vis":"n-vis",h="n-vis",b=l?"group-"+e.htmlId:"user-"+e.htmlId,I=l&&Se;if(t("#li-"+b+" .mck-group-count-text").html(r),t("#li-"+b+" .mck-group-count-box").removeClass("n-vis").addClass("vis"),l||k[e.contactId]||C[e.contactId]||!Ie||!a.MCK_OL_MAP[e.contactId]||(h="vis",u=!0),7===e.type&&e.members.length>1){var T,E=Xe.getGroup(i.groupId);Qe.getContactFromGroupOfTwo(E,function(e){T=at.fetchContact(e)}),l&&Ie&&a.MCK_OL_MAP[T.contactId]&&(h="vis",u=!0)}var x="n-vis";if("object"==typeof d&&_e){var S=y[d.topicId];if("object"==typeof S){x="vis";var L=S.title}}var b=l?"group-"+e.htmlId:"user-"+e.htmlId,A=[{contHtmlExpr:b,contIdExpr:e.contactId,contTabExpr:l,msgCreatedAtTimeExpr:i?i.createdAtTime:"",mckLauncherExpr:D,contImgExpr:p,contOlExpr:h,onlineLabel:MCK_LABELS.online,contUnreadExpr:f,contUnreadCount:g,contNameExpr:m,conversationExpr:c,contHeaderExpr:x,titleExpr:L,groupUserCountExpr:l?e.userCount:"",displayGroupUserCountExpr:I?"vis":"n-vis",msgCreatedDateExpr:i?mckDateUtils.getTimeOrDate(i.createdAtTime,!0):""}],_=t("#"+s+" li:nth-child(1)").data("msg-time");void 0===_||(i?i.createdAtTime:"")>=_||-1!==s.indexOf("search")&&u?t.tmpl("contactTemplate",A).prependTo("#"+s):t.tmpl("contactTemplate",A).appendTo("#"+s);var w=t("#li-"+b+" .msgTextExpr");"object"==typeof n?w.append(n):w.html(n)},o.addContactsToContactSearchList=function(){he.removeClass("vis").addClass("n-vis"),X.removeClass("vis").addClass("n-vis"),pe.hasClass("active")||(be.removeClass("active"),pe.addClass("active")),te.removeClass("vis").addClass("n-vis"),de.removeClass("n-vis").addClass("vis"),ce.removeClass("vis").addClass("n-vis"),$.removeClass("n-vis").addClass("vis"),de.html(""),me.removeClass("vis").addClass("n-vis"),pt.removeClass("vis").addClass("n-vis"),J.removeClass("vis").addClass("n-vis"),ee.removeClass("vis").addClass("n-vis"),xe.removeClass("n-vis").addClass("vis"),Be.removeClass("n-vis").addClass("vis"),0!==$e.length?at.addContactsToSearchList():we?(Be.removeClass("vis").addClass("n-vis"),he.removeClass("n-vis").addClass("vis")):ot.loadContacts(),ge.focus()},o.addGroupsToGroupSearchList=function(){var e=[],a=[];if(he.removeClass("vis").addClass("n-vis"),X.removeClass("vis").addClass("n-vis"),Z.hasClass("active")||(be.removeClass("active"),Z.addClass("active")),de.removeClass("vis").addClass("n-vis"),te.removeClass("n-vis").addClass("vis"),$.removeClass("vis").addClass("n-vis"),ce.removeClass("n-vis").addClass("vis"),te.html(""),me.removeClass("vis").addClass("n-vis"),pt.removeClass("vis").addClass("n-vis"),J.removeClass("vis").addClass("n-vis"),ee.removeClass("vis").addClass("n-vis"),xe.removeClass("n-vis").addClass("vis"),Be.removeClass("n-vis").addClass("vis"),Pe.length>0){t.each(Pe,function(e,t){a.push(t.contactId)});var s=a.filter(function(e,t){return a.indexOf(e)===t});s.sort(),t.each(s,function(a,s){if(s){var i=Xe.getGroup(""+s);e.push(i),0===t("#li-gs-group-"+i.htmlId).length&&o.addContactForSearchList(i,"mck-group-search-list")}})}else X.removeClass("n-vis").addClass("vis");o.initAutoSuggest({contactsArray:e,$searchId:ie,isContactSearch:!0}),Be.removeClass("vis").addClass("n-vis")},o.addConversationMenu=function(e,a){var s=It.data("mck-id");if(ft.html(""),e===s){var o=Ve[e];if(void 0===o||0===o.length||1===o.length)return R.addClass("n-vis"),G.addClass("mck-product-box-wc"),void ft.addClass("n-vis");ft.removeClass("n-vis"),R.removeClass("n-vis"),G.removeClass("mck-product-box-wc"),t.each(o,function(s,o){if(0===t("#mck-conversation-list #li-"+o.id).length){var i="";if(o.topicDetail){var n=t.parseJSON(o.topicDetail);i="object"==typeof n?n.title:o.topicDetail}i||(i=o.topicId);var r=[{convIdExpr:o.id,tabIdExpr:e,isGroupExpr:a,topicIdExpr:o.topicId,convTitleExpr:i,mckLauncherExpr:D}];t.tmpl("convTemplate",r).appendTo(ft)}}),t("#mck-conversation-list li").length<2&&(R.addClass("n-vis"),G.addClass("mck-product-box-wc"),ft.addClass("n-vis"))}},o.loadContacts=function(e){e+""!="null"&&void 0!==e&&void 0!==e.contacts&&0!==e.contacts.length&&($e.length=0,je.length=0,t.each(e.contacts,function(e,t){if(void 0!==t.userId){var a=o.getContact(""+t.userId);a=void 0===a?o.createContactWithDetail(t):o.updateContactDetail(a,t),$e.push(a),je.push(a.contactId)}}))},o.loadContactsForContactList=function(e){var t=e.startIndex?e.startIndex:"0",s=e.pageSize?e.pageSize:"50",o=MCK_BASE_URL+"/rest/ws/user/filter?startIndex="+t+"&pageSize="+s+"&orderBy=1";Je.ajax({url:o,type:"get",global:!1,success:function(e){console.log(e)},error:function(){a.console.log("Unable to load contacts. Please reload page.")}})},o.getStatusIcon=function(e){return'<span class="'+o.getStatusIconName(e)+" move-right "+e.key+'_status status-icon"></span>'},o.getStatusIconName=function(e){return 7===e.type||6===e.type||4===e.type||0===e.type?"":5===e.status?"mck-read-icon":4===e.status?"mck-delivered-icon":3===e.type||5===e.type||1===e.type&&(0===e.source||1===e.source)?"mck-sent-icon":""},o.clearMessageField=function(e){h.html(""),u.attr("disabled",!1),m.removeClass("vis").removeClass("mck-text-req").addClass("n-vis").attr("required","").html(""),e?h.focus().select():(n.blur(),h.blur())},o.addDraftMessage=function(e){if(p=[],e&&"object"==typeof Fe[e]){var a=Fe[e];h.html(a.text),a.files.length>0&&(t.each(a.files,function(e,t){tt.addFileBox(t)}),c.html(a.filelb),l.html(a.filesize),m.removeClass("n-vis").removeClass("mck-text-req").addClass("vis").removeAttr("required"))}else p=[]},o.showOfflineMessage=function(){"object"==typeof le&&le.innerHTML?(bt.html(le.innerHTML),bt.removeClass("n-vis").addClass("vis")):a.console.log("Offline message innerHTML required.")},o.hideOfflineMessage=function(){Ye.stopOfflineMessageCounter(),bt.removeClass("vis").addClass("n-vis")},o.removeConversationThread=function(e,a){ALStorage.clearMckMessageArray();var s=a?Xe.getGroup(e):at.getContact(e),o=It.data("mck-id"),i=It.data("isgroup");if(void 0===o||""===o){var n=void 0!==s?s.htmlId:mckContactUtils.formatContactId(e),r=a?"group-"+n:"user-"+n;t("#li-"+r).remove()}else o===e&&i===a&&(ut.data("datetime",""),A.removeClass("n-vis").addClass("vis"),kt.removeClass("vis").addClass("n-vis"))},o.removedDeletedMessage=function(e,a,s){ALStorage.clearMckMessageArray();var o=t("."+e);if(o.length>0)o.remove(),It.is(":empty")&&(A.removeClass("n-vis").addClass("vis"),kt.removeClass("vis").addClass("n-vis"));else if(void 0!==a){var i=t("#mck-contact-list").length;i>0&&nt.updateContactList(a,s)}},o.getMessageTextForContactPreview=function(e,t,o){var i="";if(void 0!==e){if(e.message){if("true"===e.metadata.hide)return;if(e.metadata&&(e.metadata.KM_ASSIGN||e.metadata.KM_STATUS))return;if(2===e.contentType)i='<span class="mck-icon--location"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="rgba(38,50,56,.52)"/><path d="M0 0h24v24H0z" fill="none"/></svg></span><span>Location</span>';else{var n=e.message;if(Je.startsWith(n,"<img"))return'<span class="mck-icon--camera"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3.2" fill="rgba(38,50,56,.52)"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z" fill="rgba(38,50,56,.52)"/><path d="M0 0h24v24H0z" fill="none"/></svg></span><span>image</span>';if(null!==a.emoji&&void 0!==a.emoji?(i=a.emoji.replace_unified(n),i=-1!==(i=a.emoji.replace_colons(i)).indexOf("</span>")?i.substring(0,i.lastIndexOf("</span>")):i.substring(0,o)):i=n,!t.isGroup&&-1===i.indexOf("emoji-inner")&&0===e.contentType){var r=s.createElement("p");r.appendChild(s.createTextNode(i)),i=r}}}else e.fileMetaKey&&"object"==typeof e.fileMeta?i=rt.getFileIcon(e):e.metadata&&e.metadata.messagePreview&&(i=e.metadata.messagePreview);if(t.isGroup&&3!==t.type&&7!==t.type&&10!==t.type){var c=e.to.split(",")[0]===Ce?"Me":at.getTabDisplayName(e.to.split(",")[0],!1);if(10!==e.contentType&&(i=c+": "+i),-1===i.indexOf("emoji-inner")&&e&&e.message&&0===e.contentType){var r=s.createElement("p");r.appendChild(s.createTextNode(i)),i=r}}}return i},o.getTextForMessagePreview=function(e,a){var o="";if(void 0!==e){if(2===e.contentType)o="Shared location";else if(e.message){var i=e.message;if(Je.startsWith(i,"<img"))o="Image attachment";else{var n=s.createElement("div");n.innerHTML=i,i=t.trim(Je.textVal(n)),o=i.substring(0,50)}}else e.fileMetaKey&&"object"==typeof e.fileMeta&&(o=-1!==e.fileMeta.contentType.indexOf("image")?"Image attachment":"File attachment");if(a.isGroup&&3!==a.type&&7!==a.type){var r=e.to.split(",")[0]===Ce?"Me":at.getTabDisplayName(e.to.split(",")[0],!1);o=r+": "+o}}return o},o.getUserIdFromMessage=function(e){var t=e.to;return t.lastIndexOf(",")===t.length-1&&(t=t.substring(0,t.length-1)),t.split(",")},o.getUserIdArrayFromMessageList=function(e){var a=new Array;return void 0===e.length?a.concat(o.getUserIdFromMessage(e)):t.each(e,function(e,t){void 0!==t.to&&(a=a.concat(o.getUserIdFromMessage(t)))}),a},o.messageContextMenu=function(e){var s=t("."+e+" .mck-msg-box");s.addEventListener?s.addEventListener("contextmenu",function(e){e.preventDefault()},!1):s.bind("contextmenu",function(s){s.preventDefault(),t(".mck-context-menu").removeClass("vis").addClass("n-vis"),t("."+e+" .mck-context-menu").removeClass("n-vis").addClass("vis"),a.event.returnValue=!1})},o.isValidMetaData=function(e){return!e.metadata||"HIDDEN"!==e.metadata.category&&"ARCHIVE"!==e.metadata.category&&"true"!=e.metadata.hide},o.updateDraftMessage=function(e,a){if("object"==typeof a){var s={text:"",files:[]},o={fileMeta:a,filelb:rt.getFilePreviewPath(a),filesize:rt.getFilePreviewSize(a.size)};void 0!==e&&"object"==typeof Fe[e]&&(s=Fe[e],t.each(s.files,function(e,t){t.filelb===o.filelb&&s.files.splice(e,1)})),s.files.push(o)}Fe[e]=s},o.updateUnreadCount=function(e,t,a){var s=o.getUnreadCount(e);He[e]=t,(a||mt.length>0)&&((E+=t-s)<0&&(E=0),E>0?mt.html(E):mt.html("")),a&&Je.badgeCountOnLaucher(ve,E)},o.incrementUnreadCount=function(e){E+=1,He[e]=void 0===He[e]?1:He[e]+1,mt.length>0&&mt.html(E),Je.badgeCountOnLaucher(ve,E)},o.getUnreadCount=function(e){return void 0===He[e]?(He[e]=0,0):He[e]},o.isGroupDeleted=function(e,t){if(t){var a=et.getDeletedAtTime(e);return void 0!==a&&a>0}return!1},o.getTabDisplayName=function(e,t,a){var s="";if(t)return Qe.getGroupDisplayName(e);"function"==typeof se&&(s=se(e)),void 0!==a&&a&&(s=a,qe[e]=a),s||(s=o.getContactDisplayName(e));var i=o.fetchContact(""+e);return s?(i.displayName=s,v[i.contactId]=i):void 0!==i.displayName&&(s=i.displayName),s||(s=e),s},o.populateMessage=function(e,a,s){var i=mckDateUtils.convertMilisIntoTime(a.metadata.CALL_DURATION);dt.loadUserProfile(a.to),103==a.contentType&&(4==a.type&&"CALL_REJECTED"==a.metadata.MSG_TYPE?a.message="you rejected a Video call from "+a.to:5==a.type&&"CALL_REJECTED"==a.metadata.MSG_TYPE?a.message=a.to+"rejected a Video call from you":4==a.type&&"CALL_END"==a.metadata.MSG_TYPE?a.message="you were in a call with "+a.to+"\n call duration : "+i:5==a.type&&"CALL_END"==a.metadata.MSG_TYPE?a.message="you were in a call with "+a.to+"\n call duration : "+i:4==a.type&&"CALL_MISSED"==a.metadata.MSG_TYPE?a.message="you missed a Video call from "+a.to:5==a.type&&"CALL_MISSED"==a.metadata.MSG_TYPE&&(a.message=a.to+"missed a Video call from you"));var n=It.data("mck-id"),r=at.isValidMetaData(a),c=a.groupId?Xe.getGroup(a.groupId):at.getContact(a.to);if(void 0===n||""===n){var l=t("#mck-contact-list").length;if(l>0&&r?a.groupId?Qe.addGroupFromMessage(a,!0,function(e,t,a){o.updateRecentConversationList(e,t,a)}):at.addContactsFromMessage(a,!0):at.addContactsFromMessageList({message:[a]},""),"APPLOZIC_01"===e||"MESSAGE_RECEIVED"===e){if(void 0===c&&(c=a.groupId?Xe.createGroup(a.groupId):at.createContact(a.to)),Ne)return void at.loadTab({tabId:c.contactId,isGroup:c.isGroup,conversationId:a.conversationId});var d=a.groupId?"group_"+c.contactId:"user_"+c.contactId;r&&(10!==a.contentType&&102!==a.contentType&&at.incrementUnreadCount(d),it.notifyUser(a));var m=a.groupId?"group-"+c.htmlId:"user-"+c.htmlId;t("#li-"+m+" .mck-unread-count-text").html(at.getUnreadCount(d)),at.getUnreadCount(d)>0&&t("#li-"+m+" .mck-unread-count-box").removeClass("n-vis").addClass("vis"),nt.sendDeliveryUpdate(a)}}else if(void 0===c&&(c=a.groupId?Xe.createGroup(a.groupId):at.createContact(a.to)),"APPLOZIC_01"===e||"MESSAGE_RECEIVED"===e){if(void 0!==c){var p=It.data("isgroup");if((void 0===a.oldKey||0===t("."+a.oldKey).length)&&0===t("."+a.key).length||10===a.contentType){if(void 0===n||n!=c.contactId||p!==c.isGroup||J.hasClass("vis")){if(Ne)return void at.loadTab({tabId:c.contactId,isGroup:c.isGroup,conversationId:a.conversationId});if(r&&10!==a.contentType||102!==a.contentType){var d=a.groupId?"group_"+c.contactId:"user_"+c.contactId;at.incrementUnreadCount(d)}nt.sendDeliveryUpdate(a)}else{var u=!0;if(p&&6===c.type&&(u=Qe.isAppendOpenGroupContextMenu(c)),a.conversationId&&(_e||ye)){var v=It.data("mck-conversationid");if(v&&v.toString()===a.conversationId.toString())a.metadata&&"HIDDEN"===a.metadata.category||at.addMessage(a,c,!0,!0,u),nt.sendReadUpdate(a.pairedMessageKey);else if(Ne)return void at.loadTab({tabId:c.contactId,isGroup:c.isGroup,conversationId:a.conversationId})}else{if(7===c.type){var g,f=Xe.getGroup(a.groupId);Qe.getContactFromGroupOfTwo(f,function(e){g=at.fetchContact(e)}),Ze.lastSeenOfGroupOfTwo(g.contactId),at.addMessage(a,c,!0,!0,u)}(!a.metadata||"HIDDEN"!==a.metadata.category&&"true"!==a.metadata.hide&&7!==c.type)&&at.addMessage(a,c,!0,!0,u),nt.sendReadUpdate(a.pairedMessageKey)}a.groupId||(t("#mck-tab-status").html(MCK_LABELS.online),dt.updateUserStatus({userId:a.to,status:1},function(e){ot.getUsersDetail(e,{})}))}s&&6!==c.type&&it.notifyUser(a)}}}else if("APPLOZIC_02"===e&&102==!a.contentType&&((void 0===a.oldKey||0===t("."+a.oldKey).length)&&0===t("."+a.key).length||10===a.contentType))if(l>0)at.addContactsFromMessage(a,!0);else if(void 0!==c){var p=It.data("isgroup");if(void 0!==n&&n===c.contactId&&p===c.isGroup){var u=!0;p&&6===c.type&&(u=Qe.isAppendOpenGroupContextMenu(c)),a.metadata&&"HIDDEN"===a.metadata.category||at.addMessage(a,c,!0,!0,u),3===a.type&&(t("."+a.key+" .mck-message-status").removeClass("mck-pending-icon").addClass("mck-sent-icon"),at.addTooltip(a.key))}}Le.removeClass("vis").addClass("n-vis")},o.getMessageFeed=function(e){var a={};if(a.key=e.key,a.timeStamp=e.createdAtTime,a.message=e.message,a.from=4===e.type?e.to:Ce,e.groupId?a.to=e.groupId:a.to=5===e.type?e.to:Ce,a.status="read",a.type=4===e.type?"inbox":"outbox",5===e.type&&(3===e.status?a.status="sent":4===e.status&&(a.status="delivered")),"object"==typeof e.fileMeta){var s=t.extend({},e.fileMeta);void 0!==s.url&&""!==s.url||(s.url=F+"/rest/ws/aws/file/"+e.fileMeta.blobKey),delete s.blobKey,a.file=s}return a.source=e.source,a.metadata=e.metadata,a},o.updateUnreadCountonChatIcon=function(e){if(Oe&&e.length>0){var a=null,s=0;e.length>0&&(t.each(e,function(e,t){t.unreadCount>0&&null!==a||t.unreadCount>0&&(a=t.userId,s=t.unreadCount)}),E>0&&"none"===d.css("display")&&(null!==a&&s===E?at.loadTab({tabId:a,isGroup:!1}):at.loadTab({tabId:"",isGroup:!1})))}},o.loadMessageListOnUserDetailFetch=function(e){Le.removeClass("vis").addClass("n-vis");var a=It.data("mck-id"),s=It.data("isgroup");if(void 0===a||e.tabId===a&&""+s==""+e.isGroup){var o=Xe.getGroup(e.tabId);et.addGroupStatus(o);var i=6!==o.type,i=!0;6===o.type&&(et.validateOpenGroupUser(o),i=Qe.isAppendOpenGroupContextMenu(o)),e.isMessages?(at.processMessageList(e.messageData,!0,i),6!==o.type&&kt.removeClass("n-vis").addClass("vis"),"function"==typeof W&&W(e.tabId)):0===t("#mck-message-cell .mck-message-inner div[name='message']").length&&kt.removeClass("vis").addClass("n-vis")}}},st=new function(){var e,o=this,i=t("#mck-search"),n=t("#mck-msg-to"),r=t("#mck-msg-new"),l=(t("#mck-audio"),t("#mck-mike-btn"),t("#mck-sidebox")),m=t("#mck-file-box"),u=t("#mck-text-box"),v=t("#mck-msg-form"),h=t("#mck-msg-sbmt"),T=t("#mck-new-group"),E=t("#mck-tab-title"),x=t("#mck-msg-error"),S=t("#mck-btn-attach"),L=t("#mck-tab-status"),A=t("#mck-message-cell"),_=t(".mck-typing-box"),G=t("#mck-gms-loading"),K=t("#mck-group-title"),R=t("#mck-contact-loading"),z=(t("#mck-no-messages"),t(".mck-group-search")),P=(t(".mck-city-search"),t("#mck-msg-response")),F=t("#mck-msg-form #mck-file-input"),q=t("#mck-block-button"),H=t("#li-mck-block-user"),j=t("#li-mck-group-info"),Y=t("#li-mck-video-call"),Z=t("#mck_response_text"),Q=t(".mck-contact-search"),X=t("#mck-group-info-tab"),ee=t("#mck-price-text-box"),te=(t("#mck-sidebox-search"),t("#mck-group-info-btn")),X=t("#mck-group-info-tab"),se=t("#mck-btn-group-exit"),ne=t("#mck-group-back-link"),re=t("#mck-btn-leave-group"),ce=t(".mck-sidebox-content"),le=(t("#mck-no-more-messages"),t("#mck-btn-group-create")),de=(t("#mck-group-create-tab"),t("#mck-group-add-member")),pe=(t("#mck-contacts-content"),t("#mck-tab-option-panel")),ue=(t("#mck-no-conversations"),t("#mck-group-create-title")),ve=t(".mck-group-menu-options"),fe=t(".mck-tab-message-option"),ke=t(".mck-group-admin-options"),Ie=t("#mck-group-member-search"),Me=t("#mck-autosuggest-search-input"),Ee=t("#mck-autosuggest-metadata"),Se=t("#mck-message-cell .mck-message-inner"),Ae=(t("#mck-search-cell .mck-message-inner"),t("#mck-no-more-conversations"),t("#mck-gm-search-box")),Ge=t("#mck-group-member-search-list"),Ue=t("#mck-no-gsm-text"),Ke=t("#mck-minutes"),Ne=t("#mck-seconds");o.checkArray=function(e){if(e&&!1===Array.isArray(e))throw new Error("askUserDetails should be an array");return e},o.createNewConversation=function(e,t){Kommunicate.startConversation(e,t)},o.loadConversationWithAgents=function(e,a){"kommunicate"==window.applozic.PRODUCT_ID&&re.removeClass("vis").addClass("n-vis");Kommunicate.client.getGroupDetailByType({type:10,startIndex:0,limit:10},function(e,s){if(e)console.log("error while fetching group detail by type",e);else if(0==s.response.length)st.createNewConversation({groupName:Ct,agentId:ht,botIds:bt},function(e){a()});else if(1==s.response.length){var o=s.response[0].id;t.fn.applozic("loadGroupTab",o),a()}else t.fn.applozic("loadTab"),a()})},o.timer=function(){var t=0,a=this;e=setInterval(function(){++t,Ne.html(a.pad(t%60)),Ke.html(a.pad(parseInt(t/60)))},1e3),a.pad=function(e){var t=e+"";return t.length<2?"0"+t:t}},o.stoptimer=function(){Ne.html("0"),Ke.html("0"),clearInterval(e)},t(s).on("click",".mck-message-delete",function(){o.deleteMessage(t(this).parents(".mck-m-b").data("msgkey"))}),t(s).on("click",".mck-message-reply",function(){o.replyMessage(t(this).parents(".mck-m-b").data("msgkey"))}),t(s).on("click",".mck-message-forward",function(){r.data("forwardMessageKey",t(this).parents(".mck-m-b").data("msgkey")),r.trigger("click")}),t(".mck-minimize-icon").click(function(){t(".mck-box-md,.mck-box-ft").animate({height:"toggle"}),ce.hasClass("minimized")?(ce.css("height","100%"),ce.removeClass("minimized")):(ce.css("height","0%"),ce.addClass("minimized"))}),o.init=function(){t.template("oflTemplate",'<div id="mck-ofl-blk" class="mck-m-b"><div class="mck-clear"><div class="blk-lg-12 mck-text-light mck-text-muted mck-test-center">${userIdExpr} is offline now</div></div></div>'),ALStorage.clearMckMessageArray(),t(s).on("click","."+D,function(){t(this).hasClass("mck-msg-preview")&&t(this).hide()}),at.initSearchAutoType(),Q.click(function(){st.createNewConversation({groupName:Ct,agentId:ht,botIds:bt},function(e){}),t("#mck-msg-new").attr("disabled",!0)}),t(s).on("click","#mck-sidebox-launcher",function(){document.getElementById("launcher-agent-img-container").classList.add("n-vis"),void 0!==ge?document.getElementById("mck-sidebox-launcher").childNodes[0].childNodes[0].classList.remove("n-vis"):document.getElementById("launcher-svg-container").classList.remove("n-vis")}),t(s).on("click","#talk-to-human-link",function(){""===t("#km-faq-search-input").val()?(st.createNewConversation({groupName:Ct,agentId:ht,botIds:bt},function(e){}),KommunicateUI.showChat()):st.createNewConversation({groupName:Ct,agentId:ht,botIds:bt},function(e){KommunicateUI.sendFaqQueryAsMsg(e),KommunicateUI.showChat()}),t("#mck-contact-list").removeClass("vis").addClass("n-vis")}),z.click(function(){at.addGroupsToGroupSearchList()}),u.keydown(function(e){if(u.hasClass("mck-text-req")&&u.removeClass("mck-text-req"),13===e.keyCode&&(e.shiftKey||e.ctrlKey)){if(e.preventDefault(),a.getSelection){var t=a.getSelection(),o=t.getRangeAt(0),i=s.createElement("br"),n=s.createTextNode(" ");return o.deleteContents(),o.insertNode(i),o.collapse(!1),o.insertNode(n),o.selectNodeContents(n),t.removeAllRanges(),t.addRange(o),u.animate({scrollTop:u.prop("scrollHeight")},0),!1}}else 13===e.keyCode?(e.preventDefault(),1===g&&yt.sendTypingStatus(0,Se.data("mck-id")),h.is(":disabled")&&m.hasClass("vis")?alert("Please wait file is uploading."):v.submit()):0===g&&yt.sendTypingStatus(1,Se.data("mck-id"))}),t(s).on("click",".mck-btn-clear-messages",function(){confirm(MCK_LABELS["clear.messages.alert"])&&st.deleteConversation()}),t(s).on("click",".applozic-tm-launcher",function(e){e.preventDefault();var a=t(this).data("mck-id");a=void 0!==a&&""!==a?a.toString():"";var s=t(this).data("mck-name");s=void 0!==s&&""!==s?s.toString():"";var o=t(this).data("mck-supportid");o=void 0!==o&&""!==o?o.toString():"";var i=t(this).data("mck-topicid");i=void 0!==i&&""!==i?i.toString():"";var n=t(this).data("mck-msg");if(n=void 0!==n&&""!==n?n.toString():"","function"==typeof ae&&i){var r=ae(i);"object"==typeof r&&"undefined"!==r.title&&(y[i]=r)}var c={topicId:i,tabId:a,userName:s,isMessage:!0},l={type:5,contentType:0,message:n};c.messagePxy=l,o?(c.isGroup=!0,c.supportId=o,st.getConversationId(c)):(c.isGroup=!1,at.loadTab(c,nt.dispatchMessage))}),t(s).on("click",".applozic-wt-launcher",function(e){e.preventDefault();var a=t(this).data("mck-id");a=void 0!==a&&""!==a?a.toString():"";var s=t(this).data("mck-name");s=void 0!==s&&""!==s?s.toString():"";var o=t(this).data("mck-topicid");o=void 0!==o&&""!==o?o.toString():"";var i=t(this).data("mck-topic-status");if(i=i?-1===Re.indexOf(i)?Re[0]:i.toString():Re[0],"function"==typeof ae){var n=ae(o);"object"==typeof n&&"undefined"!==n.title&&(y[o]=n)}st.getConversationId({tabId:a,isGroup:!1,userName:s,topicId:o,topicStatus:i,isMessage:!1})}),t(s).on("click",".applozic-ct-launcher",function(e){e.preventDefault();var a=t(this).data("mck-id");a=void 0!==a&&""!==a?a.toString():"";var s=t(this).data("mck-name");s=void 0!==s&&""!==s?s.toString():"";var o=t(this).data("mck-topicid");o=void 0!==o&&""!==o?o.toString():"";var i=t(this).data("mck-topic-status");i=i?-1===Re.indexOf(i)?Re[0]:i.toString():Re[0];var n={tabId:a,isGroup:!1,userName:s,topicId:o,topicStatus:i,isMessage:!1};if("function"==typeof me){var r=me(o);"object"==typeof r&&(r.topicDetail&&"object"==typeof r.topicDetail&&"undefined"!==r.topicDetail.title&&(y[o]=r.topicDetail),r.fallBackTemplatesList&&r.fallBackTemplatesList.length>0&&(n.fallBackTemplatesList=r.fallBackTemplatesList))}st.getConversationId(n)}),t(s).on("click","."+D+", .mck-contact-list ."+D,function(e){e.preventDefault(),!isFirstLaunch&&t("#mck-conversation-back-btn").addClass("vis-table").removeClass("km-visibility-hidden"),count++;var a=t(this),s=this,o=a.data("mck-id");count>1&&"object"!=typeof MCK_EVENT_HISTORY[MCK_EVENT_HISTORY.length-1]&&MCK_EVENT_HISTORY.push(s),o?a.parents(".mck-search-list").length?(i.bind("blur"),setTimeout(function(){st.openChat(s)},600)):st.openChat(s):t.fn.applozic("mckLaunchSideboxChat")}),t("#km-form-chat-login").submit(function(a){var s=t("#km-submit-chat-login"),o=t("#km-error-chat-login"),i=t("#km-userId").val(),n=t("#km-email").val(),r=t("#km-userName").val(),c=t("#km-contact").val();c&&(i=c),n&&(i=n),o.removeClass("show").addClass("hide"),o.html("");var l={userId:i,applicationId:w,onInit:e,baseUrl:MCK_BASE_URL,locShare:B,googleApiKey:he,chatNotificationMailSent:!0};return n&&(l.email=n),r&&(l.displayName=r),c&&(l.contactNumber=c),s.attr("disabled",!0),s.html("Initiating chat..."),Ye.initialize(l),!1});var e=function(){"kommunicate"===window.applozic.PRODUCT_ID&&re.removeClass("vis").addClass("n-vis"),st.loadConversationWithAgents({groupName:Ct,agentId:ht,botIds:bt})};t(".km-login-model-close").on("click",function(e){t("#km-chat-login-modal").css("display","none")}),t(s).on("click",".mck-conversation-tab-link",function(e){e.preventDefault();t(this);var a=Se.data("mck-id"),s=Se.data("isgroup");KommunicateUI.hideAwayMessage(),KommunicateUI.hideLeadCollectionTemplate(),at.loadTab({tabId:"",isGroup:!1,lastActiveTabId:a,isLastActiveTabGroup:s})}),t(s).on("click",".mck-close-sidebox",function(e){e.preventDefault(),l.mckModal("hide"),t("#mck-sidebox-launcher").removeClass("n-vis").addClass("vis");var a=Se.data("mck-conversationid");if(Se.data("mck-id",""),Se.data("mck-topicid",""),Se.data("mck-name",""),Se.data("mck-conversationid",""),a){var s=M[a];if("object"==typeof s){var o=s.topicId;"function"==typeof V&&V(Ce,o)}}yt.unsubscibeToTypingChannel()}),t(s).on("click",".mck-price-submit",function(e){e.preventDefault(),o.sendPriceMessage()}),ee.keydown(function(e){13===e.keyCode&&o.sendPriceMessage()}),Se.bind("scroll",function(){if(Se.find(".mck-contact-list").length>0){if(Se.scrollTop()+Se.innerHeight()>=Se[0].scrollHeight){var e=Se.data("datetime");e>0&&!f&&st.loadMessageList({tabId:"",isGroup:!1,startTime:e})}}else if(0===Se.scrollTop()){var t=Se.data("mck-id");if(void 0===t||""===t)return;var a=Se.data("isgroup"),s=Se.data("mck-conversationid");s=s?s.toString():"";var e=pe.data("datetime");e>0&&!f&&st.loadMessageList({tabId:t,isGroup:a,conversationId:s,startTime:e})}}),ee.on("click",function(e){e.preventDefault(),ee.removeClass("mck-text-req")}),q.on("click",function(e){e.preventDefault();var t=Se.data("mck-id"),a=Se.data("isgroup"),s=!Se.data("blocked");if(a)return H.removeClass("vis").addClass("n-vis"),void Y.removeClass("vis").addClass("n-vis");var o=s?MCK_LABELS["block.user.alert"]:MCK_LABELS["unblock.user.alert"];confirm(o)&&dt.blockUser(t,s,function(e){Ze.toggleBlockUser(e,s)})}),re.on("click",function(e){e.preventDefault();var t=Se.data("mck-id"),a=Se.data("isgroup");a?confirm(MCK_LABELS["exit.group.alert"])&&Qe.leaveGroup({apzCallback:et.onGroupLeft,groupId:t}):ve.removeClass("vis").addClass("n-vis")}),t(s).on("click",".mck-add-to-group",function(e){e.preventDefault();var a=t(this).data("mck-id");void 0!==a&&et.addGroupMemberFromSearch(a),Ae.mckModal("hide")}),t(s).on("click",".mck-btn-remove-member",function(e){e.stopPropagation();var a=t(this).parents(".mck-li-group-member").data("mck-id"),s=X.data("mck-id");if(void 0!==s&&void 0!==a){var o=Xe.getGroup(s);"object"==typeof o&&Ce===o.adminName?confirm(MCK_LABELS["remove.member.alert"])&&Qe.removeGroupMember({groupId:s,userId:a,apzCallback:et.onRemovedGroupMember}):ke.removeClass("vis").addClass("n-vis")}}),se.on("click",function(e){e.preventDefault();var t=X.data("mck-id");t?confirm(MCK_LABELS["exit.group.alert"])&&Qe.leaveGroup({groupId:t,apzCallback:et.onGroupLeft}):at.loadTab({tabId:"",isGroup:!1})}),te.on("click",function(e){e.preventDefault();var t=Se.data("mck-id"),a=Se.data("isgroup");if(a){var s={groupId:t},o=Se.data("mck-conversationid");o&&(s.conversationId=o),et.loadGroupInfo(s)}else ve.removeClass("vis").addClass("n-vis")}),T.on("click",function(e){e.preventDefault(),et.loadCreateGroupTab()}),ne.on("click",function(e){e.preventDefault();var t=X.data("mck-id"),a=X.data("mck-conversation-id");if(t){var s={tabId:t,isGroup:!0};a&&(s.conversationId=a),at.loadTab(s)}else at.loadTab({tabId:"",isGroup:!1})}),de.on("click",function(e){e.preventDefault();var a=X.data("mck-id");if(a){var s=Xe.getGroup(a);if(!s||s.adminName!==Ce)return void ke.removeClass("vis").addClass("n-vis");Ge.html(""),Ae.mckModal(),G.removeClass("n-vis").addClass("vis"),je.length>0?et.addMembersToGroupSearchList():we?$e.length>0?(t.each($e,function(e,t){je.push(t.contactId)}),et.addMembersToGroupSearchList()):(G.removeClass("vis").addClass("n-vis"),Ue.removeClass("n-vis").addClass("vis")):dt.getUserStatus({callback:et.addMembersToGroupSearchList},function(e){t.each(e.users,function(e,t){var a=at.getContact(""+t.userId);a=void 0===a?at.createContactWithDetail(t):at.updateContactDetail(a,t),je.push(a.contactId)})})}}),Ie.keypress(function(e){if(13===e.which){var t=Ie.val();return""!==t&&et.addGroupMemberFromSearch(t),Ie.val(""),!0}}),t(s).on("click",".mck-group-member-search-link",function(e){e.preventDefault();var t=Ie.val();""!==t&&et.addGroupMemberFromSearch(t),Ie.val("")}),t(s).on("click",".mck-show-more",function(e){e.preventDefault();var a=t(this),s=a.data("tabId"),o=Se.data("isgroup"),i=Se.data("mck-conversationid");i=i?i.toString():"";var n=a.data("datetime");st.loadMessageList({tabId:s,isGroup:o,conversationId:i,startTime:n})}),t(s).on("click",".mck-accept",function(e){var a=t(this).data("mck-conversationid"),s=t(this).data("mck-topic-price");if("function"==typeof ie&&s&&a){var o=M[a],i=n.val(),r=Qe.getGroupDisplayName(i);"object"==typeof o?(ie({custId:Ce,suppId:r,productId:o.topicId,price:s}),nt.sendConversationCloseUpdate(a)):nt.getTopicId({conversationId:a,suppId:r,priceText:s},function(e){at.populateMessage(e.messageType,e.message,e.notifyUser)})}}),v.submit(function(){1===g&&yt.sendTypingStatus(0,Se.data("mck-id"));var e=t.trim(Je.textVal(u[0]));if(m.hasClass("n-vis")&&p.length>0&&(p=[]),0===e.length&&0===p.length)return u.addClass("mck-text-req"),!1;if("function"==typeof oe&&!oe(e))return!1;var s={type:5,contentType:0,message:e},i=Kommunicate.getSettings("KM_CHAT_CONTEXT");i&&(s.metadata={KM_CHAT_CONTEXT:i});var r=Se.data("mck-conversationid"),c=Se.data("mck-topicid");if(r)s.conversationId=r;else if(c){var l={topicId:c},d=y[c];"object"==typeof d&&(l.topicDetail=a.JSON.stringify(d)),s.conversationPxy=l}var v=Ee.val();v&&""!=v&&(s.metadata={suggestMessageMetadata:v},Ee.val("")),""!=Me.data("prev-msgkey")&&void 0!==Me.data("prev-msgkey")&&(st.updateMessageMetadata({key:Me.data("prev-msgkey"),metadata:{obsolete:!0}}),Me.data("prev-msgkey","")),Me.hasClass("mck-text-box")&&(Me.addClass("n-vis").removeClass("mck-text-box").val(""),u.removeClass("n-vis").addClass("mck-text-box"),Me.data("source-url",""),t(".mck-dropup-menu").hide()),!0===Se.data("isgroup")?s.groupId=n.val():s.to=n.val(),h.attr("disabled",!0),x.removeClass("vis").addClass("n-vis"),x.html(""),Z.html(""),P.removeClass("vis").addClass("n-vis");let f=t("[data-msgtype=5]").length;if(1==f&&KommunicateUI.isLeadCollectionEnabled&&KommunicateUI.awayMessageInfo.isEnabled&&1==KommunicateUI.awayMessageInfo.eventId){var k=KommunicateUI.validateEmail(s.message);if(!k)return!1}return o.sendMessage(s),!1}),F.on("click",function(){t(this).val(""),x.removeClass("vis").addClass("n-vis"),P.removeClass("vis").addClass("n-vis")}),t(s).bind("click",function(e){t(".mck-context-menu").removeClass("vis").addClass("n-vis"),!S.hasClass("on")||t(e.target).hasClass("mck-icon-upload")||t(e.target).hasClass("mck-btn-attach")||We.fileMenuToggle(),u.removeClass("mck-text-req"),s.activeElement&&s.activeElement!==u&&1===g&&yt.sendTypingStatus(0,Se.data("mck-id")),s.activeElement&&"mck-group-name-save"!==s.activeElement.id&&K.removeClass("mck-req-border"),s.activeElement&&"mck-btn-group-create"!==s.activeElement.id&&ue.removeClass("mck-req-border"),t(".mcktypeahead.mck-dropdown-menu").hide()}),t(".mck-tabview-item").click(function(){t(".mck-tabview-item").removeClass("active"),t(this).addClass("active")})},t(".mck-sidebox").on("click","#mck-mike-btn",function(){t(this).removeClass("vis").addClass("n-vis"),$(".mck-stop-btn").addClass("vis").removeClass("n-vis"),Fr.voice.record(!1,function(){$("#mck-audio").removeClass("n-vis").addClass("vis"),st.timer()})}),t(".mck-sidebox").on("click","#mck-stop-recording",function(){$("#mck-mike-btn").addClass("vis").removeClass("n-vis"),$(".mck-stop-btn").addClass("n-vis").removeClass("vis"),$("#mck-audio").removeClass("vis").addClass("n-vis"),st.stoptimer(),Fr.voice.export(function(e){var a={};a.file=e,a.name="blob",t.fn.applozic("audioAttach",a)},"blob"),Fr.voice.stop()}),o.openChat=function(e){var a=t(e),s=a.data("mck-id");s=void 0!==s&&""!==s?s.toString():"";var o=a.data("mck-name");o=void 0!==o&&""!==o?o.toString():"";var n=a.data("mck-topicid");n=void 0!==n&&""!==n?n.toString():"";var r=!0===a.data("isgroup"),c=a.data("mck-conversationid");if(c=void 0!==c&&""!==c?c.toString():"",n&&!c){var l=t(elem).data("mck-topic-status");l=l?-1===Re.indexOf(l)?Re[0]:l.toString():Re[0],st.getConversationId({tabId:s,isGroup:r,userName:o,topicId:n,topicStatus:l,isMessage:!1})}else at.loadTab({tabId:s,isGroup:r,userName:o,conversationId:c,topicId:n});i.val("")},o.sendMessage=function(e){var a,s;if(void 0!==$("#mck-message-cell .mck-message-inner div[name='message']:last-child").data("msgkey")&&(a=$("#mck-message-cell .mck-message-inner div[name='message']:last-child").data("msgkey"),s=nt.getReplyMessageByKey(a)),"object"==typeof e){if(e.to&&b[e.to]&&(b[e.to].deletedAtTime||!0===gt))return x.html(MCK_LABELS["user.delete"]).removeClass("n-vis").addClass("vis"),t("#mck-tab-status").removeClass("vis").addClass("n-vis"),v.removeClass("vis").addClass("n-vis"),void H.removeClass("vis").addClass("n-vis");var i=e.metadata?e.metadata:{},n=t("#mck-text-box").data("AL_REPLY");if(void 0===n||""===n||e.forward||(i.AL_REPLY=n),e.metadata=i,void 0!==e.message&&0!==e.message.length||0!==p.length){if(s&&(!s.metadata.altype||0!==s.type&&4!==s.type&&6!==s.type||(i.altype=s.metadata.altype)),e.conversationId){var r=M[e.conversationId];if("undefined"!==r&&r.closed)return at.closeConversation(),void h.attr("disabled",!1)}var c=Se.data("blocked");if(c&&!e.groupId)return Ze.toggleBlockUser(m,!0),void h.attr("disabled",!1);var l="";if(e.groupId?void 0===(l=Xe.getGroup(e.groupId))&&(l=Xe.createGroup(e.groupId)):l=e.clientGroupId?Xe.getGroupByClientGroupId(e.clientGroupId):at.fetchContact(e.to),t("#mck-message-cell .mck-no-data-text").length>0&&t(".mck-no-data-text").remove(),e.message&&0===p.length){var d=fe.hasClass("n-vis"),m=Se.data("mck-id"),g=Je.randomId();e.key=g,12!==e.contentType&&m&&m.toString()===l.contactId&&102!==e.contentType&&nt.addMessageToTab(e,l,function(e,t){at.addMessage(e,t,!0,!0,!1)});var f={tabId:l.contactId,isTopPanelAdded:d};o.submitMessage(e,f)}else if(!e.message||0===p.length||1!==e.contentType&&2!==e.contentType)p.length>0&&t.each(p,function(t,a){var s=fe.hasClass("n-vis"),i=Se.data("mck-id"),n=Je.randomId();e.key=n,e.fileMeta=a,e.contentType=1,12!==e.contentType&&i&&i.toString()===l.contactId&&nt.addMessageToTab(e,l,function(e,t){at.addMessage(e,t,!0,!0,!1)});var r={tabId:l.contactId,isTopPanelAdded:s};o.submitMessage(e,r)});else{var d=fe.hasClass("n-vis"),m=Se.data("mck-id"),g=Je.randomId();e.key=g;var k={};e.groupId?k.groupId=e.groupId:k.to=e.to,k.type=e.type,k.key=Je.randomId(),k.message=e.message,k.contentType=e.contentType,e.contentType=1,e.fileMeta=p[0],e.message="",12!==e.contentType&&m&&m.toString()===l.contactId&&(nt.addMessageToTab(e,l,function(e,t){at.addMessage(e,t,!0,!0,!1)}),nt.addMessageToTab(k,l,function(e,t){at.addMessage(e,t,!0,!0,!1)}));var f={tabId:l.contactId,isTopPanelAdded:d};o.submitMessage(e,f),o.submitMessage(k,f)}u.removeClass("mck-text-req"),h.attr("disabled",!1),t("."+g+" .mck-message-status").removeClass("mck-sent-icon").addClass("mck-pending-icon"),at.addTooltip(g),at.clearMessageField(!0),p=[],delete Fe[l.contactId]}else u.addClass("mck-text-req")}},o.sendForwardMessage=function(e){var t=ALStorage.getMessageByKey(e);if(void 0!==t){t.fileMeta&&p.push(t.fileMeta);var s={type:5,contentType:t.contentType,message:t.message,forward:"forward"};t.metadata&&(t.metadata.AL_REPLY&&(t.metadata.AL_REPLY=""),s.metadata=t.metadata);var i=Se.data("mck-conversationid"),r=Se.data("mck-topicid");if(i)s.conversationId=i;else if(r){var c={topicId:r},l=y[r];"object"==typeof l&&(c.topicDetail=a.JSON.stringify(l)),s.conversationPxy=c}!0===Se.data("isgroup")?s.groupId=n.val():s.to=n.val(),o.sendMessage(s)}},o.sendWelcomeMessage=function(e){var t=Je.randomId(),a=Se.data("mck-id"),s=Se.data("isgroup"),o={key:t,type:4,contentType:0,to:e.sender,message:e.messageContent};if(a&&a.toString()===e.sender&&!s){var i=at.fetchContact(a);nt.addMessageToTab(o,i,function(e,t){at.addMessage(e,t,!0,!0,!1)})}Je.ajax({type:"GET",url:MCK_BASE_URL+"/rest/ws/message/add/inbox",global:!1,data:"sender="+encodeURIComponent(e.sender)+"&messageContent="+encodeURIComponent(e.messageContent),contentType:"text/plain",success:function(t){e.callback&&e.callback(t)}})},o.submitMessage=function(e,s){var o=e.key,i=e.metadata?e.metadata:{};Le&&(i=t.extend(e.metadata,{userStatus:4}));var n=t("#mck-text-box").data("AL_REPLY");void 0===n||""===n||e.forward||(i.AL_REPLY=n,t("#mck-text-box").data("AL_REPLY","")),e.source=be;var r=t("#mck-message-cell .mck-message-inner div[name='message']."+o);102!=e.contentType&&103!=e.contentType&&(i=t.extend(i,xe)),e.metadata=i,Je.ajax({type:"POST",url:MCK_BASE_URL+"/rest/ws/message/send",global:!1,data:a.JSON.stringify(e),contentType:"application/json",success:function(a){var i=Se.data("mck-id");if("object"==typeof a){var n=a.messageKey;if(i&&i.toString()===s.tabId){var c=a.conversationId;Se.data("mck-conversationid",c),r.removeClass(o).addClass(n),r.data("msgkey",n),t("."+n+" .mck-message-status").removeClass("mck-pending-icon").addClass("mck-sent-icon").attr("title","sent"),at.addTooltip(n),s.isTopPanelAdded&&pe.data("datetime",a.createdAt);var l=!0;if(e.groupId){var d=Xe.getGroup(e.groupId);6===d.type&&(l=!1)}l&&at.messageContextMenu(n)}if(e.conversationPxy){var m=e.conversationPxy;e.topicId&&(N[e.topicId]=[c]),M[c]=m}}else"CONVERSATION_CLOSED"===a||"BUSY_WITH_OTHER"===a?(h.attr("disabled",!1),at.closeConversation(a),r.remove(),s.isTopPanelAdded&&fe.removeClass("vis").addClass("n-vis")):"error"===a&&(h.attr("disabled",!1),x.html("Unable to process your request. Please try again"),x.removeClass("n-vis").addClass("vis"),r.remove(),s.isTopPanelAdded&&fe.removeClass("vis").addClass("n-vis"));let p=t("[data-msgtype=5]").length;1==p&&KommunicateUI.isLeadCollectionEnabled&&KommunicateUI.awayMessageInfo.isEnabled&&1==KommunicateUI.awayMessageInfo.eventId&&KommunicateUI.displayLeadCollectionTemplate(null),p>1&&t("#mck-email-collection-box").removeClass("vis").addClass("n-vis");var u=at.getTabDisplayName(i,!1);if(!b[i]&&i!==u){ot.updateDisplayName(i,u);var v={userId:i,userName:u};b[v.userId]=v}},error:function(){x.html("Unable to process your request. Please try again."),x.removeClass("n-vis").addClass("vis"),r&&r.remove(),s.isTopPanelAdded&&fe.removeClass("vis").addClass("n-vis")}}),$("#mck-reply-to-div").removeClass("vis").addClass("n-vis")},o.updateMessageMetadata=function(e){e.metadata||e.messageKey?Je.ajax({type:"POST",url:MCK_BASE_URL+"/rest/ws/message/update/metadata",global:!1,data:a.JSON.stringify(e),contentType:"application/json",success:function(e){console.log("metadata updated: ",e)},error:function(){}}):console.log("empty metadata")},o.downloadImage=function(e){window.open(e,"_blank")},o.replyMessage=function(e){var a="",s=(Se.data("mck-id"),nt.getReplyMessageByKey(e));u.focus().select(),$("#mck-reply-to-div").removeClass("n-vis").addClass("vis"),a=5===s.type?"You":at.getTabDisplayName(s.to,!1),$("#mck-reply-to").html(a),"object"==typeof s.fileMeta||2===s.contentType?$("#mck-reply-msg").html(at.getImageForMessagePreview(s)):$("#mck-reply-msg").html(s.message),t("#mck-text-box").data("AL_REPLY",e)},$("#close").click(function(){$("#mck-reply-to-div").removeClass("vis").addClass("n-vis"),t("#mck-text-box").data("AL_REPLY","")}),o.deleteMessage=function(e){var s=Se.data("mck-id");void 0!==s&&Je.ajax({url:MCK_BASE_URL+"/rest/ws/message/delete?key="+e,type:"get",success:function(o){if("success"===o){var i=Se.data("mck-id");i===s&&(t("."+e).remove(),Se.is(":empty")&&fe.removeClass("vis").addClass("n-vis")),ALStorage.clearMckMessageArray()}else a.console.log("Unable to delete message. Please reload page.")}})},o.deleteConversation=function(){var e=Se.data("mck-id"),t=Se.data("isgroup"),a=Se.data("mck-conversationid");if(void 0!==e){var s={};t?s.groupId=e:s.userId=e,a&&(s.conversationId=a),f=!0,window.Applozic.ALApiService.deleteConversation({data:s,success:function(){var t=Se.data("mck-id");t===e&&(Se.html(""),pe.data("datetime",""),A.removeClass("n-vis").addClass("vis"),fe.removeClass("vis").addClass("n-vis"),f=!1)},error:function(){}})}},o.loadMessageList=function(e,s){var o=!1,i=!1,n="";void 0!==e.tabId&&""!==e.tabId?(n=e.isGroup?"&groupId="+e.tabId:"&userId="+encodeURIComponent(e.tabId),o=!0,e.startTime&&(n+="&endTime="+e.startTime),n+="&pageSize=30",(_e||ye)&&e.conversationId&&(n+="&conversationId="+e.conversationId,void 0===Ve[e.tabId]?(i=!0,n+="&conversationReq=true"):at.addConversationMenu(e.tabId,e.isGroup)),e.isGroup&&Kommunicate.getAwayMessage({applicationId:w,conversationId:e.tabId},KommunicateUI.populateAwayMessage)):(f=!0,e.startTime&&(n+="&endTime="+e.startTime),n+="&mainPageSize=60"),e.startTime||Se.html(""),R.removeClass("n-vis").addClass("vis"),Je.ajax({url:MCK_BASE_URL+"/rest/ws/message/list?startIndex=0"+n,type:"get",global:!1,success:function(n){var c=!0;KommunicateUI.displayLeadCollectionTemplate(n.message);var l=Se.data("mck-id"),d=Se.data("isgroup");if(e.isGroup&&!e.startTime||R.removeClass("vis").addClass("n-vis"),f=!1,(void 0===l||e.tabId===l&&""+d==""+e.isGroup)&&(n+""!="null"&&void 0!==n.message&&0!==n.message.length||(c=!1,o?e.startTime?pe.data("datetime",""):e.isGroup||0!==t("#mck-message-cell .mck-message-inner div[name='message']").length||fe.removeClass("vis").addClass("n-vis"):(e.startTime,Se.data("datetime",""))),n+""!="null"&&"error"!==n.status))if(o){if(c&&(e.startTime>0?at.processMessageList(n,!1,!0):e.isGroup||(at.processMessageList(n,!0,!0),fe.removeClass("n-vis").addClass("vis"))),!e.startTime>0&&!e.isGroup&&"function"==typeof W&&W(e.tabId),n.userDetails.length>0&&t.each(n.userDetails,function(t,s){if(b[s.userId]=s,!e.isGroup&&(s.connected?a.MCK_OL_MAP[s.userId]=!0:(a.MCK_OL_MAP[s.userId]=!1,void 0!==s.lastSeenAtTime&&(I[s.userId]=s.lastSeenAtTime)),O||e.isGroup||(s.blockedByThis?(k[s.userId]=!0,Ze.toggleBlockUser(e.tabId,!0)):s.blockedByOther?(C[s.userId]=!0,E.removeClass("mck-tab-title-w-status"),L.removeClass("vis").addClass("n-vis"),_.removeClass("vis").addClass("n-vis"),Se.data("blocked",!1)):Ze.toggleBlockUser(e.tabId,!1)),s.userName&&!e.startTime)){var o=at.getTabDisplayName(e.tabId,e.isGroup,s.userName);E.html(o),E.attr("title",o)}}),!Te||e.isGroup||e.startTime||a.MCK_OL_MAP[e.tabId]||Ye.manageOfflineMessageTime(e.tabId),n.conversationPxys.length>0){var m=new Array;t.each(n.conversationPxys,function(e,s){if("object"==typeof s&&(m.push(s),M[s.id]=s,N[s.topicId]=[s.id],s.topicDetail))try{y[s.topicId]=t.parseJSON(s.topicDetail)}catch(e){a.console.log("Incorect Topic Detail!")}}),i&&(Ve[e.tabId]=m,at.addConversationMenu(e.tabId,e.isGroup))}if(e.conversationId){var p=M[e.conversationId];"object"==typeof p&&p.closed&&at.closeConversation()}e.startTime||(e.isGroup?(et.addGroupStatus(Xe.getGroup(e.tabId)),at.updateUnreadCount("group_"+e.tabId,0,!0)):at.updateUnreadCount("user_"+e.tabId,0,!0),"function"==typeof s&&s(e)),n.groupFeeds.length>0&&t.each(n.groupFeeds,function(a,s){var o=Xe.addGroup(s);if(!e.startTime){var i=s.membersId,r=[];if(t.each(i,function(e,t){void 0===at.getContact(t)&&r.push(t)}),r.length>0)e.isMessages=c,e.messageData=n,e.isLoadMessageList=!0,ot.getUsersDetail(r,e);else{et.addGroupStatus(o);var l,d=!0;7===o.type&&(j.removeClass("vis").addClass("n-vis"),Qe.getContactFromGroupOfTwo(o,function(e){l=at.fetchContact(e)}),Ze.lastSeenOfGroupOfTwo(l.contactId)),"kommunicate"==window.applozic.PRODUCT_ID&&(3!==o.users[Ce].role&&2!==o.users[Ce].role&&0!==o.users[Ce].role||j.removeClass("vis").addClass("n-vis")),6===o.type&&(et.validateOpenGroupUser(o),d=Qe.isAppendOpenGroupContextMenu(o)),R.removeClass("vis").addClass("n-vis"),c?(at.processMessageList(n,!0,d),6!==o.type&&fe.removeClass("n-vis").addClass("vis")):0===t("#mck-message-cell .mck-message-inner div[name='message']").length&&fe.removeClass("vis").addClass("n-vis"),"function"==typeof W&&W(e.tabId)}}})}else e.startTime||(a.MCK_OL_MAP=[]),n.userDetails.length>0&&t.each(n.userDetails,function(e,t){b[t.userId]=t,t.connected?a.MCK_OL_MAP[t.userId]=!0:(a.MCK_OL_MAP[t.userId]=!1,void 0!==t.lastSeenAtTime&&(I[t.userId]=t.lastSeenAtTime)),at.updateUnreadCount("user_"+t.userId,t.unreadCount,!1);var s=at.getContact(""+t.userId);void 0===s?at.createContactWithDetail(t):at.updateContactDetail(s,t)}),n.groupFeeds.length>0&&t.each(n.groupFeeds,function(e,t){at.updateUnreadCount("group_"+t.id,t.unreadCount,!1),Xe.addGroup(t)}),n.blockedUserPxyList.blockedToUserList.length>0&&t.each(n.blockedUserPxyList.blockedToUserList,function(e,t){t.userBlocked&&(k[t.blockedTo]=!0)}),n.blockedUserPxyList.blockedByUserList.length>0&&t.each(n.blockedUserPxyList.blockedByUserList,function(e,t){t.userBlocked&&(C[t.blockedBy]=!0)}),n.conversationPxys.length>0&&t.each(n.conversationPxys,function(e,s){if(M[s.id]=s,N[s.topicId]=[s.id],s.topicDetail)try{y[s.topicId]=t.parseJSON(s.topicDetail)}catch(e){a.console.log("Incorect Topic Detail!")}}),c?(e.startTime?e.startTime&&(e.isReload=!1,o||ALStorage.updateLatestMessageArray(n.message)):(e.isReload=!0,o||ALStorage.setLatestMessageArray(n.message)),o&&ALStorage.updateMckMessageArray(n.message),at.addContactsFromMessageList(n,e)):Se.data("datetime",""),e.isLaunch&&at.updateUnreadCountonChatIcon(n.userDetails);var u=r.data("forwardMessageKey");void 0!==u&&(st.sendForwardMessage(u),r.data("forwardMessageKey",""))},error:function(e,t,s){401===e.status&&(sessionStorage.clear(),console.log("Please reload page.")),f=!1,R.removeClass("vis").addClass("n-vis"),a.console.log("Unable to load messages. Please reload page.")}})},o.updateContactList=function(e,t){var a={};t?a.groupId=e:a.userId=e,a.pageSize=1,window.Applozic.ALApiService.getMessages({data:a,success:function(a){var s=a.data;if(s+""=="null"||void 0===s.message||0===s.message.length)at.clearContactMessageData(e,t);else{var i=s.message[0];void 0!==i&&(i.groupId?Qe.addGroupFromMessage(i,!0,function(e,t,a){o.updateRecentConversationList(e,t,a)}):at.addContactsFromMessage(i,!0))}},error:function(a){at.clearContactMessageData(e,t)}})},o.conversationReadUpdate=function(e){var t=e.tabId,a=e.isGroup?"group_"+t:"user_"+t;if(t&&at.getUnreadCount(a)>0){var s=""+e.isGroup=="true"?"groupId="+t:"userId="+t;window.Applozic.ALApiService.conversationReadUpdate({data:s,success:function(e){at.updateUnreadCount(a,0,!0)},error:function(){}})}},o.getConversationId=function(e){if(!e.isGroup&&!e.isMessage&&e.topicStatus!==Re[1]){var s=N[e.topicId];if(s&&"object"==typeof(i=M[s])){if(Se.data("mck-conversationid",i.id),e.conversationId=i.id,void 0!==Ve[e.tabId]){var o=Ve[e.tabId];o.push(i),Ve[e.tabId]=o}return void at.loadTab(e)}}if(e.topicId){var i={topicId:e.topicId,userId:e.tabId,status:e.topicStatus};e.isGroup?i.groupId=e.groupId:i.userId=e.tabId;var n=y[e.topicId];"object"==typeof n&&(i.topicDetail=a.JSON.stringify(n)),e.fallBackTemplatesList&&e.fallBackTemplatesList.length>0&&(i.fallBackTemplatesList=e.fallBackTemplatesList),window.Applozic.ALApiService.getConversationId({data:i,success:function(s){if("object"==typeof s&&"success"===s.status){var o=s.response;if("object"==typeof o&&"undefined"!==o.conversationPxy){var i=o.conversationPxy;if(M[i.id]=i,N[i.topicId]=[i.id],i.topicDetail)try{y[i.topicId]=t.parseJSON(i.topicDetail)}catch(e){a.console.log("Incorect Topic Detail!")}if(Se.data("mck-conversationid",i.id),e.conversationId=i.id,void 0!==Ve[e.tabId]){var n=Ve[e.tabId];n.push(i),Ve[e.tabId]=n}if(e.isGroup){var r=Xe.addGroup(o);e.tabId=r.contactId}e.isMessage&&i.created?at.loadTab(e,nt.dispatchMessage):at.loadTab(e)}}},error:function(){}})}},o.sendPriceMessage=function(){var e=ee.val();if(""!==e){e=t.trim(e);var a=n.val(),s=Se.data("mck-conversationid",s),i={type:5,contentType:4,message:e};if(!0===Se.data("isgroup")?i.groupId=a:i.to=a,Se.data("mck-conversationid")){var s=Se.data("mck-conversationid");i.conversationId=s;var r=M[s];"object"!==r?nt.getTopicId({conversationId:s,suppId:a,priceText:e},function(e){at.populateMessage(e.messageType,e.message,e.notifyUser)}):"function"==typeof ie&&ie({custId:Ce,suppId:a,productId:r.topicId,price:e}),ee.val("")}o.sendMessage(i)}else ee.addClass("mck-text-req")},o.getGroup=function(e){var s=[];t.each(e.users,function(e,t){void 0!==t.userId&&(void 0!==t.groupRole&&-1===U.indexOf(t.groupRole)||s.push(t))});var o={groupName:t.trim(e.groupName),users:s,type:e.type};e.admin&&(o.admin=e.admin),e.clientGroupId&&(o.clientGroupId=e.clientGroupId),e.groupIcon&&(o.imageUrl=e.groupIcon),o.metadata=e.metadata?e.metadata:MCK_LABELS["group.metadata"];var i=new Object;let n={"UserId-Enabled":!0,Authorization:"Basic "+c,"Application-Key":w,"Device-Key":d,"Access-Token":J};Je.ajax({url:MCK_BASE_URL+"/rest/ws/group/v2.1/create",global:!1,data:a.JSON.stringify(o),type:"post",headers:n,contentType:"application/json",success:function(s){if(e.isInternal&&le.attr("disabled",!1).html(MCK_LABELS["create.group.title"]),"object"==typeof s&&"success"===s.status){var o=s.response;if("object"==typeof o){var n=Xe.addGroup(o);o.users.length>0&&t.each(o.users,function(e,t){b[t.userId]=t,t.connected?a.MCK_OL_MAP[t.userId]=!0:(a.MCK_OL_MAP[t.userId]=!1,void 0!==t.lastSeenAtTime&&(I[t.userId]=t.lastSeenAtTime)),at.updateUnreadCount("user_"+t.userId,t.unreadCount,!1);var s=at.getContact(""+t.userId);void 0===s?at.createContactWithDetail(t):at.updateContactDetail(s,t)}),e.tabId=n.contactId,e.isGroup=!0,e.isMessage?at.loadTab(e,nt.dispatchMessage):e.isInternal?(Se.data("mck-id",n.contactId),Se.data("isgroup",!0),et.loadGroupInfo({groupId:n.contactId})):at.loadTab(e),"function"==typeof e.callback&&(i.updated=!!s.updated&&s.updated,i.status="success",i.data=n,e.callback(i))}}else"error"===s.status&&"function"==typeof e.callback&&(i.status="error",i.errorMessage=s.errorResponse[0].description,e.callback(i))},error:function(){e.isInternal&&le.attr("disabled",!1).html(MCK_LABELS["create.group.title"]),"function"==typeof e.callback&&(i.status="error",i.errorMessage="Unable to process request.",e.callback(i))}})}},ot=new function(){t("#mck-search-list");var e=t("#mck-sidebox-search"),s=t("#mck-search-loading");t("#mck-search-cell .mck-message-inner"),t("#mck-message-cell .mck-message-inner"),t(".mck-tab-message-option"),t("#mck-contact-loading");this.getContactDisplayName=function(e){var t=[];window.Applozic.ALApiService.getContactDisplayName({data:{userIdArray:e},success:function(e){for(var a in e)if(e.hasOwnProperty(a)){t.push([a,e[a]]),qe[a]=e[a];var s=at.fetchContact(a);s.displayName=e[a]}ALStorage.updateMckContactNameArray(t)},error:function(){}})},this.loadContacts=function(){var o=[];window.Applozic.ALApiService.getContactList({url:"/rest/ws/user/v3/filter?startIndex=0&pageSize=50&orderBy=1",baseUrl:MCK_BASE_URL,success:function(s){if(e.hasClass("vis"))return"object"==typeof s&&s.users.length>0&&(t.each(s.users,function(e,t){if(void 0!==t.userId){var s=at.getContact(""+t.userId);s=void 0===s?at.createContactWithDetail(t):at.updateContactDetail(s,t),$e.push(s),o.push([t.userId,s.displayName]),t.connected?a.MCK_OL_MAP[t.userId]=!0:(a.MCK_OL_MAP[t.userId]=!1,void 0!==t.lastSeenAtTime&&(I[t.userId]=t.lastSeenAtTime))}}),ot.getUsersDetail(contactNameArray,{async:!1}),o.length>0&&ALStorage.updateMckContactNameArray(o)),at.addContactsToSearchList(),void et.addMembersToGroupSearchList()},error:function(){s.removeClass("vis").addClass("n-vis"),a.console.log("Unable to load contacts. Please reload page.")}})},this.getUsersDetail=function(e,s){if(!(void 0===e||e.length<1)){for(var o=void 0===s.cached||s.cached,i=[],n=e.filter(function(t,a){return e.indexOf(t)===a}),r=0;r<n.length;r++){var c=n[r];o&&void 0!==b[c]||i.push(c)}if(0!==i.length){var l=new Object;window.Applozic.ALApiService.getUserDetail({data:{userIdList:i},success:function(e){"success"===e.status&&e.response.length>0&&t.each(e.response,function(e,t){b[t.userId]=t,a.MCK_OL_MAP[t.userId]=t.connected;var s=at.getContact(""+t.userId);s=void 0===s?at.createContactWithDetail(t):at.updateContactDetail(s,t)}),s.setStatus?Ze.updateUserConnectedStatus():s.message?at.populateMessage(s.messageType,s.message,s.notifyUser):s.isLoadMessageList&&at.loadMessageListOnUserDetailFetch(s),l.status="success",l.data=e,s.callback&&s.callback(l)},error:function(){s.setStatus?Ze.updateUserConnectedStatus():s.message?at.populateMessage(s.messageType,s.message,s.notifyUser):s.isLoadMessageList&&at.loadMessageListOnUserDetailFetch(s),l.status="error",s.callback&&s.callback(l)}})}else s.setStatus?Ze.updateUserConnectedStatus():s.message?at.populateMessage(s.messageType,s.message,s.notifyUser):s.isLoadMessageList&&at.loadMessageListOnUserDetailFetch(s)}},this.updateUserIdentity=function(e){if(null!==e.newUserId&&""!==e.newUserId){var t="newUserId="+encodeURIComponent(e.newUserId);Je.ajax({url:MCK_BASE_URL+"/rest/ws/user/change/identifier",type:"get",data:t,contentType:"application/json",success:function(t){"object"==typeof t&&"success"===t.status&&e.callback&&e.callback(t)},error:function(t){e.callback&&e.callback({response:"error"})}})}},this.updateUser=function(e){Je.ajax({type:"POST",url:MCK_BASE_URL+"/rest/ws/user/update",data:a.JSON.stringify(e.data),contentType:"application/json",success:function(t){e.success&&e.success(t)},error:function(t){e.error&&e.error(t)}})},this.updateDisplayName=function(e,a){if(""!==e&&""!==a){var s="userId="+e+"&displayName="+a;t.ajax({url:MCK_BASE_URL+"/rest/ws/user/name",type:"get",data:s,success:function(e){if("object"==typeof e&&"success"===e.status)return"success"},error:function(){}})}}},it=new function(){var e,a,o,i,n=this;n.init=function(){t("#mck-sidebox"),a=t("#mck-group-info-tab"),t("#mck-sidebox-launcher"),e=t("#mck-message-cell .mck-message-inner"),o=t("#mck-msg-preview-visual-indicator"),i=t("#mck-msg-preview-visual-indicator .mck-msg-preview-visual-indicator-text")},n.notifyUser=function(e){if(!1!==e.alert&&7!==e.type&&!1!==e.metadata.alert){var t=e.groupId?Xe.getGroup(""+e.groupId):at.fetchContact(""+e.to.split(",")[0]),a=!1;e.groupId&&(a=!0),dt.loadUserProfile(e.to);var s=at.getTabDisplayName(t.contactId,a),o=ut;if(n.showNewMessageNotification(e,t,s),Ge&&!T){var i=pe,r=at.getTextForMessagePreview(e,t);if("function"==typeof ne&&!t.isGroup){var c=ne(t.contactId);c&&void 0!==c&&(i=c)}o?ct.sendDesktopNotification(s,i,r,o):ct.sendDesktopNotification(s,i,r)}}},n.showNewMessageNotification=function(n,r,c){if(Ue&&102!==n.contentType){var l=e.data("mck-id"),d=e.data("isgroup");if(l===r.contactId&&d===r.isGroup&&!a.hasClass("vis")){if(!n.conversationId||!_e&&!ye)return;var m=e.data("mck-conversationid");if((m=void 0!==m&&""!==m?m.toString():"")===n.conversationId.toString())return}i.data("isgroup",r.isGroup);var p=n.conversationId?n.conversationId:"";i.data("mck-conversationid",p);var u=at.getContactImageLink(r,c);if(n.message){var v=at.getMessageTextForContactPreview(n,r,82);v.length>81&&(v+="..."),i.html(""),i.removeClass("mck-flexi"),"object"==typeof v?i.append(v):i.html(v),o.removeClass("n-vis").addClass("vis")}else i.html("");if(n.fileMetaKey)i.html(rt.getFileIcon(n)),o.removeClass("n-vis").addClass("vis"),i.addClass("mck-flexi");else if(2===n.contentType){for(;"."===v[v.length-1];)v=v.slice(0,-1);i.html(v),o.removeClass("n-vis").addClass("vis"),i.addClass("mck-flexi")}u.includes("/avatars/default.png")?(t("#launcher-agent-img-container").html("").addClass("n-vis").removeClass("vis"),t("#launcher-svg-container").addClass("vis").removeClass("n-vis")):(t("#launcher-agent-img-container").html(u),t("#launcher-agent-img-container").addClass("vis").removeClass("n-vis"),t("#launcher-svg-container").addClass("n-vis").removeClass("vis")),void 0!==ge&&document.getElementById("mck-sidebox-launcher").childNodes[0].childNodes[0].classList.add("n-vis"),i.data("mck-id",r.contactId),t(s).on("click","#mck-msg-preview-visual-indicator .mck-close-btn, #mck-msg-preview-visual-indicator .mck-msg-preview-visual-indicator-text",function(){o.removeClass("vis").addClass("n-vis"),i.html("")})}}},nt=new AlMessageService,rt=new AlFileService,ct=new MckNotificationUtils,lt=new AlNotificationService,dt=new AlUserService,mt=t(".chat-launcher-icon"),pt=new function(){var e,a=this;a.token=null,a.Identity=null,a.outgoingCallServices=null,a.incomingCallServices=null;var s=t(".mck-videocall-btn"),o=t(".applozic-vid-container"),i=t("#mck-sidebox"),n=t("#mck-video-call-indicator"),r=t("#mck-video-box");a.hideVideoBox=function(){o.addClass("n-vis").removeClass("vis"),i.addClass("vis").removeClass("n-vis"),n.addClass("n-vis").removeClass("vis")},a.init=function(){r.mckModal(),vt.loop=!0,a.token=null!==ALStorage.getAppHeaders()?ALStorage.getAppHeaders().videoToken:void 0,a.ringToneForHost=L.loadRingTone(Kommunicate.BASE_URL[MCK_BASE_URL]+"/plugin/audio/applozic_video_call_ring_tone.mp3",vt),t("#mck-btn-video-call").on("click",function(s){if(a.token){var o=$mck_msg_to.val(),i=Ce+(new Date).getTime().toString()+Math.random().toString(36).slice(2),n=nt.sendVideoCallMessage(i,"CALL_DIALED",102,!1,o,function(e){st.sendMessage(e)}),r=at.fetchContact(n.to),c=at.getTabDisplayName(r.contactId,!1),l=at.getContactImageLink(r,c),d=new Date,m=Ce;a.outgoingCallServices=new MckCallingService(m,pt.token,i,c,!0,d,st,l,!1,a.ringToneForHost),a.outgoingCallServices.startVideoCall(),t("#mck-btn-video-call").data("isCallHost",!0),t("#mck-btn-video-call").data("callStartTime",d)}else"INSUFFICIENT_FUNDS"===e?alert("Video calling is not available at the moment. For details, contact support."):alert("missing token... please refresh page..")}),t("#mck-vid-receive-btn").on("click",function(e){console.log("call received"),$("#mck-video-call-indicator").addClass("n-vis").removeClass("vis"),s.removeClass("vis").addClass("n-vis");var a=t("#mck-video-call-indicator").data("call-id"),o=t("#mck-video-call-indicator").data("isAudioCall");t("#mck-video-call-indicator").data("callReceived",!0),t("#mck-video-call-indicator").addClass("n-vis"),pt.callReceived(a,o)}),t("#mck-vid-reject-btn").on("click",function(e){console.log("call rejected");var a=t("#mck-video-call-indicator").data("call-id"),s=t("#mck-video-call-indicator").data("isAudioCall");pt.callRejected(a,s),t("#mck-video-call-indicator").addClass("n-vis").removeClass("vis")})},a.InitilizeVideoClient=function(s,o){a.Identity=s,t.ajax({url:MCK_BASE_URL+"/twilio/token",type:"post",contentType:"application/x-www-form-urlencoded",data:{identity:s,device:o},success:function(t){if(null!=t&&""!=t){a.token=t.token;var s=ALStorage.getAppHeaders();s.videoToken=t.token,ALStorage.setAppHeaders(s)}t.hasOwnProperty("errorResponse")&&(e=t.errorResponse[0].description)},error:function(e){console.log("error while getting token"+e)}})},a.callReceived=function(e,t){var s=$mck_msg_to.val();console.log("_this.callReceived"),ft&&ft.stop();nt.sendVideoCallMessage(e,"CALL_ANSWERED",102,t,s,function(e){st.sendMessage(e)});a.incomingCallServices=new MckCallingService(a.Identity,a.token,e,null,!1,null,st,null,t),a.incomingCallServices.startVideoCall()},a.callRejected=function(e,t){ft&&ft.stop();nt.sendVideoCallMessage(e,"CALL_REJECTED",102,t,toUser,function(e){st.sendMessage(e)})}},ut=null,vt={},gt=!1,ft=null,kt=st.checkArray(n.askUserDetails),Ct=n.conversationTitle,ht=n.agentId,bt=n.botIds;n.agentName;a.MCK_OL_MAP=new Array,l.mckLaunchSideboxChat=function(){t("#mck-sidebox-launcher").removeClass("vis").addClass("n-vis"),KommunicateUI.showChat();t("#mck-away-msg-box").removeClass("vis").addClass("n-vis"),st.loadConversationWithAgents({groupName:Ct,agentId:ht,botIds:bt},function(){console.log("conversation created successfully"),KommunicateUI.activateTypingField()}),t("#mck-msg-preview-visual-indicator").hasClass("vis")&&t("#mck-msg-preview-visual-indicator").removeClass("vis").addClass("n-vis")},l.openChat=function(e){st.openChat(e)},l.events={onConnectFailed:function(){},onConnect:function(){},onMessageDelivered:function(){},onMessageRead:function(){},onMessageDeleted:function(){},onConversationDeleted:function(){},onUserConnect:function(){},onUserDisconnect:function(){},onConversationReadFromOtherSource:function(){},onConversationRead:function(){},onMessageReceived:function(){},onMessageSentUpdate:function(){},onMessageSent:function(){},onUserBlocked:function(){},onUserUnblocked:function(){},onUserActivated:function(){},onUserDeactivated:function(){}},l.loadConversationWithAgent=function(e){if(!e||!e.agentId)throw new Error("params are empty");console.log("setting default agent inside Applozic"),st.loadConversationWithAgents(e)};var yt=new function(e){var s,o,i=this,n=e.events,c=null,l=null,p="",u=null,v=[],f="",h=t("#mck-sidebox"),b=t("#mck-tab-title"),T=t(".mck-typing-box"),E=t("#mck-tab-status"),x=(t("#mck-offline-message-box"),t("#mck-typing-label")),S=t("#mck-message-cell .mck-message-inner");i.init=function(){if(void 0!==m){var e=Je.startsWith(m,"https")?"15675":"15674";"function"==typeof a.SockJS&&(f||(f=new SockJS(m+":"+e+"/stomp")),(l=a.Stomp.over(f)).heartbeat.outgoing=0,l.heartbeat.incoming=0,l.onclose=function(){i.disconnect()},l.connect("guest","guest",i.onConnect,i.onError,"/"),a.addEventListener("beforeunload",function(e){i.disconnect()}))}},i.checkConnected=function(e){l.connected?(s&&clearInterval(s),o&&clearInterval(o),s=setInterval(function(){i.connectToSocket(e)},6e5),o=setInterval(function(){i.sendStatus(1)},12e5)):i.connectToSocket(e)},i.connectToSocket=function(e){if(!l.connected){if(e&&"block"===h.css("display")){var t=S.data("mck-id");if(t){var a=S.data("isgroup"),s=S.data("mck-conversationid"),o=S.data("mck-topicid");ALStorage.clearMckMessageArray(),at.loadTab({tabId:t,isGroup:a,conversationId:s,topicId:o})}else ALStorage.clearMckMessageArray(),at.loadTab({tabId:"",isGroup:!1})}i.init()}},i.stopConnectedCheck=function(){s&&clearInterval(s),o&&clearInterval(o),s="",o="",i.disconnect()},i.disconnect=function(){clearInterval(void 0),l&&l.connected&&(i.sendStatus(0),l.disconnect(),f.close(),f="")},i.unsubscibeToTypingChannel=function(){l&&l.connected&&u&&(1===g&&i.sendTypingStatus(0,p),u.unsubscribe()),u=null},i.unsubscibeToNotification=function(){l&&l.connected&&c&&c.unsubscribe(),c=null},i.subscibeToTypingChannel=function(e,t){var a=t?e:Ce;l&&l.connected?u=l.subscribe("/topic/typing-"+w+"-"+a,i.onTypingStatus):i.reconnect()},i.subscribeToOpenGroup=function(e){if(l&&l.connected){var t=l.subscribe("/topic/group-"+w+"-"+e.contactId,i.onOpenGroupMessage);v.push(t.id),G[e.contactId]=t.id}else i.reconnect()},i.sendTypingStatus=function(e,t){if(l&&l.connected){if(1===e&&1===g&&l.send("/topic/typing-"+w+"-"+p,{"content-type":"text/plain"},w+","+Ce+","+e),t){if(t===p&&e===g&&1===e)return;p=t,l.send("/topic/typing-"+w+"-"+t,{"content-type":"text/plain"},w+","+Ce+","+e),setTimeout(function(){g=0},6e4)}else 0===e&&l.send("/topic/typing-"+w+"-"+p,{"content-type":"text/plain"},w+","+Ce+","+e);g=e}},i.onTypingStatus=function(e){if(null!=u&&u.id===e.headers.subscription){var t=e.body,a=t.split(",")[1],s=Number(t.split(",")[2]),o=e.headers.destination.substring(e.headers.destination.lastIndexOf("-")+1,e.headers.destination.length),i=S.data("mck-id"),n=S.data("isgroup"),r=Xe.getGroup(i);if(!k[a]&&!C[a])if(1===s){if(!(Ce===a&&n||i!==a&&i!==o)){var n=S.data("isgroup");if(n){if(a!==Ce){if(Qe.authenticateGroupUser(r)||6===r.type&&!ce.disableChatForNonGroupMember){b.addClass("mck-tab-title-w-typing"),E.removeClass("vis").addClass("n-vis");var c=at.getTabDisplayName(a,!1);c=c.split(" ")[0],x.html(c+" "+MCK_LABELS["is.typing"])}7===r.type&&(b.addClass("mck-tab-title-w-typing"),x.html(MCK_LABELS["is.typing"]),E.html(""))}}else b.addClass("mck-tab-title-w-typing"),E.removeClass("vis").addClass("n-vis"),x.html(MCK_LABELS.typing);T.removeClass("n-vis").addClass("vis"),setTimeout(function(){b.removeClass("mck-tab-title-w-typing"),T.removeClass("vis").addClass("n-vis"),b.hasClass(void 0===r||7!=r.type)&&E.removeClass("n-vis").addClass("vis"),x.html(MCK_LABELS.typing)},6e4)}}else b.removeClass("mck-tab-title-w-typing"),T.removeClass("vis").addClass("n-vis"),!b.hasClass("mck-tab-title-w-status")||void 0!==r&&7==r.type||E.removeClass("n-vis").addClass("vis"),x.html(MCK_LABELS.typing)}},i.reconnect=function(){i.unsubscibeToTypingChannel(),i.unsubscibeToNotification(),i.disconnect(),i.init()},i.onError=function(e){a.console.log("Error in channel notification. "+e),n.onConnectFailed()},i.sendStatus=function(e){l&&l.connected&&l.send("/topic/status-v2",{"content-type":"text/plain"},r+","+d+","+e)},i.onConnect=function(){l.connected?(c&&i.unsubscibeToNotification(),c=l.subscribe("/topic/"+r,i.onMessage),i.sendStatus(1),i.checkConnected(!0)):setTimeout(function(){c=l.subscribe("/topic/"+r,i.onMessage),i.sendStatus(1),i.checkConnected(!0)},5e3),n.onConnect()},i.onOpenGroupMessage=function(e){if(-1!==v.indexOf(e.headers.subscription)){var a=t.parseJSON(e.body),s=a.type,o=a.message;if("APPLOZIC_03"===s)ALStorage.updateLatestMessage(o),0!==o.type&&4!==o.type&&(t("."+o.key+" .mck-message-status").removeClass("mck-pending-icon").addClass("mck-sent-icon").attr("title","sent"),at.addTooltip(o.key)),n.onMessageSentUpdate({messageKey:o.key});else if("APPLOZIC_01"===s||"APPLOZIC_02"===s||"MESSAGE_RECEIVED"===s){ALStorage.updateLatestMessage(o);var i=o.groupId?Xe.getGroup(o.groupId):at.getContact(o.to);t("#mck-sidebox-content"),S.data("mck-id");if("APPLOZIC_01"===s||"MESSAGE_RECEIVED"===s){var r=at.getMessageFeed(o);n.onMessageReceived({message:r})}else if("APPLOZIC_02"===s){var r=at.getMessageFeed(o);n.onMessageSent({message:r})}if(o.conversationId){var c=M[o.conversationId];!_e&&!ye||"object"==typeof c&&"object"==typeof y[c.topicId]||nt.getTopicId({conversationId:o.conversationId,messageType:s,message:o,notifyUser:a.notifyUser,async:!1,populate:!1},function(e){at.populateMessage(e.messageType,e.message,e.notifyUser)})}if(void 0===i){var l={message:o,messageType:s,notifyUser:a.notifyUser};if(o.groupId)et.getGroupFeedFromMessage(l);else{var d=[];d.push(o.to),ot.getUsersDetail(d,l)}return}at.populateMessage(s,o,a.notifyUser)}}},i.onMessage=function(e){if(null!=c&&c.id===e.headers.subscription){var s=t.parseJSON(e.body),o=s.type;if("APPLOZIC_04"===o||"MESSAGE_DELIVERED"===o)t("."+s.message.split(",")[0]+" .mck-message-status").removeClass("mck-pending-icon").removeClass("mck-sent-icon").addClass("mck-delivered-icon").attr("title","delivered"),at.addTooltip(s.message.split(",")[0]),n.onMessageDelivered({messageKey:s.message.split(",")[0]});else if("APPLOZIC_08"===o||"MT_MESSAGE_DELIVERED_READ"===o)t("."+s.message.split(",")[0]+" .mck-message-status").removeClass("mck-pending-icon").removeClass("mck-sent-icon").removeClass("mck-delivered-icon").addClass("mck-read-icon"),at.addTooltip(s.message.split(",")[0]),n.onMessageRead({messageKey:s.message.split(",")[0]});else if("APPLOZIC_05"===o){var i=s.message.split(",")[0],r=s.message.split(",")[1],l="1"===s.message.split(",")[2];at.removedDeletedMessage(i,r,l);var d={messageKey:s.message.split(",")[0]};l?d.groupId=r:d.userKey=r,n.onMessageDeleted(d)}else if("APPLOZIC_27"===o){var m=s.message.split(",")[0],p=s.message.split(",")[1];if(void 0!==m){at.removeConversationThread(m,!1),at.updateUnreadCount("user_"+m,0,!0);var u={userId:m};p&&(u.topicId=p),n.onConversationDeleted(u)}}else if("APPLOZIC_11"===o){var m=s.message,v=at.fetchContact(m),r=S.data("mck-id");if(!k[m]&&!C[m]){if(r!==v.contactId||S.data("isgroup")){var g=mckContactUtils.formatContactId(m);t("#li-user-"+g+" .mck-ol-status").removeClass("n-vis").addClass("vis")}else t("#mck-tab-status").html(MCK_LABELS.online),Te&&at.hideOfflineMessage();t(".mck-user-ol-status."+g).removeClass("n-vis").addClass("vis"),t(".mck-user-ol-status."+g).next().html("("+MCK_LABELS.online+")"),a.MCK_OL_MAP[m]=!0,dt.updateUserStatus({userId:s.message,status:1},function(e){ot.getUsersDetail(e,{})})}n.onUserConnect({userId:s.message})}else if("APPLOZIC_12"===o){var m=s.message.split(",")[0],f=s.message.split(",")[1],v=at.fetchContact(m);if(a.MCK_OL_MAP[m]=!1,f&&(I[m]=f),!k[m]&&!C[m]){var r=S.data("mck-id");r!==v.contactId||S.data("isgroup")||(t("#mck-tab-status").html(mckDateUtils.getLastSeenAtStatus(f)),Te&&Ye.manageOfflineMessageTime(r)),t(".mck-user-ol-status."+v.htmlId).removeClass("vis").addClass("n-vis"),t(".mck-user-ol-status."+v.htmlId).next().html("(Offline)"),t("#li-user-"+g+" .mck-ol-status").removeClass("vis").addClass("n-vis"),dt.updateUserStatus({userId:m,status:0,lastSeenAtTime:f},function(e){ot.getUsersDetail(e,{})})}n.onUserDisconnect({userId:m,lastSeenAtTime:f})}else if("APPLOZIC_29"===o){var m=s.message.split(",")[0],p=s.message.split(",")[1],v=at.fetchContact(m);at.updateUnreadCount("user_"+v.contactId,0,!0);var r=S.data("mck-id");void 0!==r&&""!==r||(t("#li-user-"+v.htmlId+" .mck-unread-count-text").html(at.getUnreadCount("user_"+v.contactId)),t("#li-user-"+v.htmlId+" .mck-unread-count-box").removeClass("vis").addClass("n-vis"));var u={userId:m};p&&(u.topicId=p),n.onConversationReadFromOtherSource(u)}else if("APPLOZIC_28"===o){var m=s.message.split(",")[0],p=s.message.split(",")[1],r=S.data("mck-id");if(r===m){t(".mck-msg-right .mck-message-status").removeClass("mck-pending-icon").removeClass("mck-sent-icon").removeClass("mck-delivered-icon").addClass("mck-read-icon"),t(".mck-msg-right .mck-delivered-icon").attr("title","delivered and read");var v=at.getContact(m);if(void 0===v){var h=[];h.push(m),ot.getUsersDetail(h,{})}}var u={userId:m};p&&(u.topicId=p),n.onConversationRead(u)}else if("APPLOZIC_16"===o){var x=s.message.split(":")[0],m=s.message.split(":")[1],v=at.fetchContact(m),r=S.data("mck-id");r===v.contactId?x===ze[0]?(k[v.contactId]=!0,Ze.toggleBlockUser(r,!0)):(C[v.contactId]=!0,b.removeClass("mck-tab-title-w-status"),E.removeClass("vis").addClass("n-vis"),T.removeClass("vis").addClass("n-vis")):t("#li-user-"+v.htmlId+" .mck-ol-status").removeClass("vis").addClass("n-vis"),n.onUserBlocked({status:x,userId:m})}else if("APPLOZIC_17"===o){var x=s.message.split(":")[0],m=s.message.split(":")[1],v=at.fetchContact(m),r=S.data("mck-id");r===v.contactId?x===ze[2]?(k[v.contactId]=!1,Ze.toggleBlockUser(r,!1)):(a.MCK_OL_MAP[r]||I[r])&&(C[v.contactId]=!1,k[r]||(a.MCK_OL_MAP[r]?E.html(MCK_LABELS.online):I[r]&&E.html(mckDateUtils.getLastSeenAtStatus(I[r])),b.addClass("mck-tab-title-w-status"),E.removeClass("n-vis").addClass("vis"))):a.MCK_OL_MAP[r]&&t("#li-user-"+v.htmlId+" .mck-ol-status").removeClass("n-vis").addClass("vis"),n.onUserUnblocked({status:x,userId:m})}else if("APPLOZIC_18"===o)O=!1,n.onUserActivated();else if("APPLOZIC_19"===o)O=!0,n.onUserDeactivated();else{var L=s.message;if("APPLOZIC_03"===o)ALStorage.updateLatestMessage(L),0!==L.type&&4!==L.type&&(t("."+L.key+" .mck-message-status").removeClass("mck-pending-icon").addClass("mck-sent-icon"),at.addTooltip(L.key)),n.onMessageSentUpdate({messageKey:L.key});else if("APPLOZIC_01"===o||"APPLOZIC_02"===o||"MESSAGE_RECEIVED"===o){ALStorage.updateLatestMessage(L);var v=L.groupId?Xe.getGroup(L.groupId):at.getContact(L.to),r=(t("#mck-sidebox-content"),S.data("mck-id"));if("APPLOZIC_01"===o||"MESSAGE_RECEIVED"===o){var A=at.getMessageFeed(L);n.onMessageReceived({message:A})}else if("APPLOZIC_02"===o){var A=at.getMessageFeed(L);n.onMessageSent({message:A})}if(L.conversationId){var _=M[L.conversationId];!_e&&!ye||"object"==typeof _&&"object"==typeof y[_.topicId]||nt.getTopicId({conversationId:L.conversationId,messageType:o,message:L,notifyUser:s.notifyUser,async:!1,populate:!1},function(e){at.populateMessage(e.messageType,e.message,e.notifyUser)})}if(void 0===v){var w={message:L,messageType:o,notifyUser:s.notifyUser};if(L.groupId)et.getGroupFeedFromMessage(w);else{var h=[];h.push(L.to),ot.getUsersDetail(h,w)}return}if(102==L.contentType&&P)if(s.notifyUser=!1,4==L.type&&"CALL_DIALED"==L.metadata.MSG_TYPE){var v=at.fetchContact(L.to),G=at.getTabDisplayName(v.contactId,!1),U=at.getContactImageLink(v,G);t("#mck-video-call-indicator").data("call-id",L.metadata.CALL_ID),t("#mck-video-call-indicator").data("isAudioCall",L.metadata.CALL_AUDIO_ONLY),t("#mck-video-call-indicator-txt").html(G+" calling..."),t("#mck-video-call-icon").html(U),t("#mck-video-call-indicator").removeClass("n-vis").addClass("vis"),ft.play(),setTimeout(function(){var e=t("#mck-video-call-indicator").data("callReceived");e||(console.log("call is not answered"),ft.stop(),t("#mck-video-call-indicator").addClass("n-vis").removeClass("vis"))},6e4)}else if(4==L.type&&"CALL_REJECTED"==L.metadata.MSG_TYPE&&t("#mck-btn-video-call").data("isCallHost")){var K=$mck_msg_to.val();nt.sendVideoCallMessage(L.metadata.CALL_ID,"CALL_REJECTED",103,!1,K,function(e){st.sendMessage(e)}),pt.ringToneForHost.stop(),pt.outgoingCallServices.twilioService.leaveRoomIfJoined(),pt.hideVideoBox(),pt.outgoingCallServices&&(pt.outgoingCallServices.rejectedByReceiver=!0)}103==L.contentType?4==L.type&&"CALL_MISSED"==L.metadata.MSG_TYPE&&(t("#mck-video-call-indicator").addClass("n-vis").removeClass("vis"),ft&&ft.stop()):at.populateMessage(o,L,s.notifyUser)}}}}}(l);l.getOptions=function(){return n},l.init=function(){window.Applozic.ALApiService.initServerUrl(MCK_BASE_URL),rt.get(n),nt.init(n),lt.init(n),at.init(),vt.loop=!1,ke&&(L=new RingToneService,ut=L.loadRingTone(ke,vt)),st.init(),tt.init(),et.init(),Ye.initializeApp(n,!1),it.init(),We.init(),x&&(document.getElementById("mck-btn-smiley-box").classList.remove("n-vis"),at.initEmojis()),P&&(vt.loop=!0,L=new RingToneService,ft=L.loadRingTone(Kommunicate.BASE_URL[MCK_BASE_URL]+"/plugin/audio/applozic_video_call_ring_tone.mp3",vt),pt.init())},l.reInit=function(e){KommunicateUtils.storeDataIntoKmSession("appOptions",e),"object"===t.type(e)&&(e=t.extend(!0,{},o,e),n.conversationTitle=n.conversationTitle||n.groupName,n.accessToken=n.password||n.accessToken,t.fn.applozic("reset",e),e.userId&&e.appId&&""!==t.trim(e.userId)&&""!==t.trim(e.appId)?(Ye.initializeApp(e,!0),n=e):a.console("Oops! looks like incorrect application id or user Id."))},l.loadTabView=function(e){void 0===e.isGroup&&(e.isGroup=!1),at.loadTab(e),t("#mck-search").val("")},l.loadTab=function(e,a){at.loadTab({tabId:e,isGroup:!1},a),t("#mck-search").val("")},l.loadChat=function(e){if(!(void 0!==e.userId&&""!==e.userId||void 0!==e.groupId&&""!==e.groupId||void 0!==e.clientGroupId&&""!==e.clientGroupId))return"UserId or groupId or clientGroupId required";var a={tabId:e.userId,isGroup:!1},a={};if(e.userId&&(a.tabId=userId,a.isGroup=!1),e.displayName&&(a.userName=e.displayName),e.convId&&(a.conversationId=e.convId),e.groupId||e.clientGroupId)if(a.isGroup=!0,e.clientGroupId){a.clientGroupId=e.clientGroupId;var s=Xe.getGroupByClientGroupId(e.clientGroupId);if("object"!=typeof s)return Qe.getGroupFeed({clientGroupId:a.clientGroupId,apzCallback:et.onGroupFeed,callback:et.loadGroupTab}),void t("#mck-search").val("");a.tabId=s.contactId}else{var s=Xe.getGroup(e.groupId);if("object"!=typeof s)return Qe.getGroupFeed({groupId:e.groupId,apzCallback:et.onGroupFeed,callback:et.loadGroupTab}),void t("#mck-search").val("");a.tabId=e.groupId}at.loadTab(a),t("#mck-search").val("")},l.uploadFile=function(e){tt.uploadFile(e)},l.audioAttach=function(e){tt.audioRecoder(e)},l.loadGroupTab=function(e){if(void 0===e||""===e)return"GroupId required";var a=Xe.getGroup(e);"object"==typeof a?(at.loadTab({tabId:e,isGroup:!0}),t("#mck-search").val("")):Qe.getGroupFeed({groupId:e,apzCallback:et.onGroupFeed,callback:et.loadGroupTab})},l.loadGroupTabByClientGroupId=function(e){if(void 0===e.clientGroupId||""===e.clientGroupId)return"Client Group Id Required";var a=Xe.getGroupByClientGroupId(e.clientGroupId);"object"==typeof a?(at.loadTab({tabId:a.contactId,isGroup:!0}),t("#mck-search").val("")):Qe.getGroupFeed({clientGroupId:e.clientGroupId,apzCallback:et.onGroupFeed,callback:et.loadGroupTab})},l.loadConvTab=function(e){"object"==typeof e&&e.userId&&e.convId&&at.loadTab({tabId:e.userId,conversationId:e.convId,isGroup:!1})},l.loadTabWithTopic=function(e){if("object"==typeof e&&(e.userId||e.groupId)&&e.topicId){var t={tabId:e.userId,topicId:e.topicId};if(e.userName&&(t.userName=e.userName),e.topicStatus?t.topicStatus=-1===Re.indexOf(e.topicStatus)?Re[0]:e.topicStatus.toString():t.topicStatus=Re[0],"function"==typeof ae||e.topicDetail){var a=e.topicDetail?e.topicDetail:ae(e.topicId);"object"==typeof a&&"undefined"!==a.title&&(y[e.topicId]=a)}if(e.message){var s={type:5,contentType:0,message:message};t.messagePxy=s,t.isMessage=!0}else t.isMessage=!1;e.supportId?(t.isGroup=!0,t.supportId=supportId):(t.isGroup=!1,t.userId=e.userId),st.getConversationId(t)}else{if(!e.userId||!e.groupId)return"UserId required";if(!e.topicId)return"TopicId required"}},l.loadContacts=function(e){at.loadContacts(e)},l.loadContactsForContactList=function(e){at.loadContactsForContactList(e)},l.setOffline=function(){void 0!==yt&&yt.sendStatus(0)},l.reset=function(e){a.sessionStorage.clear(),r="",c="",p=[],MCK_GROUP_MAP=[],u=!0,v=[],d="",S=e.mode,"",k=[],C=[],f=!1,h=90,w=e.appId,I=[],M=[],y=[],MCK_CLIENT_GROUP_MAP=[],T=!0,MCK_LABELS=e.labels,E=0,MCK_BASE_URL=e.baseUrl,fe=e.fileupload,A=e.customFileUrl,Be=new Object,Pe=new Array,D=e.launcher,0,G=[],z=e.userName,R=e.visitor,N=[],$e=new Array,Fe=new Object,F=e.fileBaseUrl,B=e.locShare,P=n.video,q=e.onInit,H=e.onTopicDetails,qe=new Array,He=new Array,V=e.onClose,J=e.accessToken,Y=e.displayText,W=e.readConversation,Z=e.maxGroupSize,Ve=new Array,Q=e.onTabClicked,X=e.contactNumber,te=e.appModuleName,ae=e.getTopicDetail,ee=e.maxAttachmentSize,oe=e.validateMessage,se=e.contactDisplayName,je=new Array,ie=e.finalPriceResponse,ne=e.contactDisplayImage,re=e.priceWidget,ce=n.openGroupSettings,le=e.offlineMessageDetail,e.initAutoSuggestions,me=e.getConversationDetail,de=e.authenticationTypeId,Ce=R?"guest":t.trim(e.userId),he=B?e.googleApiKey:"NO_ACCESS",Ie="boolean"==typeof e.olStatus&&e.olStatus,ye="boolean"==typeof e.topicBox&&e.topicBox,Te="boolean"==typeof e.showOfflineMessage&&e.showOfflineMessage,_e="boolean"==typeof e.topicHeader&&e.topicHeader,Ue="boolean"!=typeof e.notification||e.notification,"boolean"==typeof e.swNotification&&e.swNotification,e.supportId?'data-mck-id="'+e.supportId+'"':"",Ee="boolean"==typeof e.hideGroupSubtitle&&e.hideGroupSubtitle,xe=void 0===e.defaultMessageMetaData?{}:e.defaultMessageMetaData,Se="boolean"==typeof e.groupUserCount&&e.groupUserCount,Ge="boolean"==typeof e.desktopNotification&&e.desktopNotification,we="boolean"==typeof e.loadOwnContacts&&e.loadOwnContacts,Me="boolean"==typeof e.messageBubbleAvator&&e.messageBubbleAvator,Ae="boolean"==typeof n.resetUserStatus&&n.resetUserStatus,Ne="boolean"==typeof e.launchOnNewMessage&&e.launchOnNewMessage,Ke="boolean"!=typeof e.autoTypeSearchEnabled||e.autoTypeSearchEnabled,Le="boolean"==typeof e.checkUserBusyWithStatus&&e.checkUserBusyWithStatus,Oe="boolean"==typeof e.launchOnUnreadMessage&&e.launchOnUnreadMessage,kt=n.askUserDetails},l.logout=function(){void 0!==yt&&(yt.disconnect(),ALStorage.clearMckMessageArray(),t.fn.applozic("reset",n),t("#mck-sidebox").hide(),t("#mck-sidebox-launcher").hide()),u=!1},l.setOnline=function(){void 0!==yt&&yt.sendStatus(1)},l.getUserStatus=function(e){"function"==typeof e.callback&&(void 0!==e.userIds?ot.getUsersDetail(e.userIds,e):dt.getUserStatus(e,function(e){t.each(e.users,function(e,t){var a=at.getContact(""+t.userId);a=void 0===a?at.createContactWithDetail(t):at.updateContactDetail(a,t),je.push(a.contactId)})}))},l.getGroupList=function(e){return"function"==typeof e.callback?(e.apzCallback=et.loadGroups,Qe.loadGroups(e),"success"):"Callback Function Required"},l.leaveGroup=function(e){return"object"!=typeof e?"Unsupported Format. Please check format":"function"==typeof e.callback?void 0!==e.groupId&&""!==e.groupId||void 0!==e.clientGroupId&&""!==e.clientGroupId?(e.apzCallback=et.onGroupLeft,Qe.leaveGroup(e),"success"):void e.callback({status:"error",errorMessage:"GroupId or Client GroupId Required"}):"Callback Function Required"},l.addGroupMember=function(e){return"object"!=typeof e?"Unsupported Format. Please check format":"function"==typeof e.callback?void 0!==e.groupId&&""!==e.groupId||void 0!==e.clientGroupId&&""!==e.clientGroupId?void 0===e.userId||""===e.userId?void e.callback({status:"error",errorMessage:"UserId required"}):void 0!==e.role&&-1===U.indexOf(e.role)?void e.callback({status:"error",errorMessage:"Incorrect member role"}):(dt.loadUserProfile(e.userId),e.apzCallback=et.onAddedGroupMember,Qe.addGroupMember(e),"success"):void e.callback({status:"error",errorMessage:"GroupId or clientGroupId required"}):"Callback function required"},l.removeGroupMember=function(e){return"object"!=typeof e?"Unsupported Format. Please check format":"function"==typeof e.callback?void 0!==e.groupId&&""!==e.groupId||void 0!==e.clientGroupId&&""!==e.clientGroupId?void 0===e.userId||""===e.userId?void e.callback({status:"error",errorMessage:"UserId required"}):(e.apzCallback=et.onRemovedGroupMember,Qe.removeGroupMemberFromChat(e),"success"):void e.callback({status:"error",errorMessage:"GroupId or clientGroupId required"}):"Callback function required"},l.updateGroupInfo=function(e){if("object"!=typeof e)return"Unsupported format. Please check format";if("function"==typeof e.callback){if(!(void 0!==e.groupId&&""!==e.groupId||void 0!==e.clientGroupId&&""!==e.clientGroupId))return void e.callback({status:"error",errorMessage:"GroupId or clientGroupId required"});if(!(void 0!==e.name&&""!==e.name||void 0!==e.imageUrl&&""!==e.imageUrl||e.users&&0!==e.users.length))return void e.callback({status:"error",errorMessage:"Group properties required"});if(e.users&&e.users.length>0){var a=[];if(t.each(e.users,function(e,t){t.userId&&void 0!==t.role&&-1!==U.indexOf(t.role)&&a.push(t)}),0===a.length)return void e.callback({status:"error",errorMessage:"Incorrect users detail"})}var a=[];return t(".mck-group-change-role-box.vis").each(function(e,s){var o=t(this),i=parseInt(o.find("select").val()),n=o.parents(".mck-li-group-member").data("role");if(i!==n){var r={userId:o.parents(".mck-li-group-member").data("mck-id"),role:i};a.push(r)}}),e.apzCallback=et.onUpdateGroupInfo,Qe.updateGroupInfo(e),"success"}return"Callback function required"},l.getMessages=function(e){"function"==typeof e.callback&&nt.getMessages(e)},l.getMessageList=function(e){return void 0!==e&&"function"==typeof e.callback?(nt.getMessageList(e,function(e){if(void 0!==e.to||void 0!==e.groupId){var t=at.getMessageFeed(e);messageFeeds.push(t)}}),"success"):"Callback function required"},l.getMessageListByTopicId=function(e){if("object"!=typeof e)return"Unsupported format. Please check format";if("function"==typeof e.callback){if(!(void 0!==e.id&&""!==e.id||void 0!==e.clientGroupId&&""!==e.clientGroupId))return void e.callback({status:"error",errorMessage:"Id or clientGroupId required"});if(e.id&&"boolean"!=typeof e.isGroup)return void e.callback({status:"error",errorMessage:"IsGroup parameter required"});if(!e.topicId)return void e.callback("TopicId required");e.id&&(e.tabId=e.id),e.topicStatus=Re[0];var t=N[e.topicId];return t&&"object"==typeof M[t]?(e.conversationId=t,nt.getMessageList(e,function(e){if(void 0!==e.to||void 0!==e.groupId){var t=at.getMessageFeed(e);messageFeeds.push(t)}})):(e.isExtMessageList=!0,e.pageSize=1,nt.fetchConversationByTopicId(e,function(e){st.getMessageList(e)})),"success"}return"Callback function required."},l.sendMessage=function(e){if("object"==typeof e){var a=(e=t.extend(!0,{},i,e)).message;if(!e.to)return"To field required";if(void 0===a||""===a)return"Message field required";if(e.type>12)return"Invalid message type";a=t.trim(a);var s={to:t.trim(e.to),type:e.messageType,contentType:e.type,message:a,metadata:e.metadata};return st.sendMessage(s),"success"}return"Unsupported format. Please check format"},l.updateUserIdentity=function(e){ot.updateUserIdentity(e)},l.updateUser=function(e){ot.updateUser(e)},l.getGroupListByFilter=function(e){Qe.getGroupByFilter(e)},l.updateMessageMetadata=function(e){st.updateMessageMetadata(e)},l.sendGroupMessage=function(e){if("object"==typeof e){var a=(e=t.extend(!0,{},i,e)).message;if(!e.groupId&&!e.clientGroupId)return"groupId or clientGroupId required";if(void 0===a||""===a)return"message field required";if(e.type>12)return"invalid message type";a=t.trim(a);var s={type:e.messageType,contentType:e.type,message:a,metadata:e.metadata||{}};if(e.groupId)s.groupId=t.trim(e.groupId);else if(e.clientGroupId){var o=Xe.getGroupByClientGroupId(e.clientGroupId);if(void 0===o)return"group not found";s.clientGroupId=t.trim(e.clientGroupId)}return st.sendMessage(s),"success"}return"Unsupported format. Please check format"},l.addWelcomeMessage=function(e){return"object"!=typeof e?"Unsupported format. Please check format":void 0===e.sender||""===e.sender?"Sender Field Required":void 0===e.messageContent||""===e.messageContent?"Message Content Required":void st.sendWelcomeMessage(e)},l.createGroup=function(e){if("object"==typeof e){if("function"==typeof e.callback){var t=e.users;return void 0===t||t.length<1?void e.callback({status:"error",errorMessage:"Users list required"}):t.length>Z?void e.callback({status:"error",errorMessage:"Users limit exceeds "+Z+". Max number of users allowed is "+Z+"."}):e.groupName?void 0===e.type||""===e.type?void e.callback({status:"error",errorMessage:"Group type required"}):-1===K.indexOf(e.type)?void e.callback({status:"error",errorMessage:"Invalid group type"}):(st.getGroup(e),"success"):void e.callback({status:"error",errorMessage:"Group name required"})}return"Callback function required"}return"Unsupported Format. Please check format"},l.initGroupTab=function(e){if("object"==typeof e){var t=e.users;return void 0===t||t.length<1?"Users List Required":t.length>Z?"Users limit exceeds "+Z+". Max number of users allowed is "+Z+".":e.groupName?void 0===e.type?"Group type required":-1===K.indexOf(e.type)?"Invalid group type":(st.getGroup(e),"success"):"Group name required"}return"Unsupported format. Please check format"},l.getTotalUnreadCount=function(){return E},l.subscribeToEvents=function(e){"object"==typeof e&&("function"==typeof e.onConnectFailed&&(l.events.onConnectFailed=e.onConnectFailed),"function"==typeof e.onConnect&&(l.events.onConnect=e.onConnect),"function"==typeof e.onMessageDelivered&&(l.events.onMessageDelivered=e.onMessageDelivered),"function"==typeof e.onMessageRead&&(l.events.onMessageRead=e.onMessageRead),"function"==typeof e.onMessageDeleted&&(l.events.onMessageDeleted=e.onMessageDeleted),"function"==typeof e.onConversationDeleted&&(l.events.onConversationDeleted=e.onConversationDeleted),"function"==typeof e.onUserConnect&&(l.events.onUserConnect=e.onUserConnect),"function"==typeof e.onUserDisconnect&&(l.events.onUserDisconnect=e.onUserDisconnect),"function"==typeof e.onConversationReadFromOtherSource&&(l.events.onConversationReadFromOtherSource=e.onConversationReadFromOtherSource),"function"==typeof e.onConversationRead&&(l.events.onConversationRead=e.onConversationRead),"function"==typeof e.onMessageReceived&&(l.events.onMessageReceived=e.onMessageReceived),"function"==typeof e.onMessageSentUpdate&&(l.events.onMessageSentUpdate=e.onMessageSentUpdate),"function"==typeof e.onMessageSent&&(l.events.onMessageSent=e.onMessageSent),"function"==typeof e.onUserBlocked&&(l.events.onUserBlocked=e.onUserBlocked),"function"==typeof e.onUserUnblocked&&(l.events.onUserUnblocked=e.onUserUnblocked),"function"==typeof e.onUserActivated&&(l.events.onUserActivated=e.onUserActivated),"function"==typeof e.onUserDeactivated&&(l.events.onUserDeactivated=e.onUserDeactivated))},l.getConversation=function(e){nt.getTopicId({conversationId:e.conversationId},function(e){at.populateMessage(e.messageType,e.message,e.notifyUser)})}}(n);l.data("applozic_instance",p),p.init()}else alert("Oops! looks like incorrect application id or user Id.")},t.fn.applozic.defaults=o}($applozic,window,document),Kommunicate.attachEvents=function(e){e("#mck-message-cell").on("click",".km-increment-guest-count",Kommunicate.richMsgEventHandler.incrementGuestCount),e("#mck-message-cell").on("click",".km-decrement-guest-count",Kommunicate.richMsgEventHandler.decrementGuestCount),e("#mck-message-cell").on("click",".km-btn-add-more-rooms",Kommunicate.richMsgEventHandler.addMoreRoom),e("#mck-message-cell").on("click",".km-done-button",Kommunicate.richMsgEventHandler.processSelectedRoom),e("#mck-message-cell").on("click",".km-card-message-footer-button",Kommunicate.richMsgEventHandler.processHotelBookClick),e("#mck-message-cell").on("click",".km-cta-button",Kommunicate.richMsgEventHandler.handlleRichButtonClick),e("#mck-message-cell").on("click",".km-submit-person-detail",Kommunicate.richMsgEventHandler.handlleSubmitPersonDetail),e("#mck-message-cell").on("click",".km-block-room-button",Kommunicate.richMsgEventHandler.processBookRoomClick),e("#mck-message-cell").on("click",".km-quick-replies",Kommunicate.richMsgEventHandler.processQuickReplies),e("#mck-message-cell").on("click",".km-list-item-handler",Kommunicate.richMsgEventHandler.processClickOnListItem),e("#mck-message-cell").on("click",".km-list-button-item-handler",Kommunicate.richMsgEventHandler.processClickOnButtonItem),e("#mck-message-cell").on("click",".km-faq-dialog-button",Kommunicate.richMsgEventHandler.processClickOnDialogButton)},Kommunicate.richMsgEventHandler={initializeSlick:function(e){if(e.length>0)tns({container:e[0],items:1,slideBy:"page",mouseDrag:!0,arrowKeys:!0,onInit:function(){console.log("tiny-slider initilized"),document.querySelector(".km-slick-container .tns-controls button:first-child").innerHTML="<",document.querySelector(".km-slick-container .tns-controls button:last-child").innerHTML=">"}})},decrementGuestCount:function(e){var t=e.target||e.srcElement,a=t.dataset.type;"guest"==a?t.parentElement.getElementsByClassName("km-room-number-field")[0].stepDown():"children"==a&&t.parentElement.getElementsByClassName("km-person-number-field")[0].stepDown()},incrementGuestCount:function(e){var t=e.target||e.srcElement,a=t.dataset.type;"guest"==a?t.parentElement.getElementsByClassName("km-room-number-field")[0].stepUp():"children"==a&&t.parentElement.getElementsByClassName("km-person-number-field")[0].stepUp()},decrementPersonCount:function(){document.getElementById("km-person-number-field").stepDown()},incrementPersonCount:function(){document.getElementById("km-person-number-field").stepUp()},addMoreRoom:function(e){var t=e.target.parentElement.parentElement.parentElement,a=Number(e.target.dataset.roomcount)+1;e.target.setAttribute("data-roomcount",a);var s=document.createElement("div");s.innerHTML=Kommunicate.markup.getSingleRoomPaxInfo(a),t.getElementsByClassName("km-room-person-selector-container")[0].appendChild(s)},processSelectedRoom:function(e){for(var t=[],a=$(e.target).closest(".mck-msg-box-rich-text-container").find(".km-room-person-selector-container input.km-room-number-field"),s=$(e.target).closest(".mck-msg-box-rich-text-container").find(".km-room-person-selector-container input.km-person-number-field"),o="",i=0;i<a.length;i++){let e=s[i].value,n=Array(1*e).fill(10);t.push({NoOfAdults:a[i].value,NoOfChild:e,ChildAge:n}),o+="Room "+(i+1)+" Guest "+a[i].value+"\n"}var n={message:o,metadata:{isRoomGuestJSON:!0,roomGuestJson:JSON.stringify(t),guestTypeId:"ADULTS"}};Kommunicate.sendMessage(n)},processHotelBookClick:function(e){var t=e.target||e.srcElement,a=t.dataset.sessionid,s=t.dataset.resultindex,o={message:"Get room detail of "+t.dataset.name.replace("_"," "),metadata:{hotelSelected:!0,sessionId:a,resultIndex:s,skipDialogflow:!0}};Kommunicate.sendMessage(o)},processBookRoomClick:function(e){var t=e.target||e.srcElement,a=t.dataset.sessionid,s=t.dataset.roomindex,o=t.dataset.noofrooms,i="undefined"==t.dataset.hotelname?"":t.dataset.hotelname,n=t.dataset.hotelresultindex,r={message:"Book "+i.replace("_"," "),metadata:{sessionId:a,RoomIndex:s,NoOfRooms:o,blockHotelRoom:!0,skipDialogflow:!0,HotelResultIndex:n}},c=$applozic("#mck-message-cell .mck-message-inner"),l=$applozic("#mck-msg-to");!0===c.data("isgroup")?r.groupId=l.val():r.to=l.val(),$applozic.fn.applozic("sendGroupMessage",r)},handlleRichButtonClick:function(e){var t=e.target||e.srcElement;"km-eh-001"==t.dataset.eventhandlerid&&t.parentElement.getElementsByClassName("km-btn-hidden-form")[0].submit()},handlleSubmitPersonDetail:function(e){var t=$applozic(e.target).closest(".km-guest-details-container").find(".km-title-select option:selected").text(),a=$applozic(e.target).closest(".km-guest-details-container").find(".km-guest-detail-form input.km-age-input"),s=$applozic(e.target).closest(".km-guest-details-container").find(".km-guest-detail-form input.first-name-input"),o=$applozic(e.target).closest(".km-guest-details-container").find(".km-guest-detail-form input.middle-name-input"),i=$applozic(e.target).closest(".km-guest-details-container").find(".km-guest-detail-form input.last-name-input"),n=$applozic(e.target).closest(".km-guest-details-container").find(".km-guest-detail-form input.e-mail-input"),r=$applozic(e.target).closest(".km-guest-details-container").find(".km-guest-detail-form input.number-input");if(""!=s[0].value&&""!=i[0].value&&""!=n[0].value&&""!=r[0].value){var c={Title:"title"===t?"":t,Age:a[0].value,FirstName:s[0].value,MiddleName:o[0].value,LastName:i[0].value,EmailId:n[0].value,PhoneNo:r[0].value},l=(e.target||e.srcElement).dataset.sessionid,d={message:c.Title+" "+c.FirstName+" "+c.LastName+"\n"+c.EmailId+"\n"+c.PhoneNo,metadata:{sessionId:l,guestDetail:!0,skipDialogflow:!0,personInfo:JSON.stringify(c)}};Kommunicate.sendMessage(d),console.log("passenger detail submitted")}else $applozic(e.target).closest(".km-guest-details-container").find(".km-mandatory-field-error").removeClass("n-vis").addClass("vis")},processQuickReplies:function(e){var t={message:e.target.title,metadata:{}};Kommunicate.sendMessage(t)},processClickOnListItem:function(e){var t=e.currentTarget,a=t.dataset.reply,s=t.dataset.type,o=t.dataset.articleid,i=t.dataset.source;if(s&&"quick_reply"==s){var n={message:a,metadata:{KM_FAQ_ID:o,source:i}};Kommunicate.sendMessage(n)}},processClickOnButtonItem:function(e){var t=e.currentTarget,a=t.dataset.reply,s=t.dataset.type;if(s&&"quick_reply"==s){var o={message:a,metadata:{KM_BUTTON_CLICKED:!0}};Kommunicate.sendMessage(o)}},processClickOnDialogButton:function(e){var t={message:e.currentTarget.dataset.reply,metadata:{skipBot:!0}};Kommunicate.sendMessage(t)}},KommunicateUI={awayMessageInfo:{},isLeadCollectionEnabled:!1,CONSTS:{},populateAwayMessage:function(e,t){var a=$applozic("#mck-tab-individual").hasClass("n-vis");!e&&"SUCCESS"==t.code&&t.data.messageList.length>0&&!a?(KommunicateUI.isLeadCollectionEnabled=t.data.collectEmail,KommunicateUI.awayMessageInfo.isEnabled=!0,KommunicateUI.awayMessageInfo.eventId=t.data.messageList[0].eventId,awayMessage=t.data.messageList[0].message,$applozic("#mck-away-msg").html(awayMessage),$applozic("#mck-away-msg-box").removeClass("n-vis").addClass("vis")):$applozic("#mck-away-msg-box").removeClass("vis").addClass("n-vis")},hideAwayMessage:function(){$applozic("#mck-away-msg-box").removeClass("vis").addClass("n-vis")},displayLeadCollectionTemplate:function(e){if(e&&e.length){let a=0;for(var t=0;t<e.length&&(5!=e[t].type||2!=++a);t++);1==a?KommunicateUI.isLeadCollectionEnabled&&KommunicateUI.awayMessageInfo.isEnabled&&1==KommunicateUI.awayMessageInfo.eventId&&(this.populateLeadCollectionTemplate(),this.hideAwayMessage()):this.hideLeadCollectionTemplate()}else null==e&&(this.populateLeadCollectionTemplate(),this.hideAwayMessage())},populateLeadCollectionTemplate:function(){$applozic("#mck-email-collection-box").removeClass("n-vis").addClass("vis"),$applozic("#mck-btn-attach-box").removeClass("vis").addClass("n-vis"),$applozic("#mck-text-box").blur(),$applozic("#mck-text-box").attr("data-text","Your email ID")},hideLeadCollectionTemplate:function(){$applozic("#mck-email-collection-box").removeClass("vis").addClass("n-vis"),$applozic("#mck-email-error-alert-box").removeClass("vis").addClass("n-vis"),$applozic("#mck-btn-attach-box").removeClass("n-vis").addClass("vis"),$applozic("#mck-text-box").attr("data-text","Type your message...")},validateEmail:function(e){return e.match(/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/)?($applozic("#mck-email-error-alert-box").removeClass("vis").addClass("n-vis"),this.hideLeadCollectionTemplate(),$applozic("#mck-away-msg-box").removeClass("n-vis").addClass("vis"),window.$applozic.fn.applozic("updateUser",{data:{email:e}}),!0):($applozic("#mck-email-error-alert-box").removeClass("n-vis").addClass("vis"),$applozic("#mck-email-collection-box").removeClass("vis").addClass("n-vis"),!1)},faqEvents:function(e,t){var a;$applozic(d).on("click","#mck-msg-preview, #mck-msg-preview-visual-indicator .mck-msg-preview-visual-indicator-text",function(){KommunicateUI.showChat()}),$applozic(d).on("click",".km-faq-list",function(){$applozic("#km-faqanswer").empty(),"km-faq-answer-list"!==MCK_EVENT_HISTORY[MCK_EVENT_HISTORY.length-1]&&MCK_EVENT_HISTORY.push("km-faq-answer-list");var a=$(this).attr("data-articleid"),s=$(this).attr("data-source");KommunicateKB.getArticle({data:{appId:e.appId,articleId:a,source:s,helpdocsAccessKey:t},success:function(e){0==$applozic("#km-faqanswer .km-faqanswer-list").length&&($applozic("#km-faqanswer").append('<div class="km-faqanswer-list km-faqanswerscroll"><div class="km-faqquestion">'+e.data.title+'</div> <div class="km-faqanchor km-faqanswer">'+e.data.body+"</div></div>"),$applozic("#km-contact-search-input-box").removeClass("vis").addClass("n-vis"),$applozic("#km-faqdiv").removeClass("vis").addClass("n-vis"),$applozic("#km-faqanswer").removeClass("n-vis").addClass("vis"),$applozic("#mck-tab-individual").removeClass("n-vis").addClass("vis"),$applozic("#mck-tab-conversation").removeClass("vis").addClass("n-vis"),$applozic("#mck-no-conversations").removeClass("vis").addClass("n-vis"))},error:function(){}}),$applozic(".km-contact-input-container").removeClass("vis").addClass("n-vis")}),$applozic(d).on("click","#km-faq",function(){KommunicateUI.showHeader(),"km-faq-list"!==MCK_EVENT_HISTORY[MCK_EVENT_HISTORY.length-1]&&MCK_EVENT_HISTORY.push("km-faq-list"),$applozic("#km-contact-search-input-box").removeClass("n-vis").addClass("vis"),$applozic("#km-faq").removeClass("vis").addClass("n-vis"),$applozic("#mck-no-conversations").removeClass("vis").addClass("n-vis"),$applozic(".faq-common").removeClass("n-vis").addClass("vis"),$applozic(".mck-conversation ").removeClass("vis").addClass("n-vis"),$applozic("#km-faqdiv").removeClass("n-vis").addClass("vis"),$applozic(".mck-conversation-back-btn").removeClass("n-vis").addClass("vis"),$applozic("#mck-tab-title").html("FAQ").removeClass("n-vis").addClass("vis"),$applozic("#mck-away-msg-box").addClass("n-vis").removeClass("vis"),$applozic("#mck-sidebox-ft").addClass("n-vis").removeClass("vis"),$applozic("#mck-contacts-content").addClass("n-vis").removeClass("vis"),$applozic("#mck-msg-new").attr("disabled",!1),$applozic(".km-contact-input-container").removeClass("n-vis").addClass("vis"),$applozic("#mck-conversation-back-btn").removeClass("km-visibility-hidden").addClass("vis-table")}),$applozic(d).on("click","#km-faqanswer a",function(e){e.preventDefault(),window.open(e.target.href)}),$applozic("#km-faq-search-input").keydown(function(s){clearTimeout(a),a=setTimeout(function(){KommunicateKB.getArticles({data:{appId:e.appId,query:document.getElementById("km-faq-search-input").value,helpdocsAccessKey:t},success:function(e){e.data&&0===e.data.length&&$applozic(".km-no-results-found-container").hasClass("n-vis")?($applozic(".km-no-results-found-container").addClass("vis").removeClass("n-vis"),$applozic(".km-talk-to-human-div p").text("We are here to help."),$applozic(".km-talk-to-human-div").addClass("vis").removeClass("n-vis")):($applozic(".km-no-results-found-container").addClass("n-vis").removeClass("vis"),$applozic(".km-talk-to-human-div p").text("Looking for something else? "),$applozic(".km-talk-to-human-div").addClass("vis").removeClass("n-vis")),$applozic("#km-faqdiv").empty(),$applozic.each(e.data,function(e,t){$applozic("#km-faqdiv").append('<li class="km-faq-list" data-source="'+t.source+'" data-articleId="'+t.articleId+'"><a class="km-faqdisplay"> <div><div class="km-faqimage"></div></div> <div class="km-faqanchor">'+t.title+"</div></a></li>")})},error:function(){}})},2e3),32!=s.which&&13!=s.which||KommunicateKB.getArticles({data:{appId:e.appId,query:document.getElementById("km-faq-search-input").value,helpdocsAccessKey:t},success:function(e){e.data&&0===e.data.length&&$applozic(".km-no-results-found-container").hasClass("n-vis")?($applozic(".km-no-results-found-container").addClass("vis").removeClass("n-vis"),$applozic(".km-talk-to-human-div p").text("We are here to help. "),$applozic(".km-talk-to-human-div").addClass("vis").removeClass("n-vis")):($applozic(".km-no-results-found-container").addClass("n-vis").removeClass("vis"),$applozic(".km-talk-to-human-div p").text("Looking for something else? "),$applozic(".km-talk-to-human-div").addClass("vis").removeClass("n-vis")),$applozic("#km-faqdiv").empty(),$applozic.each(e.data,function(e,t){$applozic("#km-faqdiv").append('<li class="km-faq-list" data-source="'+t.source+'" data-articleId="'+t.articleId+'"><a class="km-faqdisplay"> <div><span class="km-faqimage"/ ></span> <div class="km-faqanchor ">'+t.title+"</div></a></li>")})},error:function(){}})}),$applozic(d).on("click","#mck-conversation-back-btn",function(){if($applozic(".km-contact-input-container").removeClass("vis").addClass("n-vis"),MCK_EVENT_HISTORY.length>=2){if("km-faq-list"==MCK_EVENT_HISTORY[MCK_EVENT_HISTORY.length-2])return KommunicateUI.showHeader(),$applozic("#km-faqdiv").removeClass("n-vis").addClass("vis"),$applozic("#km-faqanswer").removeClass("vis").addClass("n-vis"),$applozic("#km-contact-search-input-box").removeClass("n-vis").addClass("vis"),$applozic("#mck-msg-new").attr("disabled",!1),$applozic(".km-contact-input-container").removeClass("n-vis").addClass("vis"),void MCK_EVENT_HISTORY.splice(MCK_EVENT_HISTORY.length-1,1);if("object"==typeof MCK_EVENT_HISTORY[MCK_EVENT_HISTORY.length-2]){$applozic(".mck-conversation ").removeClass("n-vis").addClass("vis"),$applozic("#mck-tab-conversation").removeClass("n-vis").addClass("vis"),$applozic("#km-faqdiv").removeClass("vis").addClass("n-vis"),$applozic("#km-faqanswer").removeClass("vis").addClass("n-vis"),$applozic("#km-contact-search-input-box").removeClass("vis").addClass("n-vis"),$applozic("#km-faq").removeClass("n-vis").addClass("vis");let e=MCK_EVENT_HISTORY[MCK_EVENT_HISTORY.length-2];return $applozic.fn.applozic("openChat",e),MCK_EVENT_HISTORY.splice(MCK_EVENT_HISTORY.length-1,1),void KommunicateUI.activateTypingField()}return $applozic("#km-faq").removeClass("n-vis").addClass("vis"),$applozic("#mck-msg-new").attr("disabled",!1),MCK_EVENT_HISTORY.splice(MCK_EVENT_HISTORY.length-1,1),void(MCK_EVENT_HISTORY.length=0)}return $applozic(".mck-conversation ").removeClass("n-vis").addClass("vis"),$applozic("#km-faqdiv").removeClass("vis").addClass("n-vis"),$applozic("#km-faqanswer").removeClass("vis").addClass("n-vis"),$applozic("#km-contact-search-input-box").removeClass("vis").addClass("n-vis"),$applozic("#km-faq").removeClass("n-vis").addClass("vis"),$applozic("#mck-msg-new").attr("disabled",!1),void(MCK_EVENT_HISTORY.length=0)})},hideFaq:function(){$applozic("#km-contact-search-input-box").removeClass("vis").addClass("n-vis"),$applozic(".km-faqdiv").removeClass("vis").addClass("n-vis"),$applozic("#mck-msg-new").attr("disabled",!1)},showChat:function(){$applozic(".faq-common").removeClass("vis").addClass("n-vis"),$applozic(".mck-conversation").removeClass("n-vis").addClass("vis"),$applozic("#km-faq").removeClass("n-vis").addClass("vis"),$applozic("#mck-msg-new").attr("disabled",!1),0===$applozic("#mck-message-cell .mck-message-inner div[name='message']").length&&1==isFirstLaunch?($applozic("#mck-conversation-back-btn").addClass("km-visibility-hidden"),isFirstLaunch=!1):$applozic("#mck-conversation-back-btn").removeClass("km-visibility-hidden"),$applozic("#mck-tab-conversation").hasClass("vis")},showHeader:function(){$applozic("#mck-tab-individual").removeClass("n-vis").addClass("vis"),$applozic("#mck-tab-conversation").removeClass("vis").addClass("n-vis"),$applozic("#mck-msg-new").attr("disabled",!1)},sendFaqQueryAsMsg:function(e){var t=$applozic("#km-faq-search-input").val();if(""!==t){var a={groupId:e,type:5,contentType:0,message:'Hi, I have a query regarding \n"'+t+'"\n\n Can you help me out?'};$applozic.fn.applozic("sendGroupMessage",a)}},activateTypingField:function(){$applozic("#mck-text-box").focus()}},Kommunicate.postPluginInitialization=function(e,t){$applozic.fn.applozic("subscribeToEvents",{onMessageReceived:function(e){var t=e&&e.message,a=t.metadata&&"HIDDEN"!=t.metadata.category&&"true"!=t.metadata.hide;a&&t.metadata&&t.metadata.skipBot;t.metadata&&!a||KommunicateUI.hideAwayMessage()}}),KommunicateKB.init(Kommunicate.getBaseUrl());var a=KommunicateUtils.getDataFromKmSession("HELPDOCS_KEY");null==a||""==a?Kommunicate.client.getThirdPartySettings({appId:t.appId,type:1},function(e,s){if(e)console.log("err : ",e);else if(s&&"SUCCESS"==s.code){var o=s.message.find(function(e){return e.type==KommunicateConstants.THIRD_PARTY_APPLICATION.HELPDOCS});o?(a=o.accessKey,KommunicateUtils.storeDataIntoKmSession("HELPDOCS_KEY",o.accessKey)):KommunicateUtils.storeDataIntoKmSession("HELPDOCS_KEY","null"),Kommunicate.helpdocsInitialization(t,a)}}):Kommunicate.helpdocsInitialization(t,a)},Kommunicate.helpdocsInitialization=function(e,t){"null"==t&&(t=null),KommunicateKB.getArticles({data:{appId:e.appId,query:"",helpdocsAccessKey:t},success:function(a){a.data&&a.data.length>0&&$applozic(".km-kb-container").hasClass("n-vis")&&$applozic(".km-kb-container").removeClass("n-vis").addClass("vis"),$applozic.each(a.data,function(e,t){$applozic("#km-faqdiv").append('<li class="km-faq-list" data-source="'+t.source+'" data-articleId="'+t.articleId+'"><a class="km-faqdisplay"> <div><div class="km-faqimage"></div></div> <div class="km-faqanchor">'+t.title+"</div></a></li>")}),KommunicateUI.faqEvents(e,t)},error:function(){}})};